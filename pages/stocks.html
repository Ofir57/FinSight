<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="../img/logo.png">
    <meta name="theme-color" content="#8b5cf6">
    <link rel="manifest" href="../manifest.json">
    <link rel="icon" type="image/png" href="../img/logo.png">
    <title>×ª×™×§ ×× ×™×•×ª - FinSight</title>
    <link rel="stylesheet" href="../css/app.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        .nav-link.active { background: var(--color-stocks) !important; }
        .page-header h1 { color: var(--color-stocks); }
        .btn-primary { background: var(--color-stocks); }
        .btn-primary:hover { background: #7c3aed; }
        .stock-symbol {
            font-weight: bold;
            font-family: monospace;
            font-size: 1.1rem;
        }
        .profit { color: var(--color-positive); }
        .loss { color: var(--color-negative); }
        .stock-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .metric-card {
            background: var(--color-bg-card);
            border: 1px solid var(--color-border);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
        }
        .metric-card .label {
            color: var(--color-text-secondary);
            font-size: 0.85rem;
            margin-bottom: 5px;
        }
        .metric-card .value {
            font-size: 1.3rem;
            font-weight: bold;
        }

        /* MA150 Chart Styles */
        .ma150-chart-info {
            padding: 15px 20px;
            background: var(--color-bg-hover);
            border-radius: 8px;
            margin: 0 20px 15px;
        }
        .ma150-metrics {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: space-around;
        }
        .ma150-metric {
            text-align: center;
        }
        .ma150-metric .label {
            display: block;
            font-size: 0.8rem;
            color: var(--color-text-secondary);
            margin-bottom: 4px;
        }
        .ma150-metric .value {
            font-size: 1.1rem;
            font-weight: 600;
        }
        .ma150-metric .value.above { color: var(--color-positive); }
        .ma150-metric .value.below { color: var(--color-negative); }

        /* Sticky table headers */
        .table-container {
            max-height: 600px;
            overflow-y: auto;
        }
        .table-container table thead {
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .table-container table thead th {
            background: var(--color-bg-card);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Static columns (first 5) - purchase data */
        .col-static {
            background: rgba(139, 92, 246, 0.08) !important;
        }
        /* Dynamic columns - current data */
        .col-dynamic {
            background: rgba(16, 185, 129, 0.08) !important;
        }
        /* Header colors */
        thead .col-static {
            background: rgba(139, 92, 246, 0.2) !important;
        }
        thead .col-dynamic {
            background: rgba(16, 185, 129, 0.2) !important;
        }
        /* Collapsible sidebar */
        .sidebar-toggle {
            position: fixed;
            top: 15px;
            right: 270px;
            z-index: 101;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: 2px solid var(--color-border);
            background: var(--color-bg-card);
            color: var(--color-text);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        body.ltr .sidebar-toggle {
            right: auto;
            left: 270px;
        }
        .sidebar-toggle:hover {
            background: var(--color-stocks);
            color: #fff;
            transform: scale(1.1);
        }
        .sidebar-toggle .toggle-icon {
            transition: transform 0.3s ease;
        }
        /* Collapsed state */
        body.sidebar-collapsed .sidebar {
            transform: translateX(100%);
        }
        body.ltr.sidebar-collapsed .sidebar {
            transform: translateX(-100%);
        }
        body.sidebar-collapsed .main-content {
            margin-right: 0;
        }
        body.ltr.sidebar-collapsed .main-content {
            margin-left: 0;
        }
        body.sidebar-collapsed .sidebar-toggle {
            right: 10px;
        }
        body.ltr.sidebar-collapsed .sidebar-toggle {
            right: auto;
            left: 10px;
        }
        body.sidebar-collapsed .sidebar-toggle .toggle-icon {
            transform: rotate(180deg);
        }
    </style>
</head>
<body>
    <!-- Sidebar Toggle Button -->
    <button class="sidebar-toggle" onclick="toggleSidebar()" title="×¤×ª×—/×¡×’×•×¨ ×ª×¤×¨×™×˜" data-i18n-title="stocks.toggleMenu">
        <span class="toggle-icon">ğŸ’°</span>
    </button>

    <div class="app-container">
        <!-- Sidebar Navigation -->
        <aside class="sidebar" id="mainSidebar">
            <div class="sidebar-header">
                <div class="brand">
                    <img src="../img/logo.png" class="brand-icon" alt="FinSight">
                    <span class="brand-name">Fin<span class="brand-highlight">Sight</span></span>
                </div>
            </div>

            <nav>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a href="../index.html" class="nav-link" data-category="dashboard">
                            <span class="icon">ğŸ </span>
                            <span data-i18n="nav.dashboard">×“××©×‘×•×¨×“</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="bank.html" class="nav-link" data-category="bank">
                            <span class="icon">ğŸ¦</span>
                            <span data-i18n="nav.bankAccounts">×—×©×‘×•× ×•×ª ×‘× ×§</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="credit.html" class="nav-link" data-category="credit">
                            <span class="icon">ğŸ’³</span>
                            <span data-i18n="nav.creditCards">×›×¨×˜×™×¡×™ ××©×¨××™</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="stocks.html" class="nav-link active" data-category="stocks">
                            <span class="icon">ğŸ“ˆ</span>
                            <span data-i18n="nav.stocks">×× ×™×•×ª</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <span class="nav-link" style="cursor: default;">
                            <span class="icon">ğŸ“Š</span>
                            <span data-i18n="nav.financialProducts">××•×¦×¨×™× ×¤×™× × ×¡×™×™×</span>
                        </span>
                        <ul class="nav-submenu">
                            <li class="nav-item"><a href="market-products.html" class="nav-link" data-category="market-products"><span data-i18n="nav.marketProducts">ğŸª ××•×¦×¨×™× ×‘×©×•×§</span></a></li>
                            <li class="nav-item"><a href="my-funds.html" class="nav-link" data-category="my-products"><span data-i18n="nav.myProducts">ğŸ’ ×”××•×¦×¨×™× ×©×œ×™</span></a></li>
                        </ul>
                    </li>
                    <li class="nav-item">
                        <a href="assets.html" class="nav-link" data-category="assets">
                            <span class="icon">ğŸ </span>
                            <span data-i18n="nav.assets">× ×›×¡×™×</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="loans.html" class="nav-link" data-category="loans">
                            <span class="icon">ğŸ¦</span>
                            <span data-i18n="nav.loans">×”×œ×•×•××•×ª</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="goals.html" class="nav-link" data-category="goals">
                            <span class="icon">ğŸ¯</span>
                            <span data-i18n="nav.goals">×™×¢×“×™ ×—×™×¡×›×•×Ÿ</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="pension-calc.html" class="nav-link" data-category="pension-calc">
                            <span class="icon">ğŸ§®</span>
                            <span data-i18n="nav.pensionCalc">××—×©×‘×•×Ÿ ×¤× ×¡×™×”</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="reports.html" class="nav-link" data-category="reports">
                            <span class="icon">ğŸ“‹</span>
                            <span data-i18n="nav.reports">×“×•×—×•×ª</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="profile.html" class="nav-link">
                            <span class="icon">ğŸ‘¤</span>
                            <span data-i18n="nav.profile">×¤×¨×•×¤×™×œ ×¤×™× × ×¡×™</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="settings.html" class="nav-link" data-category="settings">
                            <span class="icon">âš™ï¸</span>
                            <span data-i18n="nav.settings">×”×’×“×¨×•×ª</span>
                        </a>
                    </li>
                </ul>
            </nav>

            <div class="sidebar-footer">
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="logo-hero">
                <img src="../img/logo.png" alt="FinSight" class="logo-hero-img">
            </div>
            <header class="page-header">
                <h1>
                    <span>ğŸ“ˆ</span>
                    <span data-i18n="stocks.title">×ª×™×§ ×× ×™×•×ª</span>
                </h1>
            </header>

            <!-- Active Alerts Banner -->
            <div id="stockAlertsBar" class="alerts-bar" style="display: none;"></div>

            <!-- Portfolio Summary -->
            <div class="stock-metrics">
                <div class="metric-card">
                    <div class="label" data-i18n="stocks.totalValue">×©×•×•×™ ×›×•×œ×œ</div>
                    <div class="value" id="totalValue" style="color: var(--color-stocks);">â‚ª0</div>
                </div>
                <div class="metric-card">
                    <div class="label" data-i18n="stocks.cost">×¢×œ×•×ª</div>
                    <div class="value" id="totalCost">â‚ª0</div>
                </div>
                <div class="metric-card">
                    <div class="label" data-i18n="stocks.profitLoss">×¨×•×•×—/×”×¤×¡×“</div>
                    <div class="value" id="totalProfitLoss">â‚ª0</div>
                </div>
                <div class="metric-card">
                    <div class="label" data-i18n="stocks.returnPct">×ª×©×•××”</div>
                    <div class="value" id="totalReturn">0%</div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="openStockModal()">
                    <span>â•</span>
                    <span data-i18n="stocks.addStock">×”×•×¡×£ ×× ×™×”</span>
                </button>
                <button class="btn btn-secondary" onclick="refreshAllPrices()" id="refreshBtn">
                    <span>ğŸ”„</span>
                    <span data-i18n="stocks.refreshPrices">×¢×“×›×Ÿ ××—×™×¨×™×</span>
                </button>
                <button class="btn btn-secondary" onclick="importCSV()">
                    <span>ğŸ“¥</span>
                    <span data-i18n="stocks.importCSV">×™×™×‘×•× CSV</span>
                </button>
                <button class="btn btn-secondary" onclick="importBrokerXLS()">
                    <span>ğŸ“‚</span>
                    <span data-i18n="stocks.importBroker">×™×™×‘×•× ××‘×¨×•×§×¨ (XLS)</span>
                </button>
                <button class="btn btn-secondary" onclick="exportHoldingsToExcel()">
                    <span>ğŸ“Š</span>
                    <span data-i18n="stocks.exportExcel">×™×™×¦×•× Excel</span>
                </button>
                <button class="btn btn-secondary" onclick="ImageImport.openImagePicker('stocks')">
                    <span>ğŸ“·</span>
                    <span data-i18n="stocks.importImage">×™×™×‘×•× ××ª××•× ×”</span>
                </button>
                <input type="file" id="brokerFileInput" accept=".xls,.xlsx,.xml" style="display: none;" onchange="handleBrokerFile(event)">
                <label class="auto-refresh-toggle" style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                    <input type="checkbox" id="autoRefreshToggle" onchange="toggleAutoRefresh()" checked>
                    <span style="font-size: 0.9rem; color: var(--color-text-secondary);" data-i18n="stocks.autoRefresh">×¨×¢× ×•×Ÿ ××•×˜×•××˜×™</span>
                </label>
            </div>

            <!-- Holdings Table -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <span class="icon">ğŸ“‹</span>
                        <span data-i18n="stocks.holdings">××—×–×§×•×ª</span>
                    </h2>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <label style="font-size: 0.85rem; color: var(--color-text-secondary);" data-i18n="stocks.sortBy">××™×•×Ÿ:</label>
                            <select id="sortBy" onchange="loadStocks()" style="padding: 5px 10px; border-radius: 5px; background: var(--color-card-bg); color: var(--color-text); border: 1px solid var(--color-border);">
                                <option value="symbol" data-i18n="stocks.sortSymbol">×¡×™××•×œ</option>
                                <option value="name" data-i18n="stocks.sortName">×©×</option>
                                <option value="valueILS" selected data-i18n="stocks.sortValueILS">×©×•×•×™ â‚ª</option>
                                <option value="portfolioPercent" data-i18n="stocks.sortPortfolio">% ××”×ª×™×§</option>
                                <option value="profitILS" data-i18n="stocks.sortProfitILS">×¨×•×•×— â‚ª</option>
                                <option value="profitPercent" data-i18n="stocks.sortProfitPct">×¨×•×•×— %</option>
                                <option value="dailyChange" data-i18n="stocks.sortDailyChange">×©×™× ×•×™ ×™×•××™</option>
                                <option value="quantity" data-i18n="stocks.sortQuantity">×›××•×ª</option>
                            </select>
                            <button onclick="toggleSortDirection()" id="sortDirBtn" class="btn btn-sm btn-secondary" style="padding: 5px 8px;">â¬‡ï¸</button>
                        </div>
                        <span id="lastUpdateTime" style="color: var(--color-text-secondary); font-size: 0.85rem;"></span>
                    </div>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th class="col-static" data-i18n="stocks.symbol" style="cursor: pointer;" onclick="setSortBy('symbol')">×¡×™××•×œ</th>
                                <th class="col-static" data-i18n="stocks.companyName" style="cursor: pointer;" onclick="setSortBy('name')">×©×</th>
                                <th class="col-static" data-i18n="stocks.quantity" style="cursor: pointer;" onclick="setSortBy('quantity')">×›××•×ª</th>
                                <th class="col-static" data-i18n="stocks.purchasePrice" style="cursor: pointer;" onclick="setSortBy('avgPrice')">××—×™×¨ ×¨×›×™×©×”</th>
                                <th class="col-static" data-i18n="stocks.purchaseCost">×¢×œ×•×ª ×¨×›×™×©×” â‚ª</th>
                                <th class="col-dynamic" data-i18n="stocks.currentPrice" style="cursor: pointer;" onclick="setSortBy('currentPrice')">××—×™×¨ × ×•×›×—×™</th>
                                <th class="col-dynamic" data-i18n="stocks.dailyChange" style="cursor: pointer;" onclick="setSortBy('dailyChange')">×©×™× ×•×™ ×™×•××™</th>
                                <th class="col-dynamic">MA150</th>
                                <th class="col-dynamic" data-i18n="stocks.trend">×˜×¨× ×“</th>
                                <th class="col-dynamic" data-i18n="stocks.currentValueILS" style="cursor: pointer;" onclick="setSortBy('valueILS')">×©×•×•×™ × ×•×›×—×™ â‚ª</th>
                                <th class="col-dynamic" data-i18n="stocks.profitFX">×¨×•×•×— (××˜"×—)</th>
                                <th class="col-dynamic" data-i18n="stocks.profitILS" style="cursor: pointer;" onclick="setSortBy('profitILS')">×¨×•×•×— â‚ª</th>
                                <th class="col-dynamic" data-i18n="stocks.changePct" style="cursor: pointer;" onclick="setSortBy('profitPercent')">×©×™× ×•×™ %</th>
                                <th class="col-dynamic" data-i18n="stocks.portfolioPct" style="cursor: pointer;" onclick="setSortBy('portfolioPercent')">% ××”×ª×™×§</th>
                                <th class="col-dynamic" data-i18n="common.actions">×¤×¢×•×œ×•×ª</th>
                            </tr>
                        </thead>
                        <tbody id="holdingsTable">
                            <!-- Will be populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Watchlist Section -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <span class="icon">ğŸ“‹</span>
                        <span data-i18n="stocks.watchlist">×¨×©×™××ª ××¢×§×‘</span>
                    </h2>
                    <button class="btn btn-sm btn-secondary" onclick="openAddWatchlistModal()">
                        <span>â•</span>
                        <span data-i18n="stocks.addToWatchlist">×”×•×¡×£ ×× ×™×” ×œ××¢×§×‘</span>
                    </button>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th data-i18n="stocks.symbol">×¡×™××•×œ</th>
                                <th data-i18n="stocks.companyName">×©×</th>
                                <th data-i18n="stocks.market">×©×•×§</th>
                                <th data-i18n="stocks.currentPrice">××—×™×¨ × ×•×›×—×™</th>
                                <th data-i18n="stocks.dailyChange">×©×™× ×•×™</th>
                                <th>MA150</th>
                                <th data-i18n="stocks.position">××™×§×•×</th>
                                <th data-i18n="stocks.alerts">×”×ª×¨××•×ª</th>
                                <th data-i18n="common.actions">×¤×¢×•×œ×•×ª</th>
                            </tr>
                        </thead>
                        <tbody id="watchlistTable">
                            <tr><td colspan="9" style="text-align: center; color: var(--color-text-secondary);" data-i18n="stocks.noWatchlistStocks">××™×Ÿ ×× ×™×•×ª ×‘×¨×©×™××ª ×”××¢×§×‘</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Charts -->
            <div class="charts-grid">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <span class="icon">ğŸ“Š</span>
                            <span data-i18n="stocks.portfolioDistribution">×—×œ×•×§×ª ×ª×™×§</span>
                        </h2>
                    </div>
                    <div class="chart-container">
                        <canvas id="portfolioChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Interactive MA150 Chart -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <span class="icon">ğŸ“ˆ</span>
                        <span data-i18n="stocks.priceMA150Chart">×’×¨×£ ××—×™×¨ ×•-MA150</span>
                    </h2>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <select id="ma150ChartSelect" class="form-control" style="width: auto; min-width: 150px;" onchange="updateMA150Chart()">
                            <option value="" data-i18n="stocks.selectStock">×‘×—×¨ ×× ×™×”...</option>
                        </select>
                        <select id="ma150TimeRange" class="form-control" style="width: auto;" onchange="updateMA150Chart()">
                            <option value="3m" data-i18n="stocks.threeMonths">3 ×—×•×“×©×™×</option>
                            <option value="6m" selected data-i18n="stocks.sixMonths">6 ×—×•×“×©×™×</option>
                            <option value="1y" data-i18n="stocks.oneYear">×©× ×”</option>
                        </select>
                    </div>
                </div>
                <div class="ma150-chart-info" id="ma150ChartInfo" style="display: none;">
                    <div class="ma150-metrics">
                        <div class="ma150-metric">
                            <span class="label" data-i18n="stocks.currentPrice">××—×™×¨ × ×•×›×—×™</span>
                            <span class="value" id="chartCurrentPrice">-</span>
                        </div>
                        <div class="ma150-metric">
                            <span class="label">MA150</span>
                            <span class="value" id="chartMA150">-</span>
                        </div>
                        <div class="ma150-metric">
                            <span class="label" data-i18n="stocks.position">××™×§×•×</span>
                            <span class="value" id="chartPosition">-</span>
                        </div>
                        <div class="ma150-metric">
                            <span class="label" data-i18n="stocks.thirtyDayChange">×©×™× ×•×™ 30 ×™×•×</span>
                            <span class="value" id="chart30DayChange">-</span>
                        </div>
                    </div>
                </div>
                <div class="chart-container" style="height: 350px;">
                    <canvas id="ma150Chart"></canvas>
                </div>
                <div id="ma150ChartEmpty" style="text-align: center; padding: 60px 20px; color: var(--color-text-secondary);">
                    <span style="font-size: 3rem;">ğŸ“Š</span>
                    <p style="margin-top: 15px;" data-i18n="stocks.selectStockForChart">×‘×—×¨ ×× ×™×” ××”×¨×©×™××” ×œ×¦×¤×™×™×” ×‘×’×¨×£ ×”××—×™×¨ ×•×”-MA150</p>
                </div>
            </div>

            <!-- TradingView Chart -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <span class="icon">ğŸ“º</span>
                        <span data-i18n="stocks.advancedChart">×’×¨×£ ××ª×§×“× - TradingView</span>
                    </h2>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <select id="tvChartSelect" class="form-control" style="width: auto; min-width: 180px;" onchange="updateTVChart()">
                            <option value="NASDAQ:AAPL">AAPL - Apple</option>
                            <option value="NASDAQ:MSFT">MSFT - Microsoft</option>
                            <option value="NASDAQ:GOOGL">GOOGL - Alphabet</option>
                            <option value="NASDAQ:AMZN">AMZN - Amazon</option>
                            <option value="NASDAQ:NVDA">NVDA - NVIDIA</option>
                            <option value="NASDAQ:TSLA">TSLA - Tesla</option>
                            <option value="NASDAQ:META">META - Meta</option>
                            <option value="NYSE:BRK.B">BRK.B - Berkshire</option>
                            <option value="TLV:TA125.TA">TA-125 - ×ª×´× 125</option>
                            <option value="TLV:TA35.TA">TA-35 - ×ª×´× 35</option>
                        </select>
                        <input type="text" id="tvCustomSymbol" class="form-control" placeholder="×”×§×œ×“ ×¡×™××•×œ..." data-i18n-placeholder="stocks.typeSymbol" style="width: 150px;" onkeydown="if(event.key==='Enter'){addCustomTVSymbol(); event.preventDefault();}">
                        <button class="btn btn-sm btn-secondary" onclick="addCustomTVSymbol()" title="×”×•×¡×£ ×× ×™×”" data-i18n-title="stocks.addStockTooltip">â•</button>
                        <button class="btn btn-sm btn-secondary" onclick="removeSelectedTVSymbol()" title="×”×¡×¨ ×× ×™×” ×©× ×‘×—×¨×”" data-i18n-title="stocks.removeStock" style="color: #ff4757;">ğŸ—‘ï¸</button>
                    </div>
                </div>
                <div id="tvChartContainer" style="height: 500px; padding: 0 20px 20px;">
                    <!-- TradingView Widget BEGIN -->
                    <div class="tradingview-widget-container" id="tvWidget" style="height:100%;width:100%">
                        <div class="tradingview-widget-container__widget" style="height:calc(100% - 32px);width:100%"></div>
                        <div class="tradingview-widget-copyright"><a href="https://www.tradingview.com/" rel="noopener nofollow" target="_blank"><span class="blue-text">Charts</span></a><span class="trademark"> by TradingView</span></div>
                    </div>
                    <!-- TradingView Widget END -->
                </div>
            </div>

            <!-- Transaction History -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <span class="icon">ğŸ“œ</span>
                        <span data-i18n="stocks.transactions">×”×™×¡×˜×•×¨×™×™×ª ×¤×¢×•×œ×•×ª</span>
                    </h2>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th data-i18n="common.date">×ª××¨×™×š</th>
                                <th data-i18n="common.type">×¡×•×’</th>
                                <th data-i18n="stocks.symbol">×¡×™××•×œ</th>
                                <th data-i18n="stocks.quantity">×›××•×ª</th>
                                <th data-i18n="stocks.price">××—×™×¨</th>
                                <th data-i18n="common.total">×¡×”×´×›</th>
                            </tr>
                        </thead>
                        <tbody id="transactionsTable">
                            <!-- Will be populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Benchmark Comparison Section -->
            <div class="card" id="benchmarkSection">
                <div class="card-header">
                    <h2 class="card-title">
                        <span class="icon">ğŸ“Š</span>
                        <span data-i18n="benchmark.title">×‘×™×¦×•×¢×™× ××•×œ ××“×“</span>
                    </h2>
                </div>
                <div style="padding: 15px 20px;">
                    <!-- Compare Target Selector -->
                    <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px; flex-wrap: wrap;">
                        <span style="font-size: 0.85rem; color: var(--color-text-secondary); font-weight: 500;" data-i18n="benchmark.compareTarget">×”×©×•×•×”:</span>
                        <select id="benchmarkTargetSelect" onchange="onBenchmarkTargetChange()" style="padding: 6px 10px; border-radius: 8px; border: 1px solid var(--color-border); background: var(--color-bg-card); color: var(--color-text); font-size: 0.85rem; min-width: 140px;">
                            <option value="portfolio" data-i18n="benchmark.wholePortfolio">×›×œ ×”×ª×™×§</option>
                        </select>
                        <input type="text" id="customTickerInput" placeholder="AAPL, TSLA..." style="display: none; padding: 6px 10px; border-radius: 8px; border: 1px solid var(--color-border); background: var(--color-bg-card); color: var(--color-text); font-size: 0.85rem; width: 120px;" onkeydown="if(event.key==='Enter')loadBenchmarkChart()">
                    </div>
                    <!-- Period Selector -->
                    <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 15px;">
                        <button class="btn btn-sm btn-secondary benchmark-period" data-range="1mo" onclick="setBenchmarkPeriod('1mo')" data-i18n="benchmark.period1M">×—×•×“×©</button>
                        <button class="btn btn-sm btn-secondary benchmark-period" data-range="3mo" onclick="setBenchmarkPeriod('3mo')" data-i18n="benchmark.period3M">3 ×—×•×“×©×™×</button>
                        <button class="btn btn-sm btn-secondary benchmark-period active" data-range="6mo" onclick="setBenchmarkPeriod('6mo')" style="background: var(--color-stocks);" data-i18n="benchmark.period6M">6 ×—×•×“×©×™×</button>
                        <button class="btn btn-sm btn-secondary benchmark-period" data-range="1y" onclick="setBenchmarkPeriod('1y')" data-i18n="benchmark.period1Y">×©× ×”</button>
                        <button class="btn btn-sm btn-secondary benchmark-period" data-range="5y" onclick="setBenchmarkPeriod('5y')" data-i18n="benchmark.periodAll">×”×›×œ</button>
                    </div>
                    <!-- Benchmark Selector -->
                    <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 15px;">
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; font-size: 0.9rem;">
                            <input type="checkbox" class="benchmark-check" value="^GSPC" checked onchange="loadBenchmarkChart()"> S&P 500
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; font-size: 0.9rem;">
                            <input type="checkbox" class="benchmark-check" value="^TA125.TA" onchange="loadBenchmarkChart()"> TA-125
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; font-size: 0.9rem;">
                            <input type="checkbox" class="benchmark-check" value="^IXIC" onchange="loadBenchmarkChart()"> NASDAQ
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; font-size: 0.9rem;">
                            <input type="checkbox" class="benchmark-check" value="^TA35.TA" onchange="loadBenchmarkChart()"> TA-35
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; font-size: 0.9rem;">
                            <input type="checkbox" class="benchmark-check" value="URTH" onchange="loadBenchmarkChart()"> MSCI World
                        </label>
                    </div>
                    <!-- Custom Benchmarks Chips -->
                    <div id="customBenchmarkChips" style="display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 10px;"></div>
                    <!-- Add Custom Benchmark -->
                    <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 15px;">
                        <input type="text" id="customBenchmarkInput" placeholder="×—×¤×© ×¡×™××•×œ..." data-i18n-placeholder="benchmark.searchSymbol" style="flex: 1; padding: 6px 10px; border-radius: 8px; border: 1px solid var(--color-border); background: var(--color-bg-card); color: var(--color-text); font-size: 0.85rem; max-width: 200px;" onkeydown="if(event.key==='Enter')addCustomBenchmark()">
                        <button class="btn btn-sm" style="background: var(--color-stocks); white-space: nowrap;" onclick="addCustomBenchmark()">
                            <span data-i18n="benchmark.addIndex">×”×•×¡×£ ×˜×™×§×¨</span>
                        </button>
                    </div>
                </div>
                <!-- Chart -->
                <div class="chart-container" style="height: 350px; padding: 0 20px 10px;">
                    <canvas id="benchmarkChart"></canvas>
                </div>
                <div id="benchmarkLoading" style="display: none; text-align: center; padding: 40px; color: var(--color-text-secondary);">
                    <span data-i18n="benchmark.loading">×˜×•×¢×Ÿ × ×ª×•× ×™ ××“×“×™×...</span>
                </div>
                <!-- Summary Stats -->
                <div id="benchmarkStats" style="padding: 10px 20px 20px; display: none;">
                    <div style="display: flex; flex-wrap: wrap; gap: 15px; justify-content: center;" id="benchmarkStatsGrid">
                    </div>
                </div>
            </div>
        </main>

        <!-- Mobile Menu Toggle -->
        <button class="mobile-menu-toggle">â˜°</button>
    </div>

    <!-- Add Stock Modal -->
    <div class="modal-overlay" id="stockModal">
        <div class="modal">
            <div class="modal-header">
                <h2 data-i18n="stocks.addStock">×”×•×¡×£ ×× ×™×”</h2>
                <button class="modal-close" onclick="closeStockModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="stockForm">
                    <div class="form-group">
                        <label data-i18n="stocks.symbol">×¡×™××•×œ (Symbol)</label>
                        <input type="text" class="form-control" id="stockSymbol" required placeholder="AAPL" style="text-transform: uppercase;">
                    </div>
                    <div class="form-group">
                        <label data-i18n="stocks.companyName">×©× ×”×—×‘×¨×”</label>
                        <input type="text" class="form-control" id="stockName" placeholder="Apple Inc.">
                    </div>
                    <div class="form-group">
                        <label data-i18n="stocks.market">×©×•×§</label>
                        <select class="form-control" id="stockMarket">
                            <option value="US" data-i18n="stocks.marketUS">××¨×”"×‘ (NYSE/NASDAQ)</option>
                            <option value="IL" data-i18n="stocks.marketIL">×™×©×¨××œ (TASE)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label data-i18n="stocks.quantity">×›××•×ª</label>
                        <input type="number" class="form-control" id="stockQuantity" min="0.01" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label data-i18n="stocks.avgPrice">××—×™×¨ ×§× ×™×™×”</label>
                        <input type="number" class="form-control" id="stockPrice" min="0.01" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label data-i18n="stocks.currentPrice">××—×™×¨ × ×•×›×—×™ (××•×¤×¦×™×•× ×œ×™)</label>
                        <input type="number" class="form-control" id="stockCurrentPrice" min="0.01" step="0.01">
                    </div>
                    <div class="form-group">
                        <label data-i18n="bank.currency">××˜×‘×¢</label>
                        <select class="form-control" id="stockCurrency">
                            <option value="ILS">â‚ª ILS</option>
                            <option value="USD" selected>$ USD</option>
                            <option value="EUR">â‚¬ EUR</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeStockModal()" data-i18n="common.cancel">×‘×™×˜×•×œ</button>
                <button class="btn btn-primary" onclick="saveStock()" data-i18n="common.save">×©××•×¨</button>
            </div>
        </div>
    </div>

    <!-- Update Price Modal -->
    <div class="modal-overlay" id="updatePriceModal">
        <div class="modal">
            <div class="modal-header">
                <h2 data-i18n="stocks.updatePrice">×¢×“×›×Ÿ ××—×™×¨</h2>
                <button class="modal-close" onclick="closeUpdatePriceModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="updatePriceForm">
                    <input type="hidden" id="updateSymbol">
                    <div class="form-group">
                        <label data-i18n="stocks.currentPrice">××—×™×¨ × ×•×›×—×™</label>
                        <input type="number" class="form-control" id="newPrice" min="0.01" step="0.01" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeUpdatePriceModal()" data-i18n="common.cancel">×‘×™×˜×•×œ</button>
                <button class="btn btn-primary" onclick="updatePrice()" data-i18n="common.update">×¢×“×›×Ÿ</button>
            </div>
        </div>
    </div>

    <!-- Sell Modal -->
    <div class="modal-overlay" id="sellModal">
        <div class="modal">
            <div class="modal-header">
                <h2 data-i18n="stocks.sell">××›×™×¨×”</h2>
                <button class="modal-close" onclick="closeSellModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="sellForm">
                    <input type="hidden" id="sellSymbol">
                    <p id="sellInfo" style="margin-bottom: 15px; color: var(--color-text-secondary);"></p>
                    <div class="form-group">
                        <label data-i18n="stocks.quantity">×›××•×ª ×œ××›×™×¨×”</label>
                        <input type="number" class="form-control" id="sellQuantity" min="0.01" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label data-i18n="stocks.sellPrice">××—×™×¨ ××›×™×¨×”</label>
                        <input type="number" class="form-control" id="sellPrice" min="0.01" step="0.01" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeSellModal()" data-i18n="common.cancel">×‘×™×˜×•×œ</button>
                <button class="btn btn-danger" onclick="sellStock()" data-i18n="stocks.sell">××›×•×¨</button>
            </div>
        </div>
    </div>

    <!-- Add to Watchlist Modal -->
    <div class="modal-overlay" id="watchlistModal">
        <div class="modal">
            <div class="modal-header">
                <h2 data-i18n="stocks.addToWatchlist">×”×•×¡×£ ×× ×™×” ×œ××¢×§×‘</h2>
                <button class="modal-close" onclick="closeAddWatchlistModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="watchlistForm">
                    <div class="form-group">
                        <label data-i18n="stocks.searchStock">×—×¤×© ×× ×™×”</label>
                        <input type="text" class="form-control" id="watchlistSearch" placeholder="×”×§×œ×“ ×¡×™××•×œ ××• ×©×..." data-i18n-placeholder="stocks.searchPlaceholder" oninput="searchStocks()">
                        <div id="searchResults" class="search-results"></div>
                    </div>
                    <div class="form-group">
                        <label data-i18n="stocks.symbol">×¡×™××•×œ</label>
                        <input type="text" class="form-control" id="watchlistSymbol" required placeholder="AAPL" style="text-transform: uppercase;">
                    </div>
                    <div class="form-group">
                        <label data-i18n="stocks.companyName">×©× ×”×—×‘×¨×”</label>
                        <input type="text" class="form-control" id="watchlistName" placeholder="Apple Inc.">
                    </div>
                    <div class="form-group">
                        <label data-i18n="stocks.market">×©×•×§</label>
                        <select class="form-control" id="watchlistMarket">
                            <option value="US" data-i18n="stocks.marketUS">××¨×”"×‘ (NYSE/NASDAQ)</option>
                            <option value="IL" data-i18n="stocks.marketIL">×™×©×¨××œ (TASE)</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeAddWatchlistModal()" data-i18n="common.cancel">×‘×™×˜×•×œ</button>
                <button class="btn btn-primary" onclick="addToWatchlist()" data-i18n="stocks.addToWatchlist">×”×•×¡×£ ×œ××¢×§×‘</button>
            </div>
        </div>
    </div>

    <!-- Add Alert Modal -->
    <div class="modal-overlay" id="alertModal">
        <div class="modal">
            <div class="modal-header">
                <h2 data-i18n="stocks.addAlert">×”×•×¡×£ ×”×ª×¨××”</h2>
                <button class="modal-close" onclick="closeAlertModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="alertForm">
                    <input type="hidden" id="alertSymbol">
                    <p id="alertInfo" style="margin-bottom: 15px; color: var(--color-text-secondary);"></p>
                    <div class="form-group">
                        <label data-i18n="stocks.alertType">×¡×•×’ ×”×ª×¨××”</label>
                        <select class="form-control" id="alertType" onchange="updateAlertValueLabel()">
                            <option value="price_above" data-i18n="stocks.priceAbove">××—×™×¨ ××¢×œ</option>
                            <option value="price_below" data-i18n="stocks.priceBelow">××—×™×¨ ××ª×—×ª</option>
                            <option value="percent_change" data-i18n="stocks.percentChange">×©×™× ×•×™ ××—×•×–×™</option>
                            <option value="ma150_cross_above" data-i18n="stocks.ma150CrossAbove">×—×¦×™×™×ª MA150 ××œ××¢×œ×”</option>
                            <option value="ma150_cross_below" data-i18n="stocks.ma150CrossBelow">×—×¦×™×™×ª MA150 ××œ××˜×”</option>
                        </select>
                    </div>
                    <div class="form-group" id="alertValueGroup">
                        <label id="alertValueLabel" data-i18n="stocks.targetPrice">××—×™×¨ ×™×¢×“</label>
                        <input type="number" class="form-control" id="alertValue" step="0.01" placeholder="0">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeAlertModal()" data-i18n="common.cancel">×‘×™×˜×•×œ</button>
                <button class="btn btn-primary" onclick="saveAlert()" data-i18n="stocks.addAlert">×”×•×¡×£ ×”×ª×¨××”</button>
            </div>
        </div>
    </div>

    <!-- View Alerts Modal -->
    <div class="modal-overlay" id="viewAlertsModal">
        <div class="modal">
            <div class="modal-header">
                <h2 id="viewAlertsTitle" data-i18n="stocks.viewAlerts">×”×ª×¨××•×ª</h2>
                <button class="modal-close" onclick="closeViewAlertsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="alertsList"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeViewAlertsModal()" data-i18n="stocks.closeAlerts">×¡×’×•×¨</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="../js/storage.js"></script>
    <script src="../js/pin-lock.js"></script>
    <script src="../js/i18n.js"></script>
    <script src="../js/charts.js"></script>
    <script src="../js/csv-import.js"></script>
    <script src="../js/image-import.js"></script>
    <script src="../js/stock-api.js"></script>
    <script src="../js/stock-alerts.js"></script>
    <script src="../js/notifications.js"></script>
    <script src="../js/currency.js"></script>
    <script src="../js/app.js"></script>
    <script src="../js/firebase-config.js"></script>
    <script src="../js/crypto.js"></script>
    <script src="../js/auth.js"></script>
    <script>
        // Sidebar toggle
        function toggleSidebar() {
            document.body.classList.toggle('sidebar-collapsed');
            const isCollapsed = document.body.classList.contains('sidebar-collapsed');
            localStorage.setItem('stocks_sidebar_collapsed', isCollapsed ? '1' : '0');
        }
        // Restore sidebar state
        if (localStorage.getItem('stocks_sidebar_collapsed') === '1') {
            document.body.classList.add('sidebar-collapsed');
        }

        // State
        let refreshInterval = null;
        let priceCache = {};
        let isRefreshing = false;
        let searchTimeout = null;
        let sortDirection = 'desc'; // 'asc' or 'desc'

        function toggleSortDirection() {
            sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            document.getElementById('sortDirBtn').textContent = sortDirection === 'asc' ? 'â¬†ï¸' : 'â¬‡ï¸';
            loadStocks();
        }

        function setSortBy(field) {
            const select = document.getElementById('sortBy');
            if (select.value === field) {
                toggleSortDirection();
            } else {
                select.value = field;
                loadStocks();
            }
        }

        // Currency rates cache
        let currencyRates = { USD: 3.65, EUR: 3.95, GBP: 4.60, ILS: 1 };

        document.addEventListener('DOMContentLoaded', async () => {
            App.currentPage = 'stocks';

            // Fetch currency rates first
            try {
                currencyRates = await CurrencyRates.getRates();
            } catch (e) {
                console.error('Failed to get currency rates:', e);
            }

            loadStocks();
            loadWatchlist();
            checkTriggeredAlerts();

            // Start auto-refresh if enabled
            const settings = StockAlerts.getSettings();
            document.getElementById('autoRefreshToggle').checked = settings.autoRefresh;
            if (settings.autoRefresh) {
                startAutoRefresh();
            }

            // Initial price fetch
            refreshAllPrices();
        });

        function loadStocks() {
            const data = Storage.getStocks();
            const holdingsTable = document.getElementById('holdingsTable');
            const transactionsTable = document.getElementById('transactionsTable');

            // Calculate totals
            let totalValueILS = 0;
            let totalCostILS = 0;
            let totalProfitILS = 0;
            let totalProfitCurrency = { USD: 0, GBP: 0, EUR: 0, ILS: 0 };

            if (data.holdings.length === 0) {
                holdingsTable.innerHTML = `<tr><td colspan="15" style="text-align: center; color: var(--color-text-secondary);">${I18n.t('stocks.noStocks')}</td></tr>`;
            } else {
                // Get sort criteria
                const sortBy = document.getElementById('sortBy')?.value || 'valueILS';

                // Prepare holdings with calculated values
                const holdingsWithCalc = data.holdings.map(h => {
                    const cached = priceCache[h.symbol] || {};
                    const currency = h.currency || 'USD';
                    const rate = currencyRates[currency] || 1;

                    // Use cached price if available, otherwise use imported currentPrice
                    const currentPrice = cached.currentPrice || h.currentPrice || h.avgPrice;

                    // Calculate or use imported ILS values
                    let valueILS, profitILS, profitInCurrency;

                    if (h.valueILS && h.valueILS > 0) {
                        // Use imported values from broker
                        valueILS = h.valueILS;
                        profitILS = h.profitILS || 0;
                        // Calculate profit in currency from ILS
                        profitInCurrency = profitILS / rate;
                    } else {
                        // Calculate for manual stocks
                        const valueInCurrency = currentPrice * h.quantity;
                        valueILS = valueInCurrency * rate;
                        profitInCurrency = (currentPrice - h.avgPrice) * h.quantity;
                        profitILS = profitInCurrency * rate;
                    }

                    const costILS = valueILS - profitILS;
                    const profitPercent = costILS > 0 ? (profitILS / costILS) * 100 : 0;

                    return { ...h, currentPrice, valueILS, profitILS, profitInCurrency, costILS, profitPercent, cached, currency, rate };
                });

                // Calculate portfolio total for percentages
                const portfolioTotalILS = holdingsWithCalc.reduce((sum, h) => sum + h.valueILS, 0);

                // Add portfolio percentage
                holdingsWithCalc.forEach(h => {
                    h.portfolioPercent = portfolioTotalILS > 0 ? (h.valueILS / portfolioTotalILS) * 100 : 0;
                });

                // Sort holdings
                holdingsWithCalc.sort((a, b) => {
                    let aVal, bVal;
                    switch (sortBy) {
                        case 'symbol': aVal = a.symbol; bVal = b.symbol; break;
                        case 'name': aVal = a.name || ''; bVal = b.name || ''; break;
                        case 'quantity': aVal = a.quantity; bVal = b.quantity; break;
                        case 'avgPrice': aVal = a.avgPrice; bVal = b.avgPrice; break;
                        case 'currentPrice': aVal = a.currentPrice; bVal = b.currentPrice; break;
                        case 'dailyChange': aVal = (a.cached.priceChangePercent || 0); bVal = (b.cached.priceChangePercent || 0); break;
                        case 'valueILS': aVal = a.valueILS; bVal = b.valueILS; break;
                        case 'profitILS': aVal = a.profitILS; bVal = b.profitILS; break;
                        case 'profitPercent': aVal = a.profitPercent; bVal = b.profitPercent; break;
                        case 'portfolioPercent': aVal = a.portfolioPercent; bVal = b.portfolioPercent; break;
                        default: aVal = a.valueILS; bVal = b.valueILS;
                    }
                    if (typeof aVal === 'string') {
                        return sortDirection === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                    }
                    return sortDirection === 'asc' ? aVal - bVal : bVal - aVal;
                });

                // Build rows and calculate totals
                const rows = holdingsWithCalc.map(h => {
                    const { currentPrice, valueILS, profitILS, profitInCurrency, costILS, profitPercent, portfolioPercent, cached, currency } = h;
                    const currencySymbol = { USD: '$', GBP: 'Â£', ILS: 'â‚ª', EUR: 'â‚¬' }[currency] || '$';

                    const isProfit = profitILS >= 0;
                    const isProfitCurrency = profitInCurrency >= 0;

                    // Accumulate totals
                    totalValueILS += valueILS;
                    totalCostILS += costILS;
                    totalProfitILS += profitILS;
                    if (currency !== 'ILS') {
                        totalProfitCurrency[currency] = (totalProfitCurrency[currency] || 0) + profitInCurrency;
                    }

                    // Daily change from cache
                    const dailyChangePercent = cached.priceChangePercent;
                    let dailyChangeDisplay = '<span style="color: var(--color-text-secondary);">-</span>';
                    if (dailyChangePercent !== null && dailyChangePercent !== undefined) {
                        const isDailyPositive = dailyChangePercent >= 0;
                        dailyChangeDisplay = `<span class="${isDailyPositive ? 'profit' : 'loss'}">${isDailyPositive ? '+' : ''}${dailyChangePercent.toFixed(2)}%</span>`;
                    }

                    // MA150 from cache - show distance in %
                    const ma150 = cached.ma150;
                    const ma150PositionPercent = cached.ma150PositionPercent;
                    let ma150Display = '<span style="color: var(--color-text-secondary);">-</span>';
                    if (ma150 !== null && ma150 !== undefined) {
                        const isAbove = currentPrice > ma150;
                        const positionIcon = isAbove ? 'ğŸŸ¢' : 'ğŸ”´';
                        const distPercent = ma150PositionPercent !== null && ma150PositionPercent !== undefined ? ma150PositionPercent.toFixed(2) : '0';
                        ma150Display = `<span class="${isAbove ? 'profit' : 'loss'}">${positionIcon} ${isAbove ? '+' : ''}${distPercent}%</span>`;
                    }

                    // Trend indicator based on MA150 position and daily momentum
                    let trendDisplay = '<span style="color: var(--color-text-secondary);">-</span>';
                    if (ma150 !== null && ma150 !== undefined) {
                        const isAboveMA = currentPrice > ma150;
                        const dailyUp = dailyChangePercent !== null && dailyChangePercent !== undefined && dailyChangePercent >= 0;
                        if (isAboveMA && dailyUp) {
                            trendDisplay = '<span class="profit" title="Bullish">ğŸ“ˆ Bullish</span>';
                        } else if (!isAboveMA && !dailyUp) {
                            trendDisplay = '<span class="loss" title="Bearish">ğŸ“‰ Bearish</span>';
                        } else if (isAboveMA && !dailyUp) {
                            trendDisplay = '<span style="color: #f59e0b;" title="Caution - above MA but declining">âš ï¸ Caution</span>';
                        } else {
                            trendDisplay = '<span style="color: #3b82f6;" title="Recovery - below MA but rising">ğŸ”„ Recovery</span>';
                        }
                    }

                    // Profit in currency - only show for non-ILS stocks
                    let profitCurrencyDisplay = '-';
                    if (currency !== 'ILS') {
                        profitCurrencyDisplay = `<span class="${isProfitCurrency ? 'profit' : 'loss'}">${isProfitCurrency ? '+' : ''}${currencySymbol}${profitInCurrency.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}</span>`;
                    }

                    return `
                        <tr>
                            <td class="col-static stock-symbol">${h.symbol}</td>
                            <td class="col-static">${h.name || '-'}</td>
                            <td class="col-static">${h.quantity.toLocaleString()}</td>
                            <td class="col-static">${currencySymbol}${h.avgPrice.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                            <td class="col-static">â‚ª${costILS.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}</td>
                            <td class="col-dynamic">${currencySymbol}${currentPrice.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                            <td class="col-dynamic">${dailyChangeDisplay}</td>
                            <td class="col-dynamic">${ma150Display}</td>
                            <td class="col-dynamic">${trendDisplay}</td>
                            <td class="col-dynamic"><strong>â‚ª${valueILS.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}</strong></td>
                            <td class="col-dynamic">${profitCurrencyDisplay}</td>
                            <td class="col-dynamic ${isProfit ? 'profit' : 'loss'}">
                                ${isProfit ? '+' : ''}â‚ª${profitILS.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}
                            </td>
                            <td class="col-dynamic"><span class="${isProfit ? 'profit' : 'loss'}">${isProfit ? '+' : ''}${profitPercent.toFixed(1)}%</span></td>
                            <td class="col-dynamic">${portfolioPercent.toFixed(1)}%</td>
                            <td class="col-dynamic">
                                <div class="action-buttons">
                                    <button class="btn btn-secondary btn-sm" onclick="openAlertModal('${h.symbol}', ${currentPrice})" title="${I18n.t('stocks.addAlertTooltip')}">ğŸ””</button>
                                    <button class="btn btn-secondary btn-sm" onclick="openUpdatePriceModal('${h.symbol}', ${currentPrice})" title="${I18n.t('stocks.updatePriceTooltip')}">ğŸ’°</button>
                                    <button class="btn btn-secondary btn-sm" onclick="openSellModal('${h.symbol}', ${h.quantity}, ${currentPrice})" title="${I18n.t('stocks.sellTooltip')}">ğŸ“¤</button>
                                    <button class="btn btn-danger btn-sm" onclick="deleteStock('${h.symbol}')" title="${I18n.t('stocks.deleteTooltip')}">ğŸ—‘ï¸</button>
                                </div>
                            </td>
                        </tr>
                    `;
                });

                // Build profit currency totals string
                const profitCurrencyParts = [];
                if (totalProfitCurrency.USD !== 0) {
                    const isP = totalProfitCurrency.USD >= 0;
                    profitCurrencyParts.push(`<span class="${isP ? 'profit' : 'loss'}">${isP ? '+' : ''}$${totalProfitCurrency.USD.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}</span>`);
                }
                if (totalProfitCurrency.GBP !== 0) {
                    const isP = totalProfitCurrency.GBP >= 0;
                    profitCurrencyParts.push(`<span class="${isP ? 'profit' : 'loss'}">${isP ? '+' : ''}Â£${totalProfitCurrency.GBP.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}</span>`);
                }
                if (totalProfitCurrency.EUR !== 0) {
                    const isP = totalProfitCurrency.EUR >= 0;
                    profitCurrencyParts.push(`<span class="${isP ? 'profit' : 'loss'}">${isP ? '+' : ''}â‚¬${totalProfitCurrency.EUR.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}</span>`);
                }
                const profitCurrencyTotal = profitCurrencyParts.join('<br>') || '-';

                // Add totals row
                const isTotalProfit = totalProfitILS >= 0;
                const totalReturnPercent = totalCostILS > 0 ? ((totalProfitILS / totalCostILS) * 100).toFixed(1) : '0.0';
                rows.push(`
                    <tr style="font-weight: bold; border-top: 2px solid var(--color-border);">
                        <td class="col-static" colspan="4" style="text-align: left;">×¡×”"×›</td>
                        <td class="col-static">â‚ª${totalCostILS.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}</td>
                        <td class="col-dynamic" colspan="4"></td>
                        <td class="col-dynamic"><strong>â‚ª${totalValueILS.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}</strong></td>
                        <td class="col-dynamic">${profitCurrencyTotal}</td>
                        <td class="col-dynamic ${isTotalProfit ? 'profit' : 'loss'}">
                            ${isTotalProfit ? '+' : ''}â‚ª${totalProfitILS.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}
                        </td>
                        <td class="col-dynamic"><span class="${isTotalProfit ? 'profit' : 'loss'}">${isTotalProfit ? '+' : ''}${totalReturnPercent}%</span></td>
                        <td class="col-dynamic">100%</td>
                        <td class="col-dynamic"></td>
                    </tr>
                `);

                holdingsTable.innerHTML = rows.join('');

                // Update portfolio chart
                Charts.createPortfolioChart('portfolioChart', data.holdings);
            }

            // Update summary metrics
            const totalProfitLoss = totalProfitILS;
            const totalReturn = totalCostILS > 0 ? ((totalProfitILS / totalCostILS) * 100).toFixed(2) : 0;
            const isProfit = totalProfitILS >= 0;

            document.getElementById('totalValue').textContent = `â‚ª${totalValueILS.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}`;
            document.getElementById('totalCost').textContent = `â‚ª${totalCostILS.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}`;
            document.getElementById('totalProfitLoss').textContent = (isProfit ? '+' : '') + `â‚ª${totalProfitILS.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}`;
            document.getElementById('totalProfitLoss').className = isProfit ? 'value profit' : 'value loss';
            document.getElementById('totalReturn').textContent = (isProfit ? '+' : '') + totalReturn + '%';
            document.getElementById('totalReturn').className = isProfit ? 'value profit' : 'value loss';

            // Load transactions
            if (data.transactions.length === 0) {
                transactionsTable.innerHTML = `<tr><td colspan="6" style="text-align: center; color: var(--color-text-secondary);">${I18n.t('common.noData')}</td></tr>`;
            } else {
                transactionsTable.innerHTML = data.transactions
                    .sort((a, b) => new Date(b.date) - new Date(a.date))
                    .slice(0, 20)
                    .map(tx => `
                        <tr>
                            <td>${I18n.formatDate(tx.date)}</td>
                            <td class="${tx.type === 'buy' ? 'positive' : 'negative'}">${tx.type === 'buy' ? I18n.t('stocks.buy') : I18n.t('stocks.sell')}</td>
                            <td class="stock-symbol">${tx.symbol}</td>
                            <td>${tx.quantity}</td>
                            <td>â‚ª${tx.price.toLocaleString(undefined, {minimumFractionDigits: 2})}</td>
                            <td>â‚ª${(tx.quantity * tx.price).toLocaleString(undefined, {minimumFractionDigits: 0})}</td>
                        </tr>
                    `).join('');
            }
        }

        function loadWatchlist() {
            const watchlist = StockAlerts.getWatchlist();
            const watchlistTable = document.getElementById('watchlistTable');

            if (watchlist.length === 0) {
                watchlistTable.innerHTML = `<tr><td colspan="9" style="text-align: center; color: var(--color-text-secondary);">${I18n.t('stocks.noWatchlistStocks')}</td></tr>`;
                return;
            }

            watchlistTable.innerHTML = watchlist.map(item => {
                const cached = priceCache[item.symbol] || {};
                const currentPrice = cached.currentPrice;
                const priceChange = cached.priceChange;
                const priceChangePercent = cached.priceChangePercent;
                const ma150 = cached.ma150;
                const ma150Position = cached.ma150Position;
                const ma150PositionPercent = cached.ma150PositionPercent;
                const currency = cached.currency || 'USD';

                // Alerts for this symbol
                const alerts = StockAlerts.getAlertsForSymbol(item.symbol);
                const activeAlerts = alerts.filter(a => a.enabled && !a.triggered).length;

                // Price display
                let priceDisplay = `<span class="ma150-na">${I18n.t('stocks.loading')}</span>`;
                let changeDisplay = '<span class="ma150-na">-</span>';

                if (currentPrice !== undefined) {
                    priceDisplay = formatStockPrice(currentPrice, currency);
                    if (priceChangePercent !== undefined) {
                        const isPositive = priceChangePercent >= 0;
                        changeDisplay = `<span class="${isPositive ? 'profit' : 'loss'}">${isPositive ? '+' : ''}${priceChangePercent.toFixed(2)}%</span>`;
                    }
                }

                // MA150 display
                let ma150Display = '<span class="ma150-na">-</span>';
                let positionDisplay = '<span class="ma150-na">-</span>';

                if (ma150 !== null && ma150 !== undefined) {
                    ma150Display = formatStockPrice(ma150, currency);
                    const positionIcon = ma150Position === 'above' ? 'ğŸŸ¢' : 'ğŸ”´';
                    const positionPercent = ma150PositionPercent?.toFixed(2) || '0';
                    const positionSign = ma150PositionPercent >= 0 ? '+' : '';
                    positionDisplay = `<span class="${ma150Position === 'above' ? 'profit' : 'loss'}">${positionIcon} ${positionSign}${positionPercent}%</span>`;
                }

                const marketDisplay = item.market === 'IL' ? 'ğŸ‡®ğŸ‡±' : 'ğŸ‡ºğŸ‡¸';

                return `
                    <tr>
                        <td class="stock-symbol">${item.symbol}</td>
                        <td>${item.name || '-'}</td>
                        <td>${marketDisplay} ${item.market}</td>
                        <td>${priceDisplay}</td>
                        <td>${changeDisplay}</td>
                        <td>${ma150Display}</td>
                        <td>${positionDisplay}</td>
                        <td>
                            <span class="badge ${activeAlerts > 0 ? 'badge-info' : ''}">${activeAlerts > 0 ? activeAlerts : '-'}</span>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-secondary btn-sm" onclick="openAlertModal('${item.symbol}', ${currentPrice || 0})" title="${I18n.t('stocks.watchlistAddAlertTooltip')}">ğŸ””</button>
                                <button class="btn btn-secondary btn-sm" onclick="viewAlerts('${item.symbol}')" title="${I18n.t('stocks.watchlistViewTooltip')}">ğŸ‘ï¸</button>
                                <button class="btn btn-danger btn-sm" onclick="removeFromWatchlist('${item.symbol}')" title="${I18n.t('stocks.watchlistRemoveTooltip')}">ğŸ—‘ï¸</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function formatStockPrice(price, currency = 'ILS') {
            const symbols = { ILS: 'â‚ª', USD: '$', EUR: 'â‚¬', GBP: 'Â£' };
            return `${symbols[currency] || ''}${price.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }

        // ========== Price Refresh ==========

        async function refreshAllPrices() {
            if (isRefreshing) return;

            isRefreshing = true;
            const refreshBtn = document.getElementById('refreshBtn');
            refreshBtn.disabled = true;
            refreshBtn.innerHTML = `<span class="spin">ğŸ”„</span><span>${I18n.t('stocks.updating')}</span>`;

            try {
                // Get all symbols to fetch (holdings + watchlist)
                const holdings = Storage.getStocks().holdings;
                const watchlist = StockAlerts.getWatchlist();

                const symbolsToFetch = [
                    ...holdings.map(h => ({ symbol: h.symbol, market: h.market })),
                    ...watchlist.map(w => ({ symbol: w.symbol, market: w.market }))
                ];

                // Remove duplicates
                const uniqueSymbols = [...new Map(symbolsToFetch.map(s => [s.symbol, s])).values()];

                if (uniqueSymbols.length === 0) {
                    return;
                }

                // Fetch prices
                const results = await StockAPI.fetchMultiple(uniqueSymbols);

                // Update cache - keep prices in native currency
                for (const result of Object.values(results)) {
                    if (result.success) {
                        // Store original currency info
                        result.originalCurrency = result.currency;
                        result.originalPrice = result.currentPrice;

                        priceCache[result.symbol] = result;
                        StockAlerts.updatePriceCache(result.symbol, result);

                        // Store for MA150 chart
                        if (result.historicalData && result.historicalData.length > 0) {
                            ma150ChartData[result.symbol] = result;
                        }

                        // Update storage price for holdings
                        const holding = holdings.find(h => h.symbol === result.symbol);
                        if (holding) {
                            Storage.updateStockPrice(result.symbol, result.currentPrice);
                        }
                    }
                }

                // Check alerts
                const triggered = StockAlerts.checkAlerts(priceCache);
                if (triggered.length > 0) {
                    showTriggeredAlerts(triggered);
                }

                // Update last update time
                document.getElementById('lastUpdateTime').textContent = `${I18n.t('stocks.lastUpdate')} ${new Date().toLocaleTimeString('he-IL')}`;

                // Reload displays
                loadStocks();
                loadWatchlist();
                checkTriggeredAlerts();
                populateMA150ChartDropdown();

            } catch (error) {
                console.error('Error refreshing prices:', error);
                App.notify(I18n.t('stocks.priceUpdateError'), 'error');
            } finally {
                isRefreshing = false;
                refreshBtn.disabled = false;
                refreshBtn.innerHTML = `<span>ğŸ”„</span><span>${I18n.t('stocks.refreshPrices')}</span>`;
            }
        }

        function startAutoRefresh() {
            const settings = StockAlerts.getSettings();
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
            refreshInterval = setInterval(refreshAllPrices, settings.refreshInterval * 1000);
        }

        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
        }

        function toggleAutoRefresh() {
            const enabled = document.getElementById('autoRefreshToggle').checked;
            StockAlerts.updateSettings({ autoRefresh: enabled });

            if (enabled) {
                startAutoRefresh();
                App.notify(I18n.t('stocks.autoRefreshEnabled'), 'info');
            } else {
                stopAutoRefresh();
                App.notify(I18n.t('stocks.autoRefreshDisabled'), 'info');
            }
        }

        // ========== Alerts ==========

        function checkTriggeredAlerts() {
            const triggered = StockAlerts.getTriggeredAlerts();
            const alertsBar = document.getElementById('stockAlertsBar');

            if (triggered.length === 0) {
                alertsBar.style.display = 'none';
                return;
            }

            alertsBar.style.display = 'block';
            alertsBar.innerHTML = `
                <div class="alerts-bar-content">
                    <span class="alerts-icon">ğŸ””</span>
                    <span class="alerts-count">${triggered.length} ${I18n.t('stocks.activeAlerts')}</span>
                    <div class="alerts-list">
                        ${triggered.slice(0, 3).map(a => `
                            <span class="alert-item">${a.symbol}: ${StockAlerts.getAlertTypeName(a.type)}</span>
                        `).join('')}
                        ${triggered.length > 3 ? `<span class="alert-more">+${triggered.length - 3} ${I18n.t('stocks.more')}</span>` : ''}
                    </div>
                    <button class="btn btn-sm" onclick="dismissTriggeredAlerts()">${I18n.t('stocks.closeAll')}</button>
                </div>
            `;
        }

        function showTriggeredAlerts(triggered) {
            triggered.forEach(alert => {
                const message = StockAlerts.formatAlertMessage(alert, alert.currentData);
                App.notify(message, 'info');

                // Send push notification if enabled
                if (Notifications && Notifications.getSettings().stockAlerts) {
                    Notifications.notifyStockAlert(alert, alert.currentData);
                }
            });
        }

        function dismissTriggeredAlerts() {
            const triggered = StockAlerts.getTriggeredAlerts();
            triggered.forEach(alert => {
                StockAlerts.resetAlert(alert.id);
            });
            checkTriggeredAlerts();
        }

        function openAlertModal(symbol, currentPrice) {
            document.getElementById('alertSymbol').value = symbol;
            document.getElementById('alertInfo').textContent = `${symbol} - ${I18n.t('stocks.currentPriceInfo')} ${currentPrice ? currentPrice.toFixed(2) : I18n.t('stocks.notAvailable')}`;
            document.getElementById('alertType').value = 'price_above';
            document.getElementById('alertValue').value = currentPrice ? (currentPrice * 1.05).toFixed(2) : '';
            updateAlertValueLabel();
            document.getElementById('alertModal').classList.add('active');
        }

        function closeAlertModal() {
            document.getElementById('alertModal').classList.remove('active');
        }

        function updateAlertValueLabel() {
            const type = document.getElementById('alertType').value;
            const valueGroup = document.getElementById('alertValueGroup');
            const valueLabel = document.getElementById('alertValueLabel');

            if (type === 'ma150_cross_above' || type === 'ma150_cross_below') {
                valueGroup.style.display = 'none';
            } else {
                valueGroup.style.display = 'block';
                if (type === 'percent_change') {
                    valueLabel.textContent = I18n.t('stocks.percentChangeLabel');
                } else {
                    valueLabel.textContent = I18n.t('stocks.targetPrice');
                }
            }
        }

        function saveAlert() {
            const symbol = document.getElementById('alertSymbol').value;
            const type = document.getElementById('alertType').value;
            const value = document.getElementById('alertValue').value;

            if (!type.includes('ma150') && !value) {
                App.notify(I18n.t('stocks.enterValue'), 'error');
                return;
            }

            StockAlerts.addAlert(symbol, type, value || 0);
            closeAlertModal();
            loadWatchlist();
            App.notify(I18n.t('stocks.alertAdded'), 'success');
        }

        function viewAlerts(symbol) {
            const alerts = StockAlerts.getAlertsForSymbol(symbol);
            document.getElementById('viewAlertsTitle').textContent = `${I18n.t('stocks.viewAlerts')} - ${symbol}`;

            if (alerts.length === 0) {
                document.getElementById('alertsList').innerHTML = `<p style="color: var(--color-text-secondary);">${I18n.t('stocks.noStocks')}</p>`;
            } else {
                document.getElementById('alertsList').innerHTML = alerts.map(alert => `
                    <div class="alert-row ${alert.triggered ? 'triggered' : ''} ${!alert.enabled ? 'disabled' : ''}">
                        <div class="alert-info">
                            <span class="alert-type">${StockAlerts.getAlertTypeName(alert.type)}</span>
                            ${!alert.type.includes('ma150') ? `<span class="alert-value">${alert.value}</span>` : ''}
                            ${alert.triggered ? '<span class="badge badge-success">×”×ª×§×™×™×</span>' : ''}
                            ${!alert.enabled ? '<span class="badge badge-danger">××•×©×‘×ª</span>' : ''}
                        </div>
                        <div class="alert-actions">
                            <button class="btn btn-sm btn-secondary" onclick="toggleAlertEnabled('${alert.id}')">${alert.enabled ? 'â¸ï¸' : 'â–¶ï¸'}</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteAlert('${alert.id}')">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                `).join('');
            }

            document.getElementById('viewAlertsModal').classList.add('active');
        }

        function closeViewAlertsModal() {
            document.getElementById('viewAlertsModal').classList.remove('active');
        }

        function toggleAlertEnabled(alertId) {
            StockAlerts.toggleAlert(alertId);
            const symbol = document.getElementById('alertSymbol').value;
            if (symbol) {
                viewAlerts(symbol);
            }
            loadWatchlist();
        }

        function deleteAlert(alertId) {
            if (confirm('×”×× ×œ××—×•×§ ×”×ª×¨××” ×–×•?')) {
                StockAlerts.removeAlert(alertId);
                const title = document.getElementById('viewAlertsTitle').textContent;
                const symbol = title.replace(I18n.t('stocks.viewAlerts') + ' - ', '');
                viewAlerts(symbol);
                loadWatchlist();
                App.notify('×”×ª×¨××” × ××—×§×”', 'success');
            }
        }

        // ========== Watchlist ==========

        function openAddWatchlistModal() {
            document.getElementById('watchlistForm').reset();
            document.getElementById('searchResults').innerHTML = '';
            document.getElementById('watchlistModal').classList.add('active');
        }

        function closeAddWatchlistModal() {
            document.getElementById('watchlistModal').classList.remove('active');
        }

        async function searchStocks() {
            const query = document.getElementById('watchlistSearch').value.trim();
            const resultsDiv = document.getElementById('searchResults');

            if (query.length < 2) {
                resultsDiv.innerHTML = '';
                return;
            }

            // Debounce
            if (searchTimeout) {
                clearTimeout(searchTimeout);
            }

            searchTimeout = setTimeout(async () => {
                resultsDiv.innerHTML = `<div class="search-loading">${I18n.t('stocks.loading')}</div>`;

                try {
                    const results = await StockAPI.searchStock(query);

                    if (results.length === 0) {
                        resultsDiv.innerHTML = `<div class="search-empty">${I18n.t('stocks.notAvailable')}</div>`;
                        return;
                    }

                    resultsDiv.innerHTML = results.map(r => `
                        <div class="search-result-item" onclick="selectSearchResult('${r.symbol}', '${r.name.replace(/'/g, "\\'")}', '${r.market}')">
                            <span class="result-symbol">${r.symbol}</span>
                            <span class="result-name">${r.name}</span>
                            <span class="result-market">${r.market === 'IL' ? 'ğŸ‡®ğŸ‡±' : 'ğŸ‡ºğŸ‡¸'}</span>
                        </div>
                    `).join('');
                } catch (error) {
                    resultsDiv.innerHTML = '<div class="search-error">×©×’×™××” ×‘×—×™×¤×•×©</div>';
                }
            }, 300);
        }

        function selectSearchResult(symbol, name, market) {
            document.getElementById('watchlistSymbol').value = symbol;
            document.getElementById('watchlistName').value = name;
            document.getElementById('watchlistMarket').value = market;
            document.getElementById('searchResults').innerHTML = '';
            document.getElementById('watchlistSearch').value = '';
        }

        function addToWatchlist() {
            const symbol = document.getElementById('watchlistSymbol').value.trim().toUpperCase();
            const name = document.getElementById('watchlistName').value.trim();
            const market = document.getElementById('watchlistMarket').value;

            if (!symbol) {
                App.notify('× × ×œ×”×–×™×Ÿ ×¡×™××•×œ', 'error');
                return;
            }

            const result = StockAlerts.addToWatchlist(symbol, name, market);

            if (result) {
                closeAddWatchlistModal();
                loadWatchlist();
                refreshAllPrices();
                App.notify('×× ×™×” × ×•×¡×¤×” ×œ×¨×©×™××ª ×”××¢×§×‘', 'success');
            } else {
                App.notify('×× ×™×” ×–×• ×›×‘×¨ ×‘×¨×©×™××ª ×”××¢×§×‘', 'error');
            }
        }

        function removeFromWatchlist(symbol) {
            if (confirm(`×”×× ×œ×”×¡×™×¨ ××ª ${symbol} ××¨×©×™××ª ×”××¢×§×‘?`)) {
                StockAlerts.removeFromWatchlist(symbol);
                loadWatchlist();
                App.notify('×× ×™×” ×”×•×¡×¨×” ××¨×©×™××ª ×”××¢×§×‘', 'success');
            }
        }

        // ========== Stock CRUD ==========

        function openStockModal() {
            document.getElementById('stockForm').reset();
            document.getElementById('stockModal').classList.add('active');
        }

        function closeStockModal() {
            document.getElementById('stockModal').classList.remove('active');
        }

        function saveStock() {
            const symbol = document.getElementById('stockSymbol').value.toUpperCase();
            const name = document.getElementById('stockName').value;
            const market = document.getElementById('stockMarket').value;
            const quantity = parseFloat(document.getElementById('stockQuantity').value);
            const avgPrice = parseFloat(document.getElementById('stockPrice').value);
            const currentPrice = parseFloat(document.getElementById('stockCurrentPrice').value) || avgPrice;
            const currency = document.getElementById('stockCurrency').value;

            if (!symbol || !quantity || !avgPrice) {
                App.notify('Please fill all required fields', 'error');
                return;
            }

            // Format symbol based on market
            const formattedSymbol = StockAPI.formatSymbol(symbol, market);

            Storage.addStock({ symbol: formattedSymbol, name, quantity, avgPrice, currentPrice, currency, market });
            closeStockModal();
            loadStocks();
            refreshAllPrices();
            App.notify(I18n.t('common.save') + ' âœ“', 'success');
        }

        // Update Price Modal
        function openUpdatePriceModal(symbol, currentPrice) {
            document.getElementById('updateSymbol').value = symbol;
            document.getElementById('newPrice').value = currentPrice;
            document.getElementById('updatePriceModal').classList.add('active');
        }

        function closeUpdatePriceModal() {
            document.getElementById('updatePriceModal').classList.remove('active');
        }

        function updatePrice() {
            const symbol = document.getElementById('updateSymbol').value;
            const newPrice = parseFloat(document.getElementById('newPrice').value);

            Storage.updateStockPrice(symbol, newPrice);
            closeUpdatePriceModal();
            loadStocks();
            App.notify(I18n.t('stocks.updatePrice') + ' âœ“', 'success');
        }

        // Sell Modal
        function openSellModal(symbol, maxQuantity, currentPrice) {
            document.getElementById('sellSymbol').value = symbol;
            document.getElementById('sellInfo').textContent = `${symbol} - ×›××•×ª ×–××™× ×”: ${maxQuantity}`;
            document.getElementById('sellQuantity').max = maxQuantity;
            document.getElementById('sellQuantity').value = '';
            document.getElementById('sellPrice').value = currentPrice;
            document.getElementById('sellModal').classList.add('active');
        }

        function closeSellModal() {
            document.getElementById('sellModal').classList.remove('active');
        }

        function sellStock() {
            const symbol = document.getElementById('sellSymbol').value;
            const quantity = parseFloat(document.getElementById('sellQuantity').value);
            const price = parseFloat(document.getElementById('sellPrice').value);

            if (!quantity || !price) {
                App.notify('Please fill all required fields', 'error');
                return;
            }

            const result = Storage.sellStock(symbol, quantity, price);
            if (result) {
                closeSellModal();
                loadStocks();
                App.notify(I18n.t('stocks.sell') + ' âœ“', 'success');
            } else {
                App.notify('Insufficient quantity', 'error');
            }
        }

        function deleteStock(symbol) {
            if (confirm(I18n.t('common.confirmDelete'))) {
                Storage.deleteStock(symbol);
                loadStocks();
                App.notify(I18n.t('common.delete') + ' âœ“', 'success');
            }
        }

        function exportHoldingsToExcel() {
            const data = Storage.getStocks();
            if (data.holdings.length === 0) {
                App.notify('××™×Ÿ ××—×–×§×•×ª ×œ×™×™×¦×•×', 'error');
                return;
            }

            const rows = data.holdings.map(h => {
                const cached = priceCache[h.symbol] || {};
                const currency = h.currency || 'USD';
                const rate = currencyRates[currency] || 1;
                const currentPrice = cached.currentPrice || h.currentPrice || h.avgPrice;

                let valueILS, profitILS;
                if (h.valueILS && h.valueILS > 0) {
                    valueILS = h.valueILS;
                    profitILS = h.profitILS || 0;
                } else {
                    const valueInCurrency = currentPrice * h.quantity;
                    valueILS = valueInCurrency * rate;
                    profitILS = (currentPrice - h.avgPrice) * h.quantity * rate;
                }
                const costILS = valueILS - profitILS;
                const profitPercent = costILS > 0 ? (profitILS / costILS) * 100 : 0;
                const dailyChange = cached.priceChangePercent || 0;
                const ma150 = cached.ma150;
                const ma150Dist = cached.ma150PositionPercent;

                let trend = '-';
                if (ma150 !== null && ma150 !== undefined) {
                    const aboveMA = currentPrice > ma150;
                    const dailyUp = dailyChange >= 0;
                    if (aboveMA && dailyUp) trend = 'Bullish';
                    else if (!aboveMA && !dailyUp) trend = 'Bearish';
                    else if (aboveMA && !dailyUp) trend = 'Caution';
                    else trend = 'Recovery';
                }

                return {
                    '×¡×™××•×œ': h.symbol,
                    '×©×': h.name || '-',
                    '×›××•×ª': h.quantity,
                    '××˜×‘×¢': currency,
                    '××—×™×¨ ×¨×›×™×©×”': h.avgPrice,
                    '×¢×œ×•×ª ×¨×›×™×©×” â‚ª': Math.round(costILS),
                    '××—×™×¨ × ×•×›×—×™': currentPrice,
                    '×©×™× ×•×™ ×™×•××™ %': Number(dailyChange.toFixed(2)),
                    'MA150 ××¨×—×§ %': ma150Dist !== null && ma150Dist !== undefined ? Number(ma150Dist.toFixed(1)) : '-',
                    '×˜×¨× ×“': trend,
                    '×©×•×•×™ × ×•×›×—×™ â‚ª': Math.round(valueILS),
                    '×¨×•×•×— â‚ª': Math.round(profitILS),
                    '×©×™× ×•×™ %': Number(profitPercent.toFixed(1))
                };
            });

            const ws = XLSX.utils.json_to_sheet(rows);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Holdings');

            // Auto-size columns
            const colWidths = Object.keys(rows[0]).map(key => ({
                wch: Math.max(key.length + 2, ...rows.map(r => String(r[key]).length + 2))
            }));
            ws['!cols'] = colWidths;

            const dateStr = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `FinSight_Holdings_${dateStr}.xlsx`);
            App.notify('×§×•×‘×¥ Excel ×™×•×¦× ×‘×”×¦×œ×—×” âœ“', 'success');
        }

        async function importCSV() {
            const format = CSVImport.showImportHelp('stocks');
            const confirmed = confirm(
                `${format.title}\n\n` +
                `×¢××•×“×•×ª × ×“×¨×©×•×ª:\n${format.columns.join(', ')}\n\n` +
                `×“×•×’××”:\n${format.example}\n\n` +
                `×œ×”××©×™×š?`
            );

            if (!confirmed) return;

            const result = await CSVImport.openFilePicker('stocks');

            if (result.success) {
                App.notify(`×™×•×‘××• ${result.imported} ×× ×™×•×ª ×‘×”×¦×œ×—×”`, 'success');
                loadStocks();
            } else {
                App.notify(result.error || '×©×’×™××” ×‘×™×™×‘×•×', 'error');
            }

            if (result.errors && result.errors.length > 0) {
                console.log('Import errors:', result.errors);
            }
        }

        // ========== Interactive MA150 Chart ==========

        let ma150ChartInstance = null;
        let ma150ChartData = {};

        function populateMA150ChartDropdown() {
            const select = document.getElementById('ma150ChartSelect');
            const holdings = Storage.getStocks().holdings;
            const watchlist = StockAlerts.getWatchlist();

            // Clear existing options except first
            select.innerHTML = '<option value="">×‘×—×¨ ×× ×™×”...</option>';

            // Add holdings
            if (holdings.length > 0) {
                const holdingsGroup = document.createElement('optgroup');
                holdingsGroup.label = 'ğŸ“‹ ××—×–×§×•×ª';
                holdings.forEach(h => {
                    const option = document.createElement('option');
                    option.value = h.symbol;
                    option.textContent = `${h.symbol} - ${h.name || ''}`;
                    holdingsGroup.appendChild(option);
                });
                select.appendChild(holdingsGroup);
            }

            // Add watchlist
            if (watchlist.length > 0) {
                const watchlistGroup = document.createElement('optgroup');
                watchlistGroup.label = 'ğŸ‘ï¸ ×¨×©×™××ª ××¢×§×‘';
                watchlist.forEach(w => {
                    const option = document.createElement('option');
                    option.value = w.symbol;
                    option.textContent = `${w.symbol} - ${w.name || ''}`;
                    watchlistGroup.appendChild(option);
                });
                select.appendChild(watchlistGroup);
            }
        }

        async function updateMA150Chart() {
            const symbol = document.getElementById('ma150ChartSelect').value;
            const timeRange = document.getElementById('ma150TimeRange').value;
            const chartContainer = document.getElementById('ma150Chart').parentElement;
            const emptyState = document.getElementById('ma150ChartEmpty');
            const infoSection = document.getElementById('ma150ChartInfo');

            if (!symbol) {
                emptyState.style.display = 'block';
                infoSection.style.display = 'none';
                if (ma150ChartInstance) {
                    ma150ChartInstance.destroy();
                    ma150ChartInstance = null;
                }
                return;
            }

            emptyState.style.display = 'none';
            infoSection.style.display = 'block';

            // Check if we have cached data
            let stockData = ma150ChartData[symbol];

            if (!stockData || !stockData.historicalData || stockData.historicalData.length === 0) {
                // Fetch fresh data
                const holdings = Storage.getStocks().holdings;
                const holding = holdings.find(h => h.symbol === symbol);
                const market = holding?.market || StockAPI.detectMarket(symbol);

                stockData = await StockAPI.fetchStockData(symbol, market);
                ma150ChartData[symbol] = stockData;
            }

            if (!stockData.success || !stockData.historicalData || stockData.historicalData.length === 0) {
                emptyState.innerHTML = '<span style="font-size: 3rem;">âš ï¸</span><p style="margin-top: 15px;">×œ× × ×™×ª×Ÿ ×œ×˜×¢×•×Ÿ × ×ª×•× ×™× ×¢×‘×•×¨ ×× ×™×” ×–×•</p>';
                emptyState.style.display = 'block';
                infoSection.style.display = 'none';
                return;
            }

            // Update info metrics
            updateChartMetrics(stockData);

            // Filter data by time range
            const filteredData = filterByTimeRange(stockData.historicalData, timeRange);
            const filteredMA150 = filterByTimeRange(stockData.ma150Series, timeRange);

            // Render chart
            renderMA150Chart(filteredData, filteredMA150, stockData.currency, symbol);
        }

        function updateChartMetrics(stockData) {
            const currency = stockData.currency || 'USD';
            const symbols = { ILS: 'â‚ª', USD: '$', EUR: 'â‚¬' };
            const currSymbol = symbols[currency] || '';

            document.getElementById('chartCurrentPrice').textContent =
                `${currSymbol}${stockData.currentPrice?.toFixed(2) || '-'}`;

            document.getElementById('chartMA150').textContent =
                stockData.ma150 ? `${currSymbol}${stockData.ma150.toFixed(2)}` : '-';

            const positionEl = document.getElementById('chartPosition');
            if (stockData.ma150Position) {
                const icon = stockData.ma150Position === 'above' ? 'ğŸŸ¢' : 'ğŸ”´';
                const percent = stockData.ma150PositionPercent?.toFixed(1) || '0';
                const sign = stockData.ma150PositionPercent >= 0 ? '+' : '';
                positionEl.innerHTML = `${icon} ${sign}${percent}%`;
                positionEl.className = `value ${stockData.ma150Position}`;
            } else {
                positionEl.textContent = '-';
                positionEl.className = 'value';
            }

            // Calculate 30-day change
            const changeEl = document.getElementById('chart30DayChange');
            if (stockData.historicalData && stockData.historicalData.length >= 30) {
                const price30DaysAgo = stockData.historicalData[stockData.historicalData.length - 30].close;
                const currentPrice = stockData.currentPrice;
                const change = ((currentPrice - price30DaysAgo) / price30DaysAgo) * 100;
                const sign = change >= 0 ? '+' : '';
                changeEl.textContent = `${sign}${change.toFixed(1)}%`;
                changeEl.className = `value ${change >= 0 ? 'above' : 'below'}`;
            } else {
                changeEl.textContent = '-';
                changeEl.className = 'value';
            }
        }

        function filterByTimeRange(data, timeRange) {
            if (!data || data.length === 0) return [];

            const now = new Date();
            let cutoffDate = new Date();

            switch (timeRange) {
                case '3m':
                    cutoffDate.setMonth(now.getMonth() - 3);
                    break;
                case '6m':
                    cutoffDate.setMonth(now.getMonth() - 6);
                    break;
                case '1y':
                    cutoffDate.setFullYear(now.getFullYear() - 1);
                    break;
            }

            return data.filter(d => {
                const date = d.date instanceof Date ? d.date : new Date(d.date);
                return date >= cutoffDate;
            });
        }

        function renderMA150Chart(priceData, ma150Data, currency, symbol) {
            const ctx = document.getElementById('ma150Chart').getContext('2d');
            const symbols = { ILS: 'â‚ª', USD: '$', EUR: 'â‚¬' };
            const currSymbol = symbols[currency] || '';

            // Prepare datasets
            const priceLabels = priceData.map(d => {
                const date = d.date instanceof Date ? d.date : new Date(d.date);
                return date.toLocaleDateString('he-IL', { day: 'numeric', month: 'short' });
            });

            const priceValues = priceData.map(d => d.close);

            // Align MA150 data with price data by date
            const ma150Map = new Map();
            ma150Data.forEach(d => {
                const date = d.date instanceof Date ? d.date : new Date(d.date);
                const key = date.toDateString();
                ma150Map.set(key, d.value);
            });

            const ma150Values = priceData.map(d => {
                const date = d.date instanceof Date ? d.date : new Date(d.date);
                return ma150Map.get(date.toDateString()) || null;
            });

            if (ma150ChartInstance) {
                ma150ChartInstance.destroy();
            }

            ma150ChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: priceLabels,
                    datasets: [
                        {
                            label: `××—×™×¨ ${symbol}`,
                            data: priceValues,
                            borderColor: '#8b5cf6',
                            backgroundColor: 'rgba(139, 92, 246, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.1,
                            pointRadius: 0,
                            pointHoverRadius: 5
                        },
                        {
                            label: 'MA150',
                            data: ma150Values,
                            borderColor: '#f97316',
                            backgroundColor: 'transparent',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            fill: false,
                            tension: 0.1,
                            pointRadius: 0,
                            pointHoverRadius: 5
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: getComputedStyle(document.body).getPropertyValue('--color-text-primary') || '#fff',
                                usePointStyle: true,
                                padding: 20
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.y;
                                    if (value === null) return null;
                                    return `${context.dataset.label}: ${currSymbol}${value.toFixed(2)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            ticks: {
                                color: getComputedStyle(document.body).getPropertyValue('--color-text-secondary') || '#888',
                                maxRotation: 45,
                                minRotation: 0,
                                autoSkip: true,
                                maxTicksLimit: 12
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)'
                            }
                        },
                        y: {
                            display: true,
                            ticks: {
                                color: getComputedStyle(document.body).getPropertyValue('--color-text-secondary') || '#888',
                                callback: function(value) {
                                    return `${currSymbol}${value.toFixed(0)}`;
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)'
                            }
                        }
                    }
                }
            });
        }

        // ========== Broker XLS Import ==========

        function importBrokerXLS() {
            document.getElementById('brokerFileInput').click();
        }

        async function handleBrokerFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                // Try reading as XLSX first (for FinSight exports and real xlsx)
                let holdings = [];
                const arrayBuffer = await file.arrayBuffer();
                const uint8 = new Uint8Array(arrayBuffer);
                try {
                    const workbook = XLSX.read(uint8, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                    console.log('XLSX rows:', rows.slice(0, 3));

                    // Check if it's a FinSight export (has "×¡×™××•×œ" header)
                    if (rows.length > 0 && rows[0].some(c => String(c || '').includes('×¡×™××•×œ'))) {
                        holdings = parseFinSightExport(rows);
                        console.log('FinSight parsed holdings:', holdings.length);
                    }
                } catch(e) {
                    console.log('XLSX parse failed, trying XML:', e.message);
                }

                // Fallback: try XML-based XLS (Israeli brokers)
                if (holdings.length === 0) {
                    const text = new TextDecoder().decode(uint8);
                    holdings = parseBrokerXLS(text);
                }

                if (holdings.length === 0) {
                    App.notify('×œ× × ××¦××• ××—×–×§×•×ª ×‘×§×•×‘×¥', 'error');
                    return;
                }

                // Show confirmation - use valueILS from broker file
                const totalValue = holdings.reduce((sum, h) => sum + (h.valueILS || 0), 0);
                const totalProfit = holdings.reduce((sum, h) => sum + (h.profitILS || 0), 0);
                const confirmed = confirm(
                    `× ××¦××• ${holdings.length} ××—×–×§×•×ª\n` +
                    `×©×•×•×™ ×›×•×œ×œ: â‚ª${totalValue.toLocaleString(undefined, {minimumFractionDigits: 0})}\n` +
                    `×¨×•×•×—/×”×¤×¡×“: â‚ª${totalProfit.toLocaleString(undefined, {minimumFractionDigits: 0})}\n\n` +
                    `×¨×©×™××ª ×× ×™×•×ª:\n${holdings.map(h => `  ${h.symbol} - ${h.name} (â‚ª${(h.valueILS || 0).toLocaleString(undefined, {maximumFractionDigits: 0})}, ×¨×•×•×—: â‚ª${(h.profitILS || 0).toLocaleString(undefined, {maximumFractionDigits: 0})})`).join('\n')}\n\n` +
                    `×œ×™×™×‘× ××ª ×›×œ ×”××—×–×§×•×ª?`
                );

                if (!confirmed) return;

                // Smart merge: update broker holdings, keep manual holdings untouched
                const existingData = Storage.getStocks();
                const brokerSymbols = holdings.map(h => h.symbol);

                let importMode = 'smart'; // default: smart merge
                if (existingData.holdings.length > 0) {
                    const manualHoldings = existingData.holdings.filter(h => !brokerSymbols.includes(h.symbol));
                    const choice = confirm(
                        `× ××¦××• ${existingData.holdings.length} ××—×–×§×•×ª ×§×™×™××•×ª.\n` +
                        `××ª×•×›×Ÿ ${manualHoldings.length} ××—×–×§×•×ª ×™×“× ×™×•×ª (×œ× ××”×‘×¨×•×§×¨).\n\n` +
                        `×›×Ÿ = ×¢×“×›×Ÿ ×× ×™×•×ª ×‘×¨×•×§×¨, ×©××•×¨ ×™×“× ×™×•×ª\n` +
                        `×œ× = ×”×—×œ×£ ×”×›×œ (××—×§ ×’× ×™×“× ×™×•×ª)`
                    );
                    importMode = choice ? 'smart' : 'replace';
                }

                if (importMode === 'replace') {
                    // Clear all holdings
                    Storage.saveStocks({ holdings: [], transactions: existingData.transactions || [] });
                } else {
                    // Smart merge: remove only broker holdings, keep manual ones
                    const manualHoldings = existingData.holdings.filter(h => !brokerSymbols.includes(h.symbol));
                    Storage.saveStocks({ holdings: manualHoldings, transactions: existingData.transactions || [] });
                }

                // Import broker holdings (will add fresh, not merge)
                let imported = 0;
                holdings.forEach(h => {
                    Storage.importStock(h);
                    imported++;
                });

                App.notify(`×™×•×‘××• ${imported} ××—×–×§×•×ª ×‘×”×¦×œ×—×”!`, 'success');
                // Clear price cache to use imported values
                Object.keys(priceCache).forEach(key => delete priceCache[key]);
                loadStocks();

            } catch (error) {
                console.error('Broker import error:', error);
                App.notify('×©×’×™××” ×‘×§×¨×™××ª ×”×§×•×‘×¥: ' + error.message, 'error');
            }

            // Reset file input
            event.target.value = '';
        }

        function parseFinSightExport(rows) {
            const headers = rows[0].map(h => String(h || '').trim());
            const symIdx = headers.findIndex(h => h.includes('×¡×™××•×œ'));
            const nameIdx = headers.findIndex(h => h === '×©×');
            const qtyIdx = headers.findIndex(h => h.includes('×›××•×ª'));
            const currIdx = headers.findIndex(h => h.includes('××˜×‘×¢'));
            const buyPriceIdx = headers.findIndex(h => h.includes('××—×™×¨ ×¨×›×™×©×”'));
            const costIdx = headers.findIndex(h => h.includes('×¢×œ×•×ª ×¨×›×™×©×”'));
            const curPriceIdx = headers.findIndex(h => h.includes('××—×™×¨ × ×•×›×—×™'));
            const valueIdx = headers.findIndex(h => h.includes('×©×•×•×™ × ×•×›×—×™'));
            const profitIdx = headers.findIndex(h => h.includes('×¨×•×•×—'));

            if (symIdx === -1 || qtyIdx === -1) return [];

            const holdings = [];
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                if (!row || !row[symIdx]) continue;

                const symbol = String(row[symIdx]).trim();
                const name = nameIdx >= 0 ? String(row[nameIdx] || symbol).trim() : symbol;
                const quantity = parseFloat(String(row[qtyIdx] || '0').replace(/,/g, ''));
                const currency = currIdx >= 0 ? String(row[currIdx] || 'ILS').trim() : 'ILS';
                const avgPrice = buyPriceIdx >= 0 ? parseFloat(String(row[buyPriceIdx] || '0').replace(/,/g, '')) : 0;
                const currentPrice = curPriceIdx >= 0 ? parseFloat(String(row[curPriceIdx] || '0').replace(/,/g, '')) : avgPrice;
                const valueILS = valueIdx >= 0 ? parseFloat(String(row[valueIdx] || '0').replace(/,/g, '')) : 0;
                const profitILS = profitIdx >= 0 ? parseFloat(String(row[profitIdx] || '0').replace(/,/g, '')) : 0;

                if (!symbol || isNaN(quantity) || quantity <= 0) continue;

                const market = currency === 'ILS' ? 'IL' : 'US';
                holdings.push({
                    symbol, name, quantity, avgPrice, currentPrice,
                    currency, market, valueILS, profitILS
                });
            }
            return holdings;
        }

        function parseBrokerXLS(content) {
            const holdings = [];

            // Find all Row elements using regex (handles XML-based XLS from Israeli brokers)
            const rowPattern = /<(?:ss:)?Row[^>]*>([\s\S]*?)<\/(?:ss:)?Row>/g;
            const dataPattern = /<(?:ss:)?Data[^>]*>([\s\S]*?)<\/(?:ss:)?Data>/g;
            const tagClean = /<[^>]+>/g;

            const rows = [];
            let match;
            while ((match = rowPattern.exec(content)) !== null) {
                const rowContent = match[1];
                const cells = [];
                let cellMatch;
                const dp = new RegExp(dataPattern.source, 'g');
                while ((cellMatch = dp.exec(rowContent)) !== null) {
                    cells.push(cellMatch[1].replace(tagClean, '').trim());
                }
                rows.push(cells);
            }

            // Find header row (contains '×©× ×”× ×™×™×¨' or '×©×¢×¨ ×§× ×™×”')
            let headerIdx = -1;
            for (let i = 0; i < rows.length; i++) {
                if (rows[i].some(c => c.includes('×©× ×”× ×™×™×¨') || c.includes('×©×¢×¨ ×§× ×™×”'))) {
                    headerIdx = i;
                    break;
                }
            }

            if (headerIdx === -1) {
                throw new Error('×œ× × ××¦× ×¤×•×¨××˜ ××•×›×¨ ×‘×§×•×‘×¥');
            }

            // Parse data rows after header
            // Columns: [0]secId, [1]name, [2]avgPrice, [3]qty, [4]currentPrice, [5]valueILS, [6]dailyChange, [7]profitPct, [8]profitILS
            for (let i = headerIdx + 1; i < rows.length; i++) {
                const row = rows[i];
                if (row.length < 6) continue;

                const securityId = row[0];
                const name = row[1];
                const avgPriceOriginal = parseFloat(row[2]?.replace(/,/g, ''));
                const quantity = parseFloat(row[3]?.replace(/,/g, ''));
                const currentPriceOriginal = parseFloat(row[4]?.replace(/,/g, ''));
                const valueILS = parseFloat(row[5]?.replace(/,/g, '')) || 0;
                const profitILS = parseFloat(row[8]?.replace(/,/g, '')) || 0;

                if (!name || isNaN(quantity) || quantity <= 0 || valueILS <= 0) continue;

                // Extract symbol from name
                const symbolInfo = extractSymbolFromName(name, securityId);

                holdings.push({
                    symbol: symbolInfo.symbol,
                    name: symbolInfo.displayName,
                    quantity: quantity,
                    avgPrice: avgPriceOriginal,
                    currentPrice: currentPriceOriginal || avgPriceOriginal,
                    currency: symbolInfo.currency,
                    market: symbolInfo.market,
                    valueILS: valueILS,
                    profitILS: profitILS
                });
            }

            return holdings;
        }

        function extractSymbolFromName(name, securityId) {
            // Pattern 1: "(Hebrew description) SYMBOL" e.g. "(×¡×¤×™×™×“×¨ S&P 500) SPY"
            const parenMatch = name.match(/\)\s*([A-Za-z\s&.]+)$/);
            if (parenMatch) {
                let symbol = parenMatch[1].trim();
                let market = 'US';
                let currency = 'USD';

                // London stock exchange
                if (symbol.endsWith(' LN')) {
                    symbol = symbol.replace(' LN', '.L');
                    market = 'UK';
                    currency = 'GBP';
                }

                // Clean up display name - get Hebrew part
                const hebrewMatch = name.match(/\(([^)]+)\)/);
                const displayName = hebrewMatch ? hebrewMatch[1] : name;

                return { symbol, displayName, market, currency };
            }

            // Pattern 2: Israeli security (no English symbol in parens)
            // Check if it's an Israeli fund/stock by the security ID format
            if (securityId && securityId.length <= 8 && !securityId.startsWith('7')) {
                // Israeli fund - use security number with .TA suffix
                return {
                    symbol: securityId + '.TA',
                    displayName: name,
                    market: 'IL',
                    currency: 'ILS'
                };
            }

            // Pattern 3: English name without parens e.g. "gamestop corp"
            const knownMappings = {
                'gamestop corp': { symbol: 'GME', displayName: 'GameStop Corp' },
                'apple inc': { symbol: 'AAPL', displayName: 'Apple Inc.' },
                'microsoft': { symbol: 'MSFT', displayName: 'Microsoft Corp' },
                'tesla': { symbol: 'TSLA', displayName: 'Tesla Inc.' },
                'nvidia': { symbol: 'NVDA', displayName: 'NVIDIA Corp' },
            };

            const nameLower = name.toLowerCase().trim();
            if (knownMappings[nameLower]) {
                return { ...knownMappings[nameLower], market: 'US', currency: 'USD' };
            }

            // Default: use security ID or name as symbol
            return {
                symbol: securityId || name.replace(/\s+/g, ''),
                displayName: name,
                market: 'US',
                currency: 'USD'
            };
        }

        // Update dropdown when page loads
        document.addEventListener('DOMContentLoaded', () => {
            populateMA150ChartDropdown();
            populateTVChartDropdown();
            loadTVChart('NASDAQ:AAPL');
        });

        // ===== TRADINGVIEW CHART =====
        function loadTVChart(symbol) {
            const container = document.getElementById('tvWidget');
            // Clear existing widget
            container.innerHTML = `
                <div class="tradingview-widget-container__widget" style="height:calc(100% - 32px);width:100%"></div>
                <div class="tradingview-widget-copyright"><a href="https://www.tradingview.com/" rel="noopener nofollow" target="_blank"><span class="blue-text">Charts</span></a><span class="trademark"> by TradingView</span></div>
            `;

            const script = document.createElement('script');
            script.type = 'text/javascript';
            script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-advanced-chart.js';
            script.async = true;
            script.textContent = JSON.stringify({
                "symbol": symbol,
                "allow_symbol_change": true,
                "calendar": false,
                "details": false,
                "hide_side_toolbar": true,
                "hide_top_toolbar": false,
                "hide_legend": false,
                "hide_volume": false,
                "hotlist": false,
                "interval": "D",
                "locale": "en",
                "save_image": true,
                "style": "1",
                "theme": "dark",
                "timezone": "Etc/UTC",
                "backgroundColor": "#0F0F0F",
                "gridColor": "rgba(242, 242, 242, 0.06)",
                "watchlist": [],
                "withdateranges": false,
                "compareSymbols": [],
                "studies": [],
                "autosize": true
            });

            container.appendChild(script);
        }

        function updateTVChart() {
            const select = document.getElementById('tvChartSelect');
            if (select.value) {
                loadTVChart(select.value);
            }
        }

        // Saved custom symbols via Storage (synced with Firebase)
        function getSavedTVSymbols() {
            return Storage.getTVCustomSymbols();
        }

        function saveTVSymbol(tvSymbol, label) {
            const saved = getSavedTVSymbols();
            if (!saved.some(s => s.tvSymbol === tvSymbol)) {
                saved.push({ tvSymbol, label });
                Storage.saveTVCustomSymbols(saved);
            }
        }

        function removeTVSymbol(tvSymbol) {
            const saved = getSavedTVSymbols().filter(s => s.tvSymbol !== tvSymbol);
            Storage.saveTVCustomSymbols(saved);
            rebuildTVDropdown();
        }

        function addCustomTVSymbol() {
            const input = document.getElementById('tvCustomSymbol');
            const symbol = input.value.trim().toUpperCase();
            if (!symbol) return;

            // Build TradingView symbol
            let tvSymbol = symbol;
            if (!symbol.includes(':')) {
                if (symbol.endsWith('.TA')) {
                    tvSymbol = 'TLV:' + symbol;
                } else {
                    tvSymbol = 'NASDAQ:' + symbol;
                }
            }

            // Save to localStorage and rebuild dropdown
            saveTVSymbol(tvSymbol, symbol);
            rebuildTVDropdown();

            const select = document.getElementById('tvChartSelect');
            select.value = tvSymbol;
            loadTVChart(tvSymbol);
            input.value = '';
        }

        function rebuildTVDropdown() {
            const select = document.getElementById('tvChartSelect');
            const currentVal = select.value;
            select.innerHTML = '';

            // Default popular stocks
            const defaults = [
                { value: 'NASDAQ:AAPL', label: 'AAPL - Apple' },
                { value: 'NASDAQ:MSFT', label: 'MSFT - Microsoft' },
                { value: 'NASDAQ:GOOGL', label: 'GOOGL - Alphabet' },
                { value: 'NASDAQ:AMZN', label: 'AMZN - Amazon' },
                { value: 'NASDAQ:NVDA', label: 'NVDA - NVIDIA' },
                { value: 'NASDAQ:TSLA', label: 'TSLA - Tesla' },
                { value: 'NASDAQ:META', label: 'META - Meta' },
                { value: 'NYSE:BRK.B', label: 'BRK.B - Berkshire' },
                { value: 'TLV:TA125.TA', label: 'TA-125 - ×ª×´× 125' },
                { value: 'TLV:TA35.TA', label: 'TA-35 - ×ª×´× 35' }
            ];
            defaults.forEach(d => {
                const opt = document.createElement('option');
                opt.value = d.value;
                opt.textContent = d.label;
                select.appendChild(opt);
            });

            const existingValues = new Set(defaults.map(d => d.value));

            // User's saved custom symbols
            const saved = getSavedTVSymbols();
            if (saved.length > 0) {
                const sep = document.createElement('option');
                sep.disabled = true;
                sep.textContent = 'â”€â”€ ×× ×™×•×ª ×©×”×•×¡×¤×ª×™ â”€â”€';
                select.appendChild(sep);

                saved.forEach(s => {
                    if (!existingValues.has(s.tvSymbol)) {
                        const opt = document.createElement('option');
                        opt.value = s.tvSymbol;
                        opt.textContent = s.label + ' âœ•';
                        select.appendChild(opt);
                        existingValues.add(s.tvSymbol);
                    }
                });
            }

            // Portfolio stocks
            const data = Storage.getStocks();
            if (data.holdings && data.holdings.length > 0) {
                const sep2 = document.createElement('option');
                sep2.disabled = true;
                sep2.textContent = 'â”€â”€ ×”×ª×™×§ ×©×œ×™ â”€â”€';
                select.appendChild(sep2);

                data.holdings.forEach(stock => {
                    const symbol = stock.symbol || '';
                    let tvSymbol = '';
                    if (stock.market === 'TASE' || symbol.endsWith('.TA')) {
                        tvSymbol = 'TLV:' + symbol.replace('.TA', '') + '.TA';
                    } else if (stock.market === 'LSE' || stock.currency === 'GBP') {
                        tvSymbol = 'LSE:' + symbol;
                    } else {
                        tvSymbol = 'NASDAQ:' + symbol;
                    }

                    if (!existingValues.has(tvSymbol)) {
                        const opt = document.createElement('option');
                        opt.value = tvSymbol;
                        opt.textContent = `${symbol} - ${stock.name || stock.displayName || symbol}`;
                        select.appendChild(opt);
                        existingValues.add(tvSymbol);
                    }
                });
            }

            // Restore selection
            if (currentVal && Array.from(select.options).some(o => o.value === currentVal)) {
                select.value = currentVal;
            }
        }

        function removeSelectedTVSymbol() {
            const select = document.getElementById('tvChartSelect');
            const tvSymbol = select.value;
            const saved = getSavedTVSymbols();
            if (saved.some(s => s.tvSymbol === tvSymbol)) {
                removeTVSymbol(tvSymbol);
                // Load first available
                if (select.options.length > 0) {
                    select.selectedIndex = 0;
                    loadTVChart(select.value);
                }
            } else {
                alert('××¤×©×¨ ×œ××—×•×§ ×¨×§ ×× ×™×•×ª ×©×”×•×¡×¤×ª ×™×“× ×™×ª');
            }
        }

        function populateTVChartDropdown() {
            rebuildTVDropdown();
        }

        // ===== Benchmark Comparison =====
        let benchmarkChart = null;
        let currentBenchmarkRange = '6mo';
        const BENCHMARK_COLORS = {
            portfolio: '#8b5cf6',
            '^GSPC': '#ef4444',
            '^IXIC': '#f59e0b',
            '^TA125.TA': '#10b981',
            '^TA35.TA': '#3b82f6',
            'URTH': '#ec4899'
        };
        const CUSTOM_COLORS = ['#06b6d4', '#a855f7', '#f97316', '#14b8a6', '#e11d48', '#84cc16'];
        const BENCHMARK_NAMES = {
            '^GSPC': 'S&P 500',
            '^IXIC': 'NASDAQ',
            '^TA125.TA': 'TA-125',
            '^TA35.TA': 'TA-35',
            'URTH': 'MSCI World'
        };

        // Custom benchmarks from localStorage
        function getCustomBenchmarks() {
            try { return JSON.parse(localStorage.getItem('finance_custom_benchmarks') || '[]'); } catch { return []; }
        }
        function saveCustomBenchmarks(list) {
            localStorage.setItem('finance_custom_benchmarks', JSON.stringify(list));
        }

        function renderCustomBenchmarkChips() {
            const container = document.getElementById('customBenchmarkChips');
            const customs = getCustomBenchmarks();
            if (customs.length === 0) { container.innerHTML = ''; return; }
            container.innerHTML = customs.map((sym, i) => `
                <div style="display: flex; align-items: center; gap: 5px; font-size: 0.9rem; background: var(--color-bg-card); border-radius: 20px; padding: 4px 10px; border: 1px solid var(--color-border);">
                    <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; margin: 0;">
                        <input type="checkbox" class="benchmark-check benchmark-custom" value="${sym}" checked onchange="loadBenchmarkChart()">
                        <span style="color: ${CUSTOM_COLORS[i % CUSTOM_COLORS.length]}; font-weight: 500;">${sym}</span>
                    </label>
                    <span onclick="removeCustomBenchmark('${sym}')" style="cursor: pointer; color: var(--color-text-secondary); font-size: 0.75rem; margin-right: 2px;" title="${I18n.t('benchmark.removeIndex')}">âœ•</span>
                </div>
            `).join('');
        }

        async function addCustomBenchmark() {
            const input = document.getElementById('customBenchmarkInput');
            const btn = input.nextElementSibling;
            const symbol = input.value.trim().toUpperCase();
            if (!symbol) return;
            const customs = getCustomBenchmarks();
            // Check not already in hardcoded or custom list
            const allExisting = ['^GSPC', '^IXIC', '^TA125.TA', '^TA35.TA', 'URTH', ...customs];
            if (allExisting.includes(symbol)) { input.value = ''; return; }
            // Validate ticker exists before adding
            btn.disabled = true;
            input.disabled = true;
            try {
                const result = await StockAPI.fetchBenchmarkData(symbol, '1mo');
                if (!result.success || !result.historicalData || result.historicalData.length === 0) {
                    input.style.borderColor = 'var(--color-negative)';
                    input.placeholder = I18n.t('benchmark.tickerNotFound');
                    setTimeout(() => {
                        input.style.borderColor = '';
                        input.placeholder = I18n.t('benchmark.searchSymbol');
                    }, 2000);
                    return;
                }
                // Cache the validated data for the current range too
                setCachedBenchmark(symbol, '1mo', result);
                customs.push(symbol);
                saveCustomBenchmarks(customs);
                input.value = '';
                renderCustomBenchmarkChips();
                loadBenchmarkChart();
            } catch {
                input.style.borderColor = 'var(--color-negative)';
                setTimeout(() => { input.style.borderColor = ''; }, 2000);
            } finally {
                btn.disabled = false;
                input.disabled = false;
            }
        }

        function removeCustomBenchmark(symbol) {
            const customs = getCustomBenchmarks().filter(s => s !== symbol);
            saveCustomBenchmarks(customs);
            // Clear its cache
            Object.keys(sessionStorage).forEach(k => { if (k.startsWith('benchmark_' + symbol + '_')) sessionStorage.removeItem(k); });
            renderCustomBenchmarkChips();
            loadBenchmarkChart();
        }

        // Populate the compare target dropdown with portfolio holdings
        function populateBenchmarkTargetSelect() {
            const select = document.getElementById('benchmarkTargetSelect');
            const stockData = Storage.getStocks();
            const holdings = stockData.holdings || [];
            // Keep current selection
            const currentVal = select.value;
            // Clear all except first (portfolio)
            while (select.options.length > 1) select.remove(1);
            // Add each holding
            holdings.forEach(h => {
                const opt = document.createElement('option');
                opt.value = h.symbol;
                opt.textContent = `${h.symbol} (${h.name || h.symbol})`;
                select.appendChild(opt);
            });
            // Add "custom ticker" option
            const customOpt = document.createElement('option');
            customOpt.value = '__custom__';
            customOpt.textContent = I18n.t('benchmark.customTicker');
            select.appendChild(customOpt);
            // Restore selection if still valid
            if ([...select.options].some(o => o.value === currentVal)) {
                select.value = currentVal;
            }
            onBenchmarkTargetChange();
        }

        function onBenchmarkTargetChange() {
            const select = document.getElementById('benchmarkTargetSelect');
            const customInput = document.getElementById('customTickerInput');
            customInput.style.display = select.value === '__custom__' ? '' : 'none';
            if (select.value !== '__custom__') {
                loadBenchmarkChart();
            } else {
                customInput.focus();
            }
        }

        function getCompareTarget() {
            const select = document.getElementById('benchmarkTargetSelect');
            if (select.value === '__custom__') {
                const ticker = document.getElementById('customTickerInput').value.trim().toUpperCase();
                return ticker ? { type: 'ticker', symbol: ticker } : { type: 'portfolio' };
            }
            if (select.value === 'portfolio') return { type: 'portfolio' };
            return { type: 'ticker', symbol: select.value };
        }

        function setBenchmarkPeriod(range) {
            currentBenchmarkRange = range;
            document.querySelectorAll('.benchmark-period').forEach(btn => {
                btn.style.background = btn.dataset.range === range ? 'var(--color-stocks)' : '';
                btn.classList.toggle('active', btn.dataset.range === range);
            });
            loadBenchmarkChart();
        }

        // Build portfolio time-series from transaction history
        function buildPortfolioTimeSeries(referenceDates, stockData) {
            const transactions = (stockData.transactions || [])
                .filter(t => t.date)
                .sort((a, b) => a.date.localeCompare(b.date));
            const holdings = stockData.holdings || [];

            // Current portfolio totals
            const totalCost = holdings.reduce((sum, h) => {
                const rate = h.currency === 'ILS' ? 1 : (currencyRates[h.currency] || currencyRates.USD || 3.65);
                return sum + ((h.avgPrice || 0) * (h.quantity || 0) * rate);
            }, 0);
            const totalValue = holdings.reduce((sum, h) => {
                if (h.valueILS && h.valueILS > 0) return sum + h.valueILS;
                const price = h.currentPrice || h.avgPrice || 0;
                const rate = h.currency === 'ILS' ? 1 : (currencyRates[h.currency] || currencyRates.USD || 3.65);
                return sum + (price * (h.quantity || 0) * rate);
            }, 0);

            if (totalCost <= 0) return { series: referenceDates.map(() => 0), finalReturn: 0 };

            const currentReturn = ((totalValue / totalCost) - 1); // as fraction
            const today = new Date().toISOString().split('T')[0];
            const periodStart = referenceDates.length > 0 ? new Date(referenceDates[0]).toISOString().split('T')[0] : today;

            // Build cumulative invested capital at each date
            // For each date, track how much was invested cumulatively
            let cumulativeInvested = 0;
            const investedByDate = []; // [{date, cumInvested}]
            for (const tx of transactions) {
                if (tx.type === 'buy') {
                    cumulativeInvested += (tx.price || 0) * (tx.quantity || 0);
                } else if (tx.type === 'sell') {
                    cumulativeInvested -= (tx.price || 0) * (tx.quantity || 0);
                    if (cumulativeInvested < 0) cumulativeInvested = 0;
                }
                investedByDate.push({ date: tx.date, cumInvested: cumulativeInvested });
            }

            // For each reference date, find cumulative invested at that point
            // Then calculate proportional return
            const series = [];
            const finalCumInvested = totalCost; // total cost basis of current holdings
            let txIdx = 0;
            let investedAtDate = 0;

            for (const refDate of referenceDates) {
                const refDateStr = new Date(refDate).toISOString().split('T')[0];

                // Advance through transactions up to this date
                while (txIdx < investedByDate.length && investedByDate[txIdx].date <= refDateStr) {
                    investedAtDate = investedByDate[txIdx].cumInvested;
                    txIdx++;
                }

                // If before any transactions, portfolio return is 0
                if (investedAtDate <= 0) {
                    series.push(0);
                    continue;
                }

                // Proportion of current portfolio that was invested by this date
                const investedFraction = Math.min(investedAtDate / finalCumInvested, 1);

                // Interpolate: early on, return is closer to 0; by today, it equals currentReturn
                // Time progress through the period
                const periodStartMs = new Date(periodStart).getTime();
                const todayMs = new Date(today).getTime();
                const refMs = new Date(refDate).getTime();
                const timeProgress = todayMs > periodStartMs ? Math.min((refMs - periodStartMs) / (todayMs - periodStartMs), 1) : 1;

                // Portfolio return at this point: scales with both invested fraction and time
                const returnAtDate = currentReturn * investedFraction * timeProgress * 100;
                series.push(returnAtDate);
            }

            return { series, finalReturn: currentReturn * 100 };
        }

        // Load guard to prevent race conditions between concurrent calls
        let benchmarkLoadId = 0;

        // Benchmark cache helpers
        function getCachedBenchmark(symbol, range) {
            try {
                const cached = sessionStorage.getItem('benchmark_' + symbol + '_' + range);
                if (!cached) return null;
                const data = JSON.parse(cached);
                // Restore Date objects from serialized strings
                if (data.historicalData) {
                    data.historicalData = data.historicalData.map(d => ({
                        ...d,
                        date: new Date(d.date)
                    }));
                }
                return data;
            } catch { return null; }
        }
        function setCachedBenchmark(symbol, range, data) {
            try { sessionStorage.setItem('benchmark_' + symbol + '_' + range, JSON.stringify(data)); } catch {}
        }

        async function loadBenchmarkChart() {
            const thisLoadId = ++benchmarkLoadId;

            const hardcodedChecked = Array.from(document.querySelectorAll('.benchmark-check:not(.benchmark-custom):checked')).map(cb => cb.value);
            const customChecked = Array.from(document.querySelectorAll('.benchmark-custom:checked')).map(cb => cb.value);
            const selectedBenchmarks = [...hardcodedChecked, ...customChecked];

            const loadingEl = document.getElementById('benchmarkLoading');
            const statsEl = document.getElementById('benchmarkStats');
            const statsGrid = document.getElementById('benchmarkStatsGrid');

            const compareTarget = getCompareTarget();
            const stockData = Storage.getStocks();

            // Need holdings for portfolio mode, or at least benchmarks for ticker mode
            if (compareTarget.type === 'portfolio' && stockData.holdings.length === 0) {
                statsGrid.innerHTML = `<div style="color: var(--color-text-secondary);">${I18n.t('benchmark.noData')}</div>`;
                statsEl.style.display = '';
                if (benchmarkChart) { benchmarkChart.destroy(); benchmarkChart = null; }
                return;
            }

            loadingEl.style.display = '';

            try {
                // If comparing a specific ticker, fetch its data too
                let targetData = null;
                if (compareTarget.type === 'ticker') {
                    const cached = getCachedBenchmark(compareTarget.symbol, currentBenchmarkRange);
                    if (cached) {
                        targetData = cached;
                    } else {
                        targetData = await StockAPI.fetchBenchmarkData(compareTarget.symbol, currentBenchmarkRange);
                        if (targetData.success) setCachedBenchmark(compareTarget.symbol, currentBenchmarkRange, targetData);
                    }
                    if (!targetData.success || !targetData.historicalData || targetData.historicalData.length === 0) {
                        loadingEl.style.display = 'none';
                        statsGrid.innerHTML = `<div style="color: var(--color-negative);">âš  ${compareTarget.symbol} â€” ${I18n.t('benchmark.tickerNotFound')}</div>`;
                        statsEl.style.display = '';
                        return;
                    }
                }

                // Fetch benchmark data (with caching)
                const benchmarkPromises = selectedBenchmarks.map(async sym => {
                    const cached = getCachedBenchmark(sym, currentBenchmarkRange);
                    if (cached) return cached;
                    const result = await StockAPI.fetchBenchmarkData(sym, currentBenchmarkRange);
                    if (result.success) setCachedBenchmark(sym, currentBenchmarkRange, result);
                    return result;
                });
                const benchmarkResults = await Promise.all(benchmarkPromises);

                // If a newer load was triggered while we were fetching, abort this one
                if (thisLoadId !== benchmarkLoadId) return;

                // Use the benchmark with the most data points as the date reference
                let referenceDates = [];
                const validBenchmarks = benchmarkResults.filter(b => b.success && b.historicalData.length > 0);

                // Track failed custom benchmarks
                const failedCustoms = [];
                benchmarkResults.forEach((r, i) => {
                    if (!r.success && customChecked.includes(selectedBenchmarks[i])) {
                        failedCustoms.push(selectedBenchmarks[i]);
                    }
                });

                // For reference dates, also consider the target ticker data
                const allDataSources = [...validBenchmarks];
                if (targetData && targetData.success) allDataSources.push(targetData);

                if (allDataSources.length > 0) {
                    const longestSource = allDataSources.reduce((a, b) =>
                        a.historicalData.length > b.historicalData.length ? a : b
                    );
                    referenceDates = longestSource.historicalData.map(d => d.date);
                }

                if (referenceDates.length === 0) {
                    loadingEl.style.display = 'none';
                    statsGrid.innerHTML = `<div style="color: var(--color-text-secondary);">${I18n.t('benchmark.noData')}</div>`;
                    statsEl.style.display = '';
                    return;
                }

                // Build the main comparison line
                let mainSeries, mainReturn, mainLabel;

                if (compareTarget.type === 'ticker' && targetData && targetData.success) {
                    // Specific ticker: use its real historical prices
                    const startPrice = targetData.historicalData[0].close;
                    const tickerReturns = targetData.historicalData.map(d => ((d.close / startPrice) - 1) * 100);
                    mainReturn = tickerReturns[tickerReturns.length - 1] || 0;
                    mainLabel = compareTarget.symbol;

                    // Align to reference dates
                    mainSeries = [];
                    let tIdx = 0;
                    for (let i = 0; i < referenceDates.length; i++) {
                        while (tIdx < targetData.historicalData.length - 1 && targetData.historicalData[tIdx].date < referenceDates[i]) {
                            tIdx++;
                        }
                        mainSeries.push(tIdx < tickerReturns.length ? tickerReturns[tIdx] : tickerReturns[tickerReturns.length - 1]);
                    }
                } else {
                    // Whole portfolio
                    const result = buildPortfolioTimeSeries(referenceDates, stockData);
                    mainSeries = result.series;
                    mainReturn = result.finalReturn;
                    mainLabel = I18n.t('benchmark.yourPortfolio');
                }

                // Build chart datasets
                const datasets = [];
                const labels = referenceDates.map(d => {
                    const date = new Date(d);
                    return `${date.getDate()}/${date.getMonth() + 1}`;
                });

                // Main comparison line
                datasets.push({
                    label: mainLabel,
                    data: mainSeries,
                    borderColor: BENCHMARK_COLORS.portfolio,
                    backgroundColor: 'rgba(139, 92, 246, 0.08)',
                    fill: true,
                    borderWidth: 3,
                    pointRadius: 0,
                    tension: 0.3
                });

                // Benchmark lines
                const benchmarkReturns = {};
                const customs = getCustomBenchmarks();
                for (const bm of validBenchmarks) {
                    if (!selectedBenchmarks.includes(bm.symbol)) continue;
                    const startPrice = bm.historicalData[0].close;
                    const returns = bm.historicalData.map(d => ((d.close / startPrice) - 1) * 100);
                    const endReturn = returns[returns.length - 1] || 0;
                    benchmarkReturns[bm.symbol] = endReturn;

                    // Align to reference dates length
                    const alignedReturns = [];
                    let bmIdx = 0;
                    for (let i = 0; i < referenceDates.length; i++) {
                        while (bmIdx < bm.historicalData.length - 1 && bm.historicalData[bmIdx].date < referenceDates[i]) {
                            bmIdx++;
                        }
                        alignedReturns.push(bmIdx < returns.length ? returns[bmIdx] : returns[returns.length - 1]);
                    }

                    // Determine color
                    const customIdx = customs.indexOf(bm.symbol);
                    const color = BENCHMARK_COLORS[bm.symbol] || CUSTOM_COLORS[customIdx % CUSTOM_COLORS.length] || '#888';

                    datasets.push({
                        label: BENCHMARK_NAMES[bm.symbol] || bm.symbol,
                        data: alignedReturns,
                        borderColor: color,
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        pointRadius: 0,
                        tension: 0.1
                    });
                }

                // Render chart
                const ctx = document.getElementById('benchmarkChart').getContext('2d');
                if (benchmarkChart) benchmarkChart.destroy();
                benchmarkChart = new Chart(ctx, {
                    type: 'line',
                    data: { labels, datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        plugins: {
                            legend: { labels: { color: '#8892b0', usePointStyle: true } },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.dataset.label}: ${context.parsed.y.toFixed(2)}%`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                ticks: { color: '#8892b0', maxTicksLimit: 12 },
                                grid: { color: 'rgba(255,255,255,0.05)' }
                            },
                            y: {
                                ticks: {
                                    color: '#8892b0',
                                    callback: v => v.toFixed(1) + '%'
                                },
                                grid: { color: 'rgba(255,255,255,0.05)' }
                            }
                        }
                    }
                });

                // Stats
                statsGrid.innerHTML = '';
                const addStat = (label, value, color, sublabel) => {
                    const sign = value >= 0 ? '+' : '';
                    statsGrid.innerHTML += `
                        <div style="text-align: center; padding: 10px 15px; background: var(--color-bg-card); border-radius: 10px; min-width: 120px;">
                            <div style="font-size: 0.8rem; color: var(--color-text-secondary); margin-bottom: 4px;">${label}</div>
                            <div style="font-size: 1.1rem; font-weight: 600; color: ${color};">${sign}${value.toFixed(1)}%</div>
                            ${sublabel ? `<div style="font-size: 0.7rem; color: var(--color-text-secondary); margin-top: 2px;">${sublabel}</div>` : ''}
                        </div>`;
                };

                // Annualized return helper
                const isLongPeriod = currentBenchmarkRange === '1y' || currentBenchmarkRange === '5y';
                const periodYears = { '1mo': 1/12, '3mo': 0.25, '6mo': 0.5, '1y': 1, '5y': 5 };
                const years = periodYears[currentBenchmarkRange] || 1;

                const annualize = (ret, yrs) => {
                    if (yrs <= 0 || yrs < 1) return null;
                    const growth = 1 + ret / 100;
                    if (growth <= 0) return null;
                    return (Math.pow(growth, 1 / yrs) - 1) * 100;
                };

                const annualMain = annualize(mainReturn, years);
                const annualSublabel = isLongPeriod && annualMain !== null ? `${I18n.t('benchmark.annualReturn')}: ${annualMain >= 0 ? '+' : ''}${annualMain.toFixed(1)}%` : '';
                addStat(mainLabel, mainReturn, mainReturn >= 0 ? 'var(--color-positive)' : 'var(--color-negative)', annualSublabel);

                for (const [sym, ret] of Object.entries(benchmarkReturns)) {
                    const annualBm = annualize(ret, years);
                    const bmSublabel = isLongPeriod && annualBm !== null ? `${I18n.t('benchmark.annualReturn')}: ${annualBm >= 0 ? '+' : ''}${annualBm.toFixed(1)}%` : '';
                    addStat(BENCHMARK_NAMES[sym] || sym, ret, ret >= 0 ? 'var(--color-positive)' : 'var(--color-negative)', bmSublabel);
                }

                // Alpha (difference with first selected benchmark)
                const firstBmSym = selectedBenchmarks[0];
                if (firstBmSym && benchmarkReturns[firstBmSym] !== undefined) {
                    const alpha = mainReturn - benchmarkReturns[firstBmSym];
                    addStat(`${I18n.t('benchmark.alpha')} (${BENCHMARK_NAMES[firstBmSym] || firstBmSym})`, alpha, alpha >= 0 ? 'var(--color-positive)' : 'var(--color-negative)');
                }

                // Warn about failed custom symbols
                if (failedCustoms.length > 0) {
                    statsGrid.innerHTML += `<div style="font-size: 0.8rem; color: var(--color-negative); width: 100%; text-align: center; margin-top: 5px;">âš  ${failedCustoms.join(', ')} â€” ${I18n.t('benchmark.noData')}</div>`;
                }

                statsEl.style.display = '';
            } catch (e) {
                console.error('Benchmark error:', e);
                statsGrid.innerHTML = `<div style="color: var(--color-negative);">${I18n.t('benchmark.noData')}</div>`;
                statsEl.style.display = '';
            } finally {
                loadingEl.style.display = 'none';
            }
        }

        // Auto-load benchmark on page load (after stocks load)
        document.addEventListener('DOMContentLoaded', () => {
            renderCustomBenchmarkChips();
            setTimeout(() => {
                populateBenchmarkTargetSelect();
                loadBenchmarkChart();
            }, 2000);
        });
    </script>
</body>
</html>
