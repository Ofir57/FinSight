<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="../img/logo.png">
    <meta name="theme-color" content="#ef4444">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://www.gstatic.com https://apis.google.com; style-src 'self' 'unsafe-inline'; img-src 'self' https: data:; connect-src 'self' https://*.googleapis.com https://*.firebaseio.com https://*.firebaseapp.com wss://*.firebaseio.com https://api.allorigins.win https://corsproxy.io https://api.codetabs.com https://api.exchangerate-api.com; frame-src https://accounts.google.com https://*.firebaseapp.com; object-src 'none'; base-uri 'self'; form-action 'self' https://accounts.google.com;">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <link rel="manifest" href="../manifest.json">
    <link rel="icon" type="image/png" href="../img/logo.png">
    <title>×›×¨×˜×™×¡×™ ××©×¨××™ - FinSight</title>
    <link rel="stylesheet" href="../css/app.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        .nav-link.active { background: var(--color-credit) !important; }
        .page-header h1 { color: var(--color-credit); }
        .btn-primary { background: var(--color-credit); }
        .btn-primary:hover { background: #dc2626; }
        .card-chip {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(135deg, #1a1a2e, #2d2d44);
            padding: 15px 20px;
            border-radius: 12px;
            margin: 10px;
            border: 1px solid var(--color-border);
        }
        .card-chip .number {
            font-family: monospace;
            font-size: 1.1rem;
            letter-spacing: 2px;
        }
        .month-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        .month-selector select {
            padding: 8px 15px;
            background: var(--color-bg-card);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            color: white;
            font-size: 1rem;
        }
        .search-filter {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        .search-filter input {
            padding: 8px 15px;
            background: var(--color-bg-card);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            color: white;
            min-width: 200px;
        }
        .search-filter select {
            padding: 8px 15px;
            background: var(--color-bg-card);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            color: white;
        }
        .alert {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
        }
        .alert-warning {
            background: rgba(245, 158, 11, 0.2);
            border: 1px solid #f59e0b;
        }
        .alert-danger {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid #ef4444;
        }
        .alert-icon { font-size: 1.5rem; }
        .alert-content strong { display: block; margin-bottom: 3px; }
        .budget-progress {
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            height: 8px;
            margin-top: 10px;
            overflow: hidden;
        }
        .budget-progress-bar {
            height: 100%;
            border-radius: 8px;
            transition: width 0.3s;
        }
        /* Recurring Expenses Section */
        .recurring-section {
            margin-bottom: 20px;
        }
        .recurring-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            padding: 15px 20px;
            background: var(--color-bg-card);
            border: 1px solid var(--color-border);
            border-radius: 12px;
            transition: background 0.2s;
        }
        .recurring-toggle:hover {
            background: var(--color-bg-hover);
        }
        .recurring-toggle-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .recurring-toggle .arrow {
            transition: transform 0.3s;
            font-size: 0.8rem;
            color: var(--color-text-secondary);
        }
        .recurring-toggle.open .arrow {
            transform: rotate(180deg);
        }
        .recurring-total-badge {
            background: var(--color-credit);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        .recurring-body {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        .recurring-body.open {
            max-height: 2000px;
        }
        .recurring-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 12px;
            padding: 15px 0;
        }
        .recurring-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            background: var(--color-bg-card);
            border: 1px solid var(--color-border);
            border-radius: 10px;
            transition: border-color 0.2s;
        }
        .recurring-card:hover {
            border-color: var(--color-credit);
        }
        .recurring-card.upcoming {
            border-color: #f59e0b;
            background: rgba(245, 158, 11, 0.05);
        }
        .recurring-card-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
        }
        .recurring-card-info {
            flex: 1;
            min-width: 0;
        }
        .recurring-card-name {
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .recurring-card-meta {
            font-size: 0.8rem;
            color: var(--color-text-secondary);
            margin-top: 2px;
        }
        .recurring-card-amount {
            font-weight: 700;
            color: var(--color-credit);
            white-space: nowrap;
        }
        .recurring-card-actions {
            display: flex;
            gap: 4px;
        }
        .recurring-card-actions button {
            padding: 4px 6px;
            font-size: 0.75rem;
        }
        .recurring-fields {
            display: none;
            gap: 10px;
            margin-top: 10px;
        }
        .recurring-fields.visible {
            display: grid;
            grid-template-columns: 1fr 1fr;
        }
        .recurring-fields .form-group {
            margin-bottom: 0;
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar Navigation -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="brand">
                    <img src="../img/logo.png" class="brand-icon" alt="FinSight">
                    <span class="brand-name">Fin<span class="brand-highlight">Sight</span></span>
                </div>
            </div>

            <nav>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a href="../index.html" class="nav-link" data-category="dashboard">
                            <span class="icon">ğŸ </span>
                            <span data-i18n="nav.dashboard">×“××©×‘×•×¨×“</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="bank.html" class="nav-link" data-category="bank">
                            <span class="icon">ğŸ¦</span>
                            <span data-i18n="nav.bankAccounts">×—×©×‘×•× ×•×ª ×‘× ×§</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="credit.html" class="nav-link active" data-category="credit">
                            <span class="icon">ğŸ’³</span>
                            <span data-i18n="nav.creditCards">×›×¨×˜×™×¡×™ ××©×¨××™</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="stocks.html" class="nav-link" data-category="stocks">
                            <span class="icon">ğŸ“ˆ</span>
                            <span data-i18n="nav.stocks">×× ×™×•×ª</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <span class="nav-link" style="cursor: default;">
                            <span class="icon">ğŸ“Š</span>
                            <span data-i18n="nav.financialProducts">××•×¦×¨×™× ×¤×™× × ×¡×™×™×</span>
                        </span>
                        <ul class="nav-submenu">
                            <li class="nav-item"><a href="market-products.html" class="nav-link" data-category="market-products"><span data-i18n="nav.marketProducts">ğŸª ××•×¦×¨×™× ×‘×©×•×§</span></a></li>
                            <li class="nav-item"><a href="my-funds.html" class="nav-link" data-category="my-products"><span data-i18n="nav.myProducts">ğŸ’ ×”×—×¡×›×•× ×•×ª ×©×œ×™</span></a></li>
                        </ul>
                    </li>
                    <li class="nav-item">
                        <a href="assets.html" class="nav-link" data-category="assets">
                            <span class="icon">ğŸ </span>
                            <span data-i18n="nav.assets">× ×›×¡×™×</span>
                        </a>
                    </li>
                    <li class="nav-item"><a href="loans.html" class="nav-link" data-category="loans"><span class="icon">ğŸ¦</span><span data-i18n="nav.loans">×”×œ×•×•××•×ª</span></a></li>
                    <li class="nav-item">
                        <a href="goals.html" class="nav-link" data-category="goals">
                            <span class="icon">ğŸ¯</span>
                            <span data-i18n="nav.goals">×™×¢×“×™ ×—×™×¡×›×•×Ÿ</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="pension-calc.html" class="nav-link" data-category="pension-calc">
                            <span class="icon">ğŸ§®</span>
                            <span data-i18n="nav.pensionCalc">××—×©×‘×•×Ÿ ×¤× ×¡×™×”</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="reports.html" class="nav-link" data-category="reports">
                            <span class="icon">ğŸ“‹</span>
                            <span data-i18n="nav.reports">×“×•×—×•×ª</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="profile.html" class="nav-link">
                            <span class="icon">ğŸ‘¤</span>
                            <span data-i18n="nav.profile">×¤×¨×•×¤×™×œ ×¤×™× × ×¡×™</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="settings.html" class="nav-link" data-category="settings">
                            <span class="icon">âš™ï¸</span>
                            <span data-i18n="nav.settings">×”×’×“×¨×•×ª</span>
                        </a>
                    </li>
                </ul>
            </nav>

            <div class="sidebar-footer">
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="logo-hero">
                <img src="../img/logo.png" alt="FinSight" class="logo-hero-img">
            </div>
            <header class="page-header">
                <h1>
                    <span>ğŸ’³</span>
                    <span data-i18n="credit.title">×›×¨×˜×™×¡×™ ××©×¨××™</span>
                </h1>
            </header>

            <!-- Budget Alerts -->
            <div id="budgetAlerts"></div>

            <!-- Monthly Total with Budget Progress -->
            <div class="net-worth-banner" style="border-color: var(--color-credit);">
                <div class="label" data-i18n="credit.monthlyTotal">×¡×”×´×› ×—×•×“×©×™</div>
                <div class="value" id="monthlyTotal" style="background: linear-gradient(90deg, var(--color-credit), #f87171); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">â‚ª0</div>
                <div id="budgetProgressContainer" style="display: none; width: 100%; max-width: 400px; margin-top: 15px;">
                    <div style="display: flex; justify-content: space-between; font-size: 0.85rem; color: var(--color-text-secondary);">
                        <span id="budgetSpent">â‚ª0</span>
                        <span id="budgetLimit"></span>
                    </div>
                    <div class="budget-progress">
                        <div class="budget-progress-bar" id="budgetProgressBar" style="width: 0%; background: var(--color-credit);"></div>
                    </div>
                </div>
            </div>

            <!-- Cards Section -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <span class="icon">ğŸ’³</span>
                        <span data-i18n="credit.title">×›×¨×˜×™×¡×™ ××©×¨××™</span>
                    </h2>
                    <button class="btn btn-primary btn-sm" onclick="openCardModal()">
                        <span>â•</span>
                        <span data-i18n="credit.addCard">×”×•×¡×£ ×›×¨×˜×™×¡</span>
                    </button>
                </div>
                <div id="cardsContainer">
                    <!-- Cards will be populated here -->
                </div>
            </div>

            <!-- Recurring Expenses Section -->
            <div class="recurring-section" id="recurringSection">
                <div class="recurring-toggle" onclick="toggleRecurringSection()">
                    <div class="recurring-toggle-right">
                        <span>ğŸ”„</span>
                        <strong data-i18n="credit.recurringExpenses">×”×•×¦××•×ª ×§×‘×•×¢×•×ª</strong>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span class="recurring-total-badge" id="recurringTotalBadge">â‚ª0</span>
                        <span class="arrow">â–¼</span>
                    </div>
                </div>
                <div class="recurring-body" id="recurringBody">
                    <div class="recurring-grid" id="recurringGrid">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <!-- Expenses Section -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <span class="icon">ğŸ“‹</span>
                        <span data-i18n="credit.expenses">×”×•×¦××•×ª</span>
                    </h2>
                    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                        <button class="btn btn-primary btn-sm" onclick="openExpenseModal()">
                            <span>â•</span>
                            <span data-i18n="credit.addExpense">×”×•×¡×£ ×”×•×¦××”</span>
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="document.getElementById('smartImportInput').click()">
                            <span>ğŸ“¥</span>
                            <span data-i18n="credit.smartImport">×™×™×‘×•× × ×ª×•× ×™×</span>
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="ImageImport.openImagePicker('credit')">
                            <span>ğŸ“·</span>
                            <span data-i18n="credit.importImage">×™×™×‘×•× ××ª××•× ×”</span>
                        </button>
                        <input type="file" id="smartImportInput" accept=".xlsx,.xls,.csv" style="display: none;" onchange="smartImportFile(event)">
                        <button class="btn btn-danger btn-sm" onclick="deleteAllExpenses()">
                            <span>ğŸ—‘ï¸</span>
                            <span data-i18n="credit.deleteAll">××—×§ ×”×›×œ</span>
                        </button>
                    </div>
                </div>
                <!-- Search and Filter -->
                <div class="search-filter" style="margin-top: 15px;">
                    <select id="monthFilter" onchange="loadExpenses()">
                        <!-- Will be populated by JS -->
                    </select>
                    <select id="categoryFilter" onchange="loadExpenses()">
                        <option value="" data-i18n="credit.allCategories">×›×œ ×”×§×˜×’×•×¨×™×•×ª</option>
                        <option value="food" data-i18n="credit.categories.food">××–×•×Ÿ ×•××¡×¢×“×•×ª</option>
                        <option value="transport" data-i18n="credit.categories.transport">×ª×—×‘×•×¨×” ×•×“×œ×§</option>
                        <option value="shopping" data-i18n="credit.categories.shopping">×§× ×™×•×ª</option>
                        <option value="entertainment" data-i18n="credit.categories.entertainment">×‘×™×œ×•×™×™×</option>
                        <option value="bills" data-i18n="credit.categories.bills">×—×©×‘×•× ×•×ª ×§×‘×•×¢×™×</option>
                        <option value="health" data-i18n="credit.categories.health">×‘×¨×™××•×ª</option>
                        <option value="education" data-i18n="credit.categories.education">×—×™× ×•×š</option>
                        <option value="other" data-i18n="credit.categories.other">××—×¨</option>
                    </select>
                    <input type="text" id="searchFilter" placeholder="ğŸ” ×—×™×¤×•×© ×œ×¤×™ ×ª×™××•×¨..." data-i18n-placeholder="credit.searchByDesc" oninput="loadExpenses()">
                    <button class="btn btn-secondary btn-sm" onclick="clearFilters()" data-i18n="credit.clearFilter">× ×§×” ×¡×™× ×•×Ÿ</button>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th data-i18n="credit.expenseDate">×ª××¨×™×š</th>
                                <th data-i18n="credit.expenseCategory">×§×˜×’×•×¨×™×”</th>
                                <th data-i18n="credit.expenseDescription">×ª×™××•×¨</th>
                                <th data-i18n="credit.source">××§×•×¨</th>
                                <th data-i18n="credit.expenseAmount">×¡×›×•×</th>
                                <th data-i18n="common.actions">×¤×¢×•×œ×•×ª</th>
                            </tr>
                        </thead>
                        <tbody id="expensesTable">
                            <!-- Will be populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Charts -->
            <div class="charts-grid">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <span class="icon">ğŸ“Š</span>
                            <span data-i18n="credit.categoryBreakdown">×—×œ×•×§×” ×œ×¤×™ ×§×˜×’×•×¨×™×•×ª</span>
                        </h2>
                    </div>
                    <div class="chart-container">
                        <canvas id="categoryChart"></canvas>
                    </div>
                    <div id="categoryBreakdown" style="padding: 15px; border-top: 1px solid var(--color-border);"></div>
                </div>
            </div>
        </main>

        <!-- Mobile Menu Toggle -->
        <button class="mobile-menu-toggle">â˜°</button>
    </div>

    <!-- Add Card Modal -->
    <div class="modal-overlay" id="cardModal">
        <div class="modal">
            <div class="modal-header">
                <h2 data-i18n="credit.addCard">×”×•×¡×£ ×›×¨×˜×™×¡</h2>
                <button class="modal-close" onclick="closeCardModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="cardForm">
                    <input type="hidden" id="cardId">
                    <div class="form-group">
                        <label data-i18n="credit.cardName">×©× ×”×›×¨×˜×™×¡</label>
                        <input type="text" class="form-control" id="cardName" required placeholder="×•×™×–×” ×›××œ">
                    </div>
                    <div class="form-group">
                        <label data-i18n="credit.lastFour">4 ×¡×¤×¨×•×ª ××—×¨×•× ×•×ª</label>
                        <input type="text" class="form-control" id="lastFour" maxlength="4" pattern="[0-9]{4}" required>
                    </div>
                    <div class="form-group">
                        <label data-i18n="credit.creditLimit">××¡×’×¨×ª ××©×¨××™</label>
                        <input type="number" class="form-control" id="creditLimit" step="100">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeCardModal()" data-i18n="common.cancel">×‘×™×˜×•×œ</button>
                <button class="btn btn-primary" onclick="saveCard()" data-i18n="common.save">×©××•×¨</button>
            </div>
        </div>
    </div>

    <!-- Add Expense Modal -->
    <div class="modal-overlay" id="expenseModal">
        <div class="modal">
            <div class="modal-header">
                <h2 data-i18n="credit.addExpense">×”×•×¡×£ ×”×•×¦××”</h2>
                <button class="modal-close" onclick="closeExpenseModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="expenseForm">
                    <input type="hidden" id="expenseId">
                    <div class="form-group">
                        <label data-i18n="credit.card">×›×¨×˜×™×¡</label>
                        <select class="form-control" id="expenseCard" required>
                            <!-- Will be populated by JS -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label data-i18n="credit.expenseDate">×ª××¨×™×š</label>
                        <input type="date" class="form-control" id="expenseDate" required>
                    </div>
                    <div class="form-group">
                        <label data-i18n="credit.expenseAmount">×¡×›×•×</label>
                        <input type="number" class="form-control" id="expenseAmount" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label data-i18n="credit.expenseCategory">×§×˜×’×•×¨×™×”</label>
                        <select class="form-control" id="expenseCategory" required>
                            <option value="food" data-i18n="credit.categories.food">××–×•×Ÿ ×•××¡×¢×“×•×ª</option>
                            <option value="transport" data-i18n="credit.categories.transport">×ª×—×‘×•×¨×” ×•×“×œ×§</option>
                            <option value="shopping" data-i18n="credit.categories.shopping">×§× ×™×•×ª</option>
                            <option value="entertainment" data-i18n="credit.categories.entertainment">×‘×™×œ×•×™×™×</option>
                            <option value="bills" data-i18n="credit.categories.bills">×—×©×‘×•× ×•×ª ×§×‘×•×¢×™×</option>
                            <option value="health" data-i18n="credit.categories.health">×‘×¨×™××•×ª</option>
                            <option value="education" data-i18n="credit.categories.education">×—×™× ×•×š</option>
                            <option value="other" data-i18n="credit.categories.other">××—×¨</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label data-i18n="credit.expenseDescription">×ª×™××•×¨</label>
                        <input type="text" class="form-control" id="expenseDescription">
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="isRecurring" onchange="toggleRecurringFields()">
                            <span data-i18n="credit.recurring">×”×•×¦××” ×§×‘×•×¢×”</span>
                        </label>
                    </div>
                    <div class="recurring-fields" id="recurringFields">
                        <div class="form-group">
                            <label data-i18n="credit.frequency">×ª×“×™×¨×•×ª</label>
                            <select class="form-control" id="recurringFrequency">
                                <option value="monthly" data-i18n="credit.monthly">×—×•×“×©×™</option>
                                <option value="weekly" data-i18n="credit.weekly">×©×‘×•×¢×™</option>
                                <option value="biweekly" data-i18n="credit.biweekly">×“×•-×©×‘×•×¢×™</option>
                                <option value="bimonthly" data-i18n="credit.bimonthly">×“×•-×—×•×“×©×™</option>
                                <option value="quarterly" data-i18n="credit.quarterly">×¨×‘×¢×•× ×™</option>
                                <option value="annually" data-i18n="credit.annually">×©× ×ª×™</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label data-i18n="credit.chargeDay">×™×•× ×—×™×•×‘</label>
                            <input type="number" class="form-control" id="recurringDay" min="1" max="31" placeholder="1-31">
                        </div>
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label data-i18n="credit.endDate">×ª××¨×™×š ×¡×™×•×</label>
                            <input type="date" class="form-control" id="recurringEndDate">
                            <small style="color: var(--color-text-secondary);" data-i18n="credit.ongoing">×œ×œ× ×”×’×‘×œ×”</small>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeExpenseModal()" data-i18n="common.cancel">×‘×™×˜×•×œ</button>
                <button class="btn btn-primary" onclick="saveExpense()" data-i18n="common.save">×©××•×¨</button>
            </div>
        </div>
    </div>

    <script src="../js/storage.js"></script>
    <script src="../js/pin-lock.js"></script>
    <script src="../js/i18n.js"></script>
    <script src="../js/charts.js"></script>
    <script src="../js/csv-import.js"></script>
    <script src="../js/smart-import.js"></script>
    <script src="../js/image-import.js"></script>
    <script src="../js/alerts.js"></script>
    <script src="../js/tags.js"></script>
    <script src="../js/app.js"></script>
    <script src="../js/firebase-config.js"></script>
    <script src="../js/crypto.js"></script>
    <script src="../js/auth.js"></script>
    <script>
        let selectedMonth = '';

        document.addEventListener('DOMContentLoaded', () => {
            App.currentPage = 'credit';
            initMonthSelector();
            loadCards();
            loadExpenses();
            renderRecurringSummary();
        });

        function initMonthSelector() {
            const select = document.getElementById('monthFilter');
            const now = new Date();
            const monthsSet = new Set();

            // Add last 12 months
            for (let i = 0; i < 12; i++) {
                const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const value = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                monthsSet.add(value);
            }

            // Add months from existing expenses
            const data = Storage.getCreditCards();
            data.expenses.forEach(exp => {
                if (exp.date) {
                    const month = exp.date.substring(0, 7);
                    monthsSet.add(month);
                }
            });

            // Convert to array and sort descending
            const months = Array.from(monthsSet).sort((a, b) => b.localeCompare(a)).map(value => {
                const [year, month] = value.split('-');
                const date = new Date(parseInt(year), parseInt(month) - 1, 1);
                const label = I18n.translations[I18n.currentLanguage].months[date.getMonth()] + ' ' + date.getFullYear();
                return { value, label };
            });

            select.innerHTML = months.map((m, i) =>
                `<option value="${m.value}" ${i === 0 ? 'selected' : ''}>${m.label}</option>`
            ).join('');

            selectedMonth = months[0]?.value || '';
        }

        function loadCards() {
            const data = Storage.getCreditCards();
            const container = document.getElementById('cardsContainer');

            if (data.cards.length === 0) {
                container.innerHTML = `<p style="text-align: center; color: var(--color-text-secondary); padding: 20px;">${I18n.t('credit.noCards')}</p>`;
                return;
            }

            container.innerHTML = data.cards.map(card => `
                <div class="card-chip">
                    <span>ğŸ’³</span>
                    <span class="number">**** ${card.lastFour}</span>
                    <span>${card.name}</span>
                    <button class="btn btn-danger btn-sm" onclick="deleteCard('${card.id}')" style="margin-right: 10px;">ğŸ—‘ï¸</button>
                </div>
            `).join('');

            // Update expense card selector
            const cardSelect = document.getElementById('expenseCard');
            cardSelect.innerHTML = data.cards.map(card =>
                `<option value="${card.id}">${card.name} (**** ${card.lastFour})</option>`
            ).join('');
        }

        function loadExpenses() {
            selectedMonth = document.getElementById('monthFilter').value;
            const categoryFilter = document.getElementById('categoryFilter').value;
            const searchFilter = document.getElementById('searchFilter').value.toLowerCase();

            const data = Storage.getCreditCards();
            const tbody = document.getElementById('expensesTable');

            let monthExpenses = data.expenses
                .filter(exp => exp.date.startsWith(selectedMonth));

            // Calculate total before filtering
            const totalAll = monthExpenses.reduce((sum, exp) => sum + exp.amount, 0);

            // Apply category filter
            if (categoryFilter) {
                monthExpenses = monthExpenses.filter(exp => exp.category === categoryFilter);
            }

            // Apply search filter
            if (searchFilter) {
                monthExpenses = monthExpenses.filter(exp =>
                    (exp.description || '').toLowerCase().includes(searchFilter)
                );
            }

            // Sort by date
            monthExpenses.sort((a, b) => new Date(b.date) - new Date(a.date));

            const total = monthExpenses.reduce((sum, exp) => sum + exp.amount, 0);
            document.getElementById('monthlyTotal').textContent = I18n.formatCurrency(totalAll);

            // Show budget progress
            updateBudgetProgress(totalAll);

            // Show alerts
            Alerts.renderAlerts('budgetAlerts');

            if (monthExpenses.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; color: var(--color-text-secondary);">${I18n.t('credit.noExpenses')}</td></tr>`;
                updateCategoryChart([], 0);
                return;
            }

            const rows = monthExpenses.map(exp => {
                // Show foreign transaction info
                let foreignInfo = '';
                var countryCode = getCountryFromDescription(exp.description);

                if (exp.originalCurrency && exp.originalCurrency !== 'â‚ª' && exp.originalCurrency !== 'ILS') {
                    // Has foreign currency info
                    var origAmount = exp.originalAmount || exp.amount;
                    var flag = countryCode ? getCountryFlag(countryCode) : getCurrencyFlag(exp.originalCurrency);
                    var rate = exp.exchangeRate || (origAmount > 0 ? (exp.amount / origAmount).toFixed(2) : '');
                    var rateText = rate ? ' (' + rate + ')' : '';
                    foreignInfo = '<span title="' + exp.originalCurrency + rateText + '">' + flag + ' ' + origAmount.toLocaleString() + rateText + '</span>';
                } else if (countryCode && countryCode !== 'IL') {
                    // No currency info but has foreign country in description - check for exchange rate
                    var rateInfo = exp.exchangeRate ? ' (' + exp.exchangeRate + ')' : '';
                    foreignInfo = '<span>' + getCountryFlag(countryCode) + rateInfo + '</span>';
                }

                return `
                    <tr>
                        <td>${I18n.formatDate(exp.date)}</td>
                        <td>${I18n.t('credit.categories.' + exp.category)}</td>
                        <td>${exp.description}${exp.isRecurring ? ' ğŸ”„' : ''}</td>
                        <td>${foreignInfo}</td>
                        <td class="negative">${I18n.formatCurrency(exp.amount)}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-secondary btn-sm" onclick="editExpense('${exp.id}')" title="${I18n.t('common.edit')}">âœï¸</button>
                                <button class="btn btn-danger btn-sm" onclick="deleteExpense('${exp.id}')" title="${I18n.t('common.delete')}">ğŸ—‘ï¸</button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            // Add totals row
            rows.push(`
                <tr style="font-weight: bold; background: var(--color-bg-hover); border-top: 2px solid var(--color-border);">
                    <td colspan="4" style="text-align: left;">${I18n.t('credit.totalTransactions')} (${monthExpenses.length} ${I18n.t('credit.transactions')})</td>
                    <td class="negative">${I18n.formatCurrency(total)}</td>
                    <td></td>
                </tr>
            `);

            // Populate table
            tbody.innerHTML = rows.join('');

            // Update category chart
            updateCategoryChart(monthExpenses, total);
        }

        // Helper function to get country code from description suffix
        function getCountryFromDescription(description) {
            if (!description) return null;
            var desc = description.toUpperCase().trim();
            if (desc.endsWith(' BR')) return 'BR';
            if (desc.endsWith(' US')) return 'US';
            if (desc.endsWith(' UK') || desc.endsWith(' GB')) return 'GB';
            if (desc.endsWith(' DE')) return 'DE';
            if (desc.endsWith(' FR')) return 'FR';
            if (desc.endsWith(' IT')) return 'IT';
            if (desc.endsWith(' ES')) return 'ES';
            if (desc.endsWith(' PT')) return 'PT';
            if (desc.endsWith(' NL')) return 'NL';
            if (desc.endsWith(' JP')) return 'JP';
            if (desc.endsWith(' CN')) return 'CN';
            if (desc.endsWith(' AU')) return 'AU';
            if (desc.endsWith(' CA')) return 'CA';
            if (desc.endsWith(' MX')) return 'MX';
            if (desc.endsWith(' TH')) return 'TH';
            if (desc.endsWith(' IL')) return 'IL';
            return null;
        }

        // Helper function to get flag from country code
        function getCountryFlag(code) {
            if (code === 'BR') return 'ğŸ‡§ğŸ‡·';
            if (code === 'US') return 'ğŸ‡ºğŸ‡¸';
            if (code === 'GB') return 'ğŸ‡¬ğŸ‡§';
            if (code === 'DE') return 'ğŸ‡©ğŸ‡ª';
            if (code === 'FR') return 'ğŸ‡«ğŸ‡·';
            if (code === 'IT') return 'ğŸ‡®ğŸ‡¹';
            if (code === 'ES') return 'ğŸ‡ªğŸ‡¸';
            if (code === 'PT') return 'ğŸ‡µğŸ‡¹';
            if (code === 'NL') return 'ğŸ‡³ğŸ‡±';
            if (code === 'JP') return 'ğŸ‡¯ğŸ‡µ';
            if (code === 'CN') return 'ğŸ‡¨ğŸ‡³';
            if (code === 'AU') return 'ğŸ‡¦ğŸ‡º';
            if (code === 'CA') return 'ğŸ‡¨ğŸ‡¦';
            if (code === 'MX') return 'ğŸ‡²ğŸ‡½';
            if (code === 'TH') return 'ğŸ‡¹ğŸ‡­';
            if (code === 'IL') return 'ğŸ‡®ğŸ‡±';
            return 'ğŸŒ';
        }

        // Helper function to get country flag from currency
        function getCurrencyFlag(currency) {
            const flags = {
                'USD': 'ğŸ‡ºğŸ‡¸', '$': 'ğŸ‡ºğŸ‡¸',
                'EUR': 'ğŸ‡ªğŸ‡º', 'â‚¬': 'ğŸ‡ªğŸ‡º',
                'GBP': 'ğŸ‡¬ğŸ‡§', 'Â£': 'ğŸ‡¬ğŸ‡§',
                'BRL': 'ğŸ‡§ğŸ‡·', 'R$': 'ğŸ‡§ğŸ‡·',
                'JPY': 'ğŸ‡¯ğŸ‡µ', 'Â¥': 'ğŸ‡¯ğŸ‡µ',
                'CNY': 'ğŸ‡¨ğŸ‡³',
                'CHF': 'ğŸ‡¨ğŸ‡­',
                'AUD': 'ğŸ‡¦ğŸ‡º',
                'CAD': 'ğŸ‡¨ğŸ‡¦',
                'THB': 'ğŸ‡¹ğŸ‡­',
                'TRY': 'ğŸ‡¹ğŸ‡·',
                'PLN': 'ğŸ‡µğŸ‡±',
                'CZK': 'ğŸ‡¨ğŸ‡¿',
                'HUF': 'ğŸ‡­ğŸ‡º',
                'SEK': 'ğŸ‡¸ğŸ‡ª',
                'NOK': 'ğŸ‡³ğŸ‡´',
                'DKK': 'ğŸ‡©ğŸ‡°',
                'MXN': 'ğŸ‡²ğŸ‡½',
                'ARS': 'ğŸ‡¦ğŸ‡·',
                'CLP': 'ğŸ‡¨ğŸ‡±',
                'COP': 'ğŸ‡¨ğŸ‡´',
                'PEN': 'ğŸ‡µğŸ‡ª',
                'INR': 'ğŸ‡®ğŸ‡³',
                'RUB': 'ğŸ‡·ğŸ‡º',
                'ZAR': 'ğŸ‡¿ğŸ‡¦',
                'AED': 'ğŸ‡¦ğŸ‡ª',
                'SGD': 'ğŸ‡¸ğŸ‡¬',
                'HKD': 'ğŸ‡­ğŸ‡°',
                'NZD': 'ğŸ‡³ğŸ‡¿',
                'KRW': 'ğŸ‡°ğŸ‡·'
            };
            return flags[currency] || 'ğŸŒ';
        }

        function updateCategoryChart(expenses, grandTotal) {
            const categoryTotals = {};
            expenses.forEach(exp => {
                categoryTotals[exp.category] = (categoryTotals[exp.category] || 0) + exp.amount;
            });

            const ctx = document.getElementById('categoryChart');
            const breakdownDiv = document.getElementById('categoryBreakdown');
            const categories = Object.keys(categoryTotals);
            const total = Object.values(categoryTotals).reduce((a, b) => a + b, 0);

            if (categories.length === 0) {
                breakdownDiv.innerHTML = '<p style="text-align: center; color: var(--color-text-secondary);">' + I18n.t('credit.noDataChart') + '</p>';
                if (Charts.charts.categoryChart) {
                    Charts.charts.categoryChart.destroy();
                    Charts.charts.categoryChart = null;
                }
                return;
            }

            // Sort by amount descending
            categories.sort((a, b) => categoryTotals[b] - categoryTotals[a]);

            const chartData = {
                labels: categories.map(cat => I18n.t('credit.categories.' + cat)),
                datasets: [{
                    data: categories.map(cat => categoryTotals[cat]),
                    backgroundColor: categories.map(cat => Charts.colors.categories[cat] || Charts.colors.categories.other),
                    borderWidth: 0
                }]
            };

            if (Charts.charts.categoryChart) {
                Charts.charts.categoryChart.data = chartData;
                Charts.charts.categoryChart.update();
            } else {
                Charts.charts.categoryChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: chartData,
                    options: {
                        ...Charts.defaultOptions,
                        cutout: '50%',
                        plugins: {
                            ...Charts.defaultOptions.plugins,
                            tooltip: {
                                callbacks: {
                                    label: (context) => {
                                        const value = context.raw;
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return `${context.label}: ${I18n.formatCurrency(value)} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // Build breakdown table
            var breakdownHtml = '<table style="width: 100%; border-collapse: collapse;">';
            breakdownHtml += '<thead><tr style="border-bottom: 2px solid var(--color-border);">';
            breakdownHtml += '<th style="text-align: right; padding: 8px 5px;">' + I18n.t('credit.expenseCategory') + '</th>';
            breakdownHtml += '<th style="text-align: center; padding: 8px 5px; width: 60px;">%</th>';
            breakdownHtml += '<th style="text-align: left; padding: 8px 5px; width: 100px;">' + I18n.t('common.amount') + '</th>';
            breakdownHtml += '</tr></thead><tbody>';

            categories.forEach(function(cat) {
                var amount = categoryTotals[cat];
                var percentage = ((amount / total) * 100).toFixed(1);
                var color = Charts.colors.categories[cat] || Charts.colors.categories.other;
                breakdownHtml += '<tr style="border-bottom: 1px solid var(--color-border);">';
                breakdownHtml += '<td style="padding: 10px 5px;"><span style="display: inline-block; width: 12px; height: 12px; border-radius: 50%; background: ' + color + '; margin-left: 8px; vertical-align: middle;"></span>' + I18n.t('credit.categories.' + cat) + '</td>';
                breakdownHtml += '<td style="text-align: center; padding: 10px 5px; font-weight: bold;">' + percentage + '%</td>';
                breakdownHtml += '<td style="text-align: left; padding: 10px 5px; color: var(--color-negative);">' + I18n.formatCurrency(amount) + '</td>';
                breakdownHtml += '</tr>';
            });

            // Add total row
            breakdownHtml += '<tr style="font-weight: bold; background: var(--color-bg-hover);">';
            breakdownHtml += '<td style="padding: 12px 5px;">' + I18n.t('credit.totalTransactions') + '</td>';
            breakdownHtml += '<td style="text-align: center; padding: 12px 5px;">100%</td>';
            breakdownHtml += '<td style="text-align: left; padding: 12px 5px; color: var(--color-negative);">' + I18n.formatCurrency(total) + '</td>';
            breakdownHtml += '</tr></tbody></table>';

            var breakdownRows = [breakdownHtml];

            breakdownDiv.innerHTML = breakdownRows.join('');
        }

        // Card Modal Functions
        function openCardModal() {
            document.getElementById('cardForm').reset();
            document.getElementById('cardId').value = '';
            document.getElementById('cardModal').classList.add('active');
        }

        function closeCardModal() {
            document.getElementById('cardModal').classList.remove('active');
        }

        function saveCard() {
            const name = document.getElementById('cardName').value;
            const lastFour = document.getElementById('lastFour').value;
            const creditLimit = parseFloat(document.getElementById('creditLimit').value) || 0;

            if (!name || !lastFour) {
                App.notify('Please fill all required fields', 'error');
                return;
            }

            Storage.addCreditCard({ name, lastFour, creditLimit });
            closeCardModal();
            loadCards();
            App.notify(I18n.t('common.save') + ' âœ“', 'success');
        }

        function deleteCard(id) {
            if (confirm(I18n.t('common.confirmDelete'))) {
                Storage.deleteCreditCard(id);
                loadCards();
                loadExpenses();
                App.notify(I18n.t('common.delete') + ' âœ“', 'success');
            }
        }

        // Expense Modal Functions
        function openExpenseModal() {
            const data = Storage.getCreditCards();
            if (data.cards.length === 0) {
                App.notify(I18n.t('credit.addCardFirst'), 'error');
                return;
            }

            document.getElementById('expenseForm').reset();
            document.getElementById('expenseId').value = '';
            document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('recurringFields').classList.remove('visible');
            document.getElementById('expenseModal').classList.add('active');
        }

        function closeExpenseModal() {
            document.getElementById('expenseModal').classList.remove('active');
        }

        function editExpense(id) {
            const data = Storage.getCreditCards();
            const expense = data.expenses.find(e => e.id === id);
            if (!expense) return;

            document.getElementById('expenseId').value = expense.id;
            document.getElementById('expenseCard').value = expense.cardId;
            document.getElementById('expenseDate').value = expense.date;
            document.getElementById('expenseAmount').value = expense.amount;
            document.getElementById('expenseCategory').value = expense.category;
            document.getElementById('expenseDescription').value = expense.description || '';
            document.getElementById('isRecurring').checked = expense.isRecurring || false;
            // Load recurring fields
            if (expense.isRecurring) {
                document.getElementById('recurringFields').classList.add('visible');
                document.getElementById('recurringFrequency').value = expense.recurringFrequency || 'monthly';
                document.getElementById('recurringDay').value = expense.recurringDay || '';
                document.getElementById('recurringEndDate').value = expense.recurringEndDate || '';
            } else {
                document.getElementById('recurringFields').classList.remove('visible');
            }
            document.getElementById('expenseModal').classList.add('active');
        }

        function saveExpense() {
            const id = document.getElementById('expenseId').value;
            const cardId = document.getElementById('expenseCard').value;
            const date = document.getElementById('expenseDate').value;
            const amount = parseFloat(document.getElementById('expenseAmount').value);
            const category = document.getElementById('expenseCategory').value;
            const description = document.getElementById('expenseDescription').value;
            const isRecurring = document.getElementById('isRecurring').checked;

            if (!cardId || !date || !amount || !category) {
                App.notify('Please fill all required fields', 'error');
                return;
            }

            const expenseData = { cardId, date, amount, category, description, isRecurring };

            if (isRecurring) {
                expenseData.recurringFrequency = document.getElementById('recurringFrequency').value;
                expenseData.recurringDay = parseInt(document.getElementById('recurringDay').value) || null;
                expenseData.recurringEndDate = document.getElementById('recurringEndDate').value || null;
            } else {
                expenseData.recurringFrequency = null;
                expenseData.recurringDay = null;
                expenseData.recurringEndDate = null;
            }

            if (id) {
                Storage.updateExpense(id, expenseData);
            } else {
                Storage.addExpense(expenseData);
            }

            closeExpenseModal();
            loadExpenses();
            renderRecurringSummary();
            App.notify(I18n.t('common.save') + ' âœ“', 'success');
        }

        function deleteExpense(id) {
            if (confirm(I18n.t('common.confirmDelete'))) {
                Storage.deleteExpense(id);
                loadExpenses();
                renderRecurringSummary();
                App.notify(I18n.t('common.delete') + ' âœ“', 'success');
            }
        }

        function deleteAllExpenses() {
            var data = Storage.getCreditCards();
            var count = data.expenses.length;
            if (count === 0) {
                App.notify(I18n.t('credit.noExpensesToDelete'), 'warning');
                return;
            }
            if (confirm(I18n.t('credit.deleteAllConfirm').replace('{}', count))) {
                data.expenses = [];
                Storage.saveCreditCards(data);
                loadExpenses();
                App.notify(I18n.t('credit.deletedExpenses') + ' (' + count + ')', 'success');
            }
        }

        // Recurring Expense Functions
        function toggleRecurringFields() {
            const fields = document.getElementById('recurringFields');
            if (document.getElementById('isRecurring').checked) {
                fields.classList.add('visible');
            } else {
                fields.classList.remove('visible');
            }
        }

        function toggleRecurringSection() {
            const toggle = document.querySelector('.recurring-toggle');
            const body = document.getElementById('recurringBody');
            toggle.classList.toggle('open');
            body.classList.toggle('open');
        }

        function getNextChargeDate(expense) {
            const day = expense.recurringDay || new Date(expense.date).getDate();
            const now = new Date();
            const freq = expense.recurringFrequency || 'monthly';

            let next = new Date(now.getFullYear(), now.getMonth(), day);
            if (next <= now) {
                if (freq === 'weekly') next.setDate(next.getDate() + 7);
                else if (freq === 'biweekly') next.setDate(next.getDate() + 14);
                else if (freq === 'bimonthly') next.setMonth(next.getMonth() + 2);
                else if (freq === 'quarterly') next.setMonth(next.getMonth() + 3);
                else if (freq === 'annually') next.setFullYear(next.getFullYear() + 1);
                else next.setMonth(next.getMonth() + 1);
            }

            if (expense.recurringEndDate && next > new Date(expense.recurringEndDate)) return null;
            return next;
        }

        function getCategoryIcon(category) {
            const icons = { food: 'ğŸ”', transport: 'ğŸš—', shopping: 'ğŸ›’', entertainment: 'ğŸ¬', bills: 'ğŸ“„', health: 'ğŸ’Š', education: 'ğŸ“š', other: 'ğŸ“Œ' };
            return icons[category] || 'ğŸ“Œ';
        }

        function renderRecurringSummary() {
            const recurring = Storage.getRecurringExpenses();
            const grid = document.getElementById('recurringGrid');
            const badge = document.getElementById('recurringTotalBadge');
            const section = document.getElementById('recurringSection');

            if (recurring.length === 0) {
                section.style.display = 'none';
                return;
            }
            section.style.display = 'block';

            const monthlyTotal = Storage.getMonthlyRecurringTotal();
            badge.textContent = I18n.formatCurrency(monthlyTotal);

            const freqLabels = {
                weekly: I18n.t('credit.weekly'),
                biweekly: I18n.t('credit.biweekly'),
                monthly: I18n.t('credit.monthly'),
                bimonthly: I18n.t('credit.bimonthly'),
                quarterly: I18n.t('credit.quarterly'),
                annually: I18n.t('credit.annually')
            };

            const now = new Date();
            const in7days = new Date(now);
            in7days.setDate(in7days.getDate() + 7);

            grid.innerHTML = recurring.map(exp => {
                const freq = exp.recurringFrequency || 'monthly';
                const nextDate = getNextChargeDate(exp);
                const isUpcoming = nextDate && nextDate <= in7days;
                const nextStr = nextDate ? I18n.formatDate(nextDate.toISOString().split('T')[0]) : '-';

                return `
                    <div class="recurring-card${isUpcoming ? ' upcoming' : ''}">
                        <span class="recurring-card-icon">${getCategoryIcon(exp.category)}</span>
                        <div class="recurring-card-info">
                            <div class="recurring-card-name">${exp.description || I18n.t('credit.categories.' + exp.category)}</div>
                            <div class="recurring-card-meta">${freqLabels[freq] || freq} Â· ${I18n.t('credit.nextCharge')}: ${nextStr}</div>
                        </div>
                        <div class="recurring-card-amount">${I18n.formatCurrency(exp.amount)}</div>
                        <div class="recurring-card-actions">
                            <button class="btn btn-secondary btn-sm" onclick="editExpense('${exp.id}')" title="${I18n.t('common.edit')}">âœï¸</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Smart Import Function
        async function smartImportFile(event) {
            var file = event.target.files[0];
            if (!file) return;

            try {
                var content = await file.text();
                var result = SmartImport.importWithAutoDetect(content, file.name, 'expenses');

                if (result.needsMapping) {
                    // Show manual mapping modal
                    SmartImport.showMappingModal(result.headers, result.detected, function(mapping) {
                        var processResult = SmartImport.processRows(result.rows, result.headerIdx, mapping, 'expenses');
                        if (processResult.success) {
                            importExpensesFromSmartImport(processResult.items);
                        } else {
                            App.notify(processResult.error || I18n.t('bank.importError'), 'error');
                        }
                    });
                } else if (result.success) {
                    importExpensesFromSmartImport(result.items);
                } else {
                    App.notify(result.error || I18n.t('bank.importError'), 'error');
                }
            } catch (error) {
                console.error('Smart import error:', error);
                App.notify(I18n.t('credit.fileReadError') + ': ' + error.message, 'error');
            }

            event.target.value = '';
        }

        function importExpensesFromSmartImport(items) {
            if (items.length === 0) {
                App.notify(I18n.t('credit.noTransactionsFound'), 'warning');
                return;
            }

            // Calculate total
            var total = items.reduce(function(sum, e) { return sum + e.amount; }, 0);

            // Show confirmation
            var confirmed = confirm(
                I18n.t('credit.foundTransactions') + ': ' + items.length + ' ' + I18n.t('credit.transactions') + '\n' +
                I18n.t('credit.totalTransactions') + ': ' + I18n.formatCurrency(total) + '\n\n' +
                items.slice(0, 3).map(function(e) {
                    return '  ' + e.date + ' - ' + e.description + ' - ' + I18n.formatCurrency(e.amount);
                }).join('\n') + '\n' +
                (items.length > 3 ? '  ...' + I18n.t('credit.moreTransactions') + ' ' + (items.length - 3) : '') + '\n\n' +
                I18n.t('credit.importTransactions')
            );

            if (!confirmed) return;

            // Get or create default card
            var data = Storage.getCreditCards();
            var cardId = data.cards[0] ? data.cards[0].id : null;

            if (!cardId) {
                var card = Storage.addCreditCard({
                    name: I18n.t('credit.defaultCardName'),
                    lastFour: items[0].cardLastFour || '0000',
                    limit: 50000
                });
                cardId = card.id;
            }

            // Import expenses (skip duplicates)
            var imported = 0;
            var skipped = 0;
            var existingExpenses = Storage.getCreditCards().expenses;

            items.forEach(function(exp) {
                // Check for duplicates
                var isDuplicate = existingExpenses.some(function(existing) {
                    return existing.date === exp.date &&
                           existing.description === exp.description &&
                           existing.amount === exp.amount;
                });

                if (isDuplicate) {
                    skipped++;
                    return;
                }

                Storage.addExpense({
                    cardId: cardId,
                    date: exp.date,
                    amount: exp.amount,
                    category: exp.category,
                    description: exp.description,
                    isRecurring: false,
                    originalAmount: exp.originalAmount,
                    originalCurrency: exp.originalCurrency,
                    exchangeRate: exp.exchangeRate
                });
                imported++;
            });

            var msg = skipped > 0
                ? I18n.t('credit.importSuccess') + ' ' + imported + ' ' + I18n.t('credit.transactions') + ' (' + skipped + ' ' + I18n.t('credit.duplicatesSkipped') + ')'
                : I18n.t('credit.importSuccess') + ' ' + imported + ' ' + I18n.t('credit.transactions');
            App.notify(msg, 'success');

            // Switch to imported month
            if (items.length > 0 && items[0].date) {
                var importedMonth = items[0].date.substring(0, 7);
                var monthFilter = document.getElementById('monthFilter');
                var optionExists = Array.from(monthFilter.options).some(function(opt) {
                    return opt.value === importedMonth;
                });
                if (!optionExists) {
                    var date = new Date(importedMonth + '-01');
                    var label = I18n.translations[I18n.currentLanguage].months[date.getMonth()] + ' ' + date.getFullYear();
                    monthFilter.insertAdjacentHTML('beforeend', '<option value="' + importedMonth + '">' + label + '</option>');
                }
                monthFilter.value = importedMonth;
            }

            loadCards();
            loadExpenses();
        }

        function clearFilters() {
            document.getElementById('categoryFilter').value = '';
            document.getElementById('searchFilter').value = '';
            loadExpenses();
        }

        function updateBudgetProgress(spent) {
            const budgets = Alerts.getBudgets();
            const thresholds = Alerts.getThresholds();
            const container = document.getElementById('budgetProgressContainer');
            const bar = document.getElementById('budgetProgressBar');

            if (budgets.total > 0) {
                container.style.display = 'block';
                const percentage = (spent / budgets.total) * 100;

                document.getElementById('budgetSpent').textContent = I18n.formatCurrency(spent);
                document.getElementById('budgetLimit').textContent = `${I18n.t('credit.budgetOf')} ${I18n.formatCurrency(budgets.total)}`;

                bar.style.width = `${Math.min(100, percentage)}%`;

                if (percentage >= thresholds.danger) {
                    bar.style.background = 'var(--color-negative)';
                } else if (percentage >= thresholds.warning) {
                    bar.style.background = '#f59e0b';
                } else {
                    bar.style.background = 'var(--color-positive)';
                }
            } else {
                container.style.display = 'none';
            }
        }

        async function importCSV() {
            const format = CSVImport.showImportHelp('expenses');
            const confirmed = confirm(
                `${format.title}\n\n` +
                `${format.columns.join(', ')}\n\n` +
                `${format.example}\n\n` +
                `${I18n.t('credit.csvContinue')}`
            );

            if (!confirmed) return;

            const result = await CSVImport.openFilePicker('expenses');

            if (result.success) {
                App.notify(I18n.t('credit.importSuccess') + ' ' + result.imported + ' ' + I18n.t('credit.transactions'), 'success');
                loadCards();
                loadExpenses();
            } else {
                App.notify(result.error || I18n.t('bank.importError'), 'error');
            }

            if (result.errors && result.errors.length > 0) {
                console.log('Import errors:', result.errors);
            }
        }

        // Excel Import for Credit Card Transactions
        async function importCreditExcel(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                const content = await file.text();
                const expenses = parseCreditExcel(content);

                if (expenses.length === 0) {
                    App.notify(I18n.t('credit.noTransactionsFound'), 'warning');
                    return;
                }

                // Calculate total
                const total = expenses.reduce((sum, e) => sum + e.amount, 0);

                // Show confirmation
                const confirmed = confirm(
                    `${I18n.t('credit.foundTransactions')}: ${expenses.length} ${I18n.t('credit.transactions')}\n` +
                    `${I18n.t('credit.totalTransactions')}: ${I18n.formatCurrency(total)}\n\n` +
                    `${expenses.slice(0, 5).map(e => `  ${e.date} - ${e.description} - ${I18n.formatCurrency(e.amount)}`).join('\n')}\n` +
                    `${expenses.length > 5 ? `  ...${I18n.t('credit.moreTransactions')} ${expenses.length - 5}` : ''}\n\n` +
                    `${I18n.t('credit.importTransactions')}`
                );

                if (!confirmed) return;

                // Get or create default card
                const data = Storage.getCreditCards();
                let cardId = data.cards[0]?.id;

                if (!cardId) {
                    // Create default card
                    const card = Storage.addCreditCard({
                        name: I18n.t('credit.defaultCardName'),
                        lastFour: expenses[0]?.cardLastFour || '0000',
                        limit: 50000
                    });
                    cardId = card.id;
                }

                // Import expenses (skip duplicates)
                let imported = 0;
                let skipped = 0;
                const existingExpenses = Storage.getCreditCards().expenses;

                expenses.forEach(exp => {
                    // Check if expense already exists (same date, description, and amount)
                    const isDuplicate = existingExpenses.some(existing =>
                        existing.date === exp.date &&
                        existing.description === exp.description &&
                        existing.amount === exp.amount
                    );

                    if (isDuplicate) {
                        skipped++;
                        return;
                    }

                    Storage.addExpense({
                        cardId,
                        date: exp.date,
                        amount: exp.amount,
                        category: exp.category,
                        description: exp.description,
                        isRecurring: exp.isRecurring || false,
                        originalAmount: exp.originalAmount,
                        originalCurrency: exp.originalCurrency,
                        exchangeRate: exp.exchangeRate
                    });
                    imported++;
                });

                const msg = skipped > 0
                    ? `${I18n.t('credit.importSuccess')} ${imported} ${I18n.t('credit.transactions')} (${skipped} ${I18n.t('credit.duplicatesSkipped')})`
                    : `${I18n.t('credit.importSuccess')} ${imported} ${I18n.t('credit.transactions')}`;
                App.notify(msg, 'success');

                // Switch to the month of the first imported expense
                if (expenses.length > 0 && expenses[0].date) {
                    const importedMonth = expenses[0].date.substring(0, 7); // YYYY-MM
                    const monthFilter = document.getElementById('monthFilter');
                    // Add the month if not in the list
                    let optionExists = Array.from(monthFilter.options).some(opt => opt.value === importedMonth);
                    if (!optionExists) {
                        const date = new Date(importedMonth + '-01');
                        const label = I18n.translations[I18n.currentLanguage].months[date.getMonth()] + ' ' + date.getFullYear();
                        monthFilter.insertAdjacentHTML('beforeend', `<option value="${importedMonth}">${label}</option>`);
                    }
                    monthFilter.value = importedMonth;
                }

                loadCards();
                loadExpenses();

            } catch (error) {
                console.error('Excel import error:', error);
                App.notify(I18n.t('credit.fileReadError') + ': ' + error.message, 'error');
            }

            event.target.value = '';
        }

        function parseCreditExcel(content) {
            const expenses = [];

            // Parse XML-based Excel (xlsx)
            const rowPattern = /<row[^>]*>([\s\S]*?)<\/row>/gi;
            const cellPattern = /<c[^>]*>(?:<v>([^<]*)<\/v>)?/gi;
            const valuePattern = /<v>([^<]*)<\/v>/;

            // Find all rows
            const rows = [];
            let match;
            while ((match = rowPattern.exec(content)) !== null) {
                const rowContent = match[1];
                const cells = [];

                // Extract cell values
                let cellMatch;
                const cp = new RegExp(cellPattern.source, 'gi');
                while ((cellMatch = cp.exec(rowContent)) !== null) {
                    const cellContent = cellMatch[0];
                    const valMatch = cellContent.match(valuePattern);
                    cells.push(valMatch ? valMatch[1] : '');
                }
                rows.push(cells);
            }

            // Find header row (contains '×ª××¨×™×š ×¢×¡×§×”' or '×©× ×‘×™×ª ×”×¢×¡×§')
            let headerIdx = -1;
            for (let i = 0; i < rows.length; i++) {
                const rowText = rows[i].join(' ');
                if (rowText.includes('×ª××¨×™×š ×¢×¡×§×”') || rowText.includes('×©× ×‘×™×ª ×”×¢×¡×§')) {
                    headerIdx = i;
                    break;
                }
            }

            if (headerIdx === -1) {
                throw new Error(I18n.t('credit.badFormat'));
            }

            // Category mapping from Hebrew to internal
            const categoryMap = {
                '××–×•×Ÿ ×•××¡×¢×“×•×ª': 'food',
                '××¡×¢×“×•×ª, ×§×¤×” ×•×‘×¨×™×': 'food',
                '×¡×•×¤×¨××¨×§×˜': 'food',
                '×ª×—×‘×•×¨×” ×•×“×œ×§': 'transport',
                '×“×œ×§, ×—×©××œ ×•×’×–': 'transport',
                '×§× ×™×•×ª': 'shopping',
                '××•×¤× ×” ×•×”× ×¢×œ×”': 'shopping',
                '×¦×™×•×“ ×œ×‘×™×ª': 'shopping',
                '×‘×™×œ×•×™×™×': 'entertainment',
                '×¤× ××™, ×‘×™×“×•×¨ ×•×¡×¤×•×¨×˜': 'entertainment',
                '×—×©×‘×•× ×•×ª': 'bills',
                '×¢×™×¨×™×™×” ×•×××©×œ×”': 'bills',
                '×©×™×¨×•×ª×™ ×ª×§×©×•×¨×ª': 'bills',
                '×—×©××œ ×•××™×': 'bills',
                '×‘×¨×™××•×ª': 'health',
                '×‘×¨×™××•×ª ×•×™×•×¤×™': 'health',
                '×—×™× ×•×š': 'education',
                '×©×•× ×•×ª': 'other'
            };

            // Parse data rows (after header)
            for (let i = headerIdx + 1; i < rows.length; i++) {
                const row = rows[i];
                if (row.length < 6) continue;

                // Skip summary rows
                if (row[0]?.includes('×¡×š ×”×›×œ') || row[0]?.includes('â‚ª')) continue;

                const dateStr = row[0]; // A: ×ª××¨×™×š ×¢×¡×§×”
                const description = row[1]; // B: ×©× ×‘×™×ª ×”×¢×¡×§
                const categoryHeb = row[2]; // C: ×§×˜×’×•×¨×™×”
                const cardLastFour = row[3]; // D: 4 ×¡×¤×¨×•×ª
                const amountStr = row[5]; // F: ×¡×›×•× ×—×™×•×‘
                const originalAmountStr = row[7]; // H: ×¡×›×•× ×¢×¡×§×” ××§×•×¨×™
                var originalCurrency = row[8]; // I: ××˜×‘×¢ ×¢×¡×§×” ××§×•×¨×™
                const notes = row[10] || ''; // K: ×”×¢×¨×•×ª
                const exchangeRateStr = row[15] || ''; // P: ×©×¢×¨ ×”××¨×”

                if (!dateStr || !description || !amountStr) continue;

                // Parse date (DD-MM-YYYY to YYYY-MM-DD)
                const dateParts = dateStr.split('-');
                if (dateParts.length !== 3) continue;
                const date = `${dateParts[2]}-${dateParts[1]}-${dateParts[0]}`;

                // Parse amount
                const amount = parseFloat(amountStr.replace(/,/g, ''));
                if (isNaN(amount) || amount <= 0) continue;

                // Parse original amount (for foreign transactions)
                var originalAmount = parseFloat(originalAmountStr?.replace(/,/g, '') || '0');

                // Parse exchange rate from text like "×©×¢×¨ ×”××¨×” ××“×•×œ×¨ ×œ×©"×— 3.1500"
                var exchangeRate = null;
                if (exchangeRateStr) {
                    var rateMatch = exchangeRateStr.match(/(\d+\.?\d*)/);
                    if (rateMatch) {
                        exchangeRate = parseFloat(rateMatch[1]);
                    }
                    // If no original currency but has exchange rate, it's likely USD
                    if ((!originalCurrency || originalCurrency === 'â‚ª' || originalCurrency === '') && exchangeRate) {
                        originalCurrency = '$';
                    }
                }

                // Map category
                const category = categoryMap[categoryHeb] || 'other';

                // Check if recurring
                const isRecurring = notes.includes('×”×•×¨××ª ×§×‘×¢');

                // Check if foreign transaction (original currency different from ILS)
                var isForeign = originalCurrency && originalCurrency !== 'â‚ª' && originalCurrency !== 'ILS' && originalCurrency !== '';

                expenses.push({
                    date,
                    description: description.trim(),
                    amount,
                    category,
                    cardLastFour,
                    isRecurring,
                    originalAmount: (isForeign || exchangeRate) ? originalAmount : null,
                    originalCurrency: (isForeign || exchangeRate) ? originalCurrency : null,
                    exchangeRate: exchangeRate
                });
            }

            return expenses;
        }
    </script>
</body>
</html>
