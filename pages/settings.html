<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="../img/logo.png">
    <meta name="theme-color" content="#6b7280">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://www.gstatic.com https://apis.google.com; style-src 'self' 'unsafe-inline'; img-src 'self' https: data:; connect-src 'self' https://*.googleapis.com https://*.firebaseio.com https://*.firebaseapp.com wss://*.firebaseio.com; frame-src https://accounts.google.com https://*.firebaseapp.com; object-src 'none'; base-uri 'self'; form-action 'self' https://accounts.google.com;">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <link rel="manifest" href="../manifest.json">
    <link rel="icon" type="image/png" href="../img/logo.png">
    <title>×”×’×“×¨×•×ª - FinSight</title>
    <link rel="stylesheet" href="../css/app.css">
    <style>
        .nav-link.active { background: #6b7280 !important; }

        .settings-section {
            background: var(--color-bg-card);
            border: 1px solid var(--color-border);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
        }

        .settings-section h2 {
            font-size: 1.3rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--color-border);
        }

        .setting-row:last-child { border-bottom: none; }

        .setting-label {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .setting-label span:first-child { font-weight: 500; }
        .setting-label span:last-child { font-size: 0.85rem; color: var(--color-text-secondary); }

        .budget-input {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .budget-input input {
            width: 120px;
            padding: 8px 12px;
            background: var(--color-bg-card);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            color: white;
            text-align: left;
        }

        .category-budget {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px 0;
            border-bottom: 1px solid var(--color-border);
        }

        .category-budget:last-child { border-bottom: none; }

        .category-icon { font-size: 1.5rem; }

        .category-name { flex: 1; }

        .custom-category-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .color-preview {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid white;
        }

        .danger-zone {
            border-color: var(--color-credit);
        }

        .danger-zone h2 { color: var(--color-credit); }

        /* Toggle switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--color-border);
            transition: .3s;
            border-radius: 26px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: var(--color-positive);
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        .notification-granted { color: var(--color-positive); }
        .notification-denied { color: var(--color-negative); }
        .notification-default { color: var(--color-text-secondary); }
    </style>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar Navigation -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="brand">
                    <img src="../img/logo.png" class="brand-icon" alt="FinSight">
                    <span class="brand-name">Fin<span class="brand-highlight">Sight</span></span>
                </div>
            </div>

            <nav>
                <ul class="nav-menu">
                    <li class="nav-item"><a href="../index.html" class="nav-link"><span class="icon">ğŸ </span><span data-i18n="nav.dashboard">×“××©×‘×•×¨×“</span></a></li>
                    <li class="nav-item"><a href="bank.html" class="nav-link"><span class="icon">ğŸ¦</span><span data-i18n="nav.bankAccounts">×—×©×‘×•× ×•×ª ×‘× ×§</span></a></li>
                    <li class="nav-item"><a href="credit.html" class="nav-link"><span class="icon">ğŸ’³</span><span data-i18n="nav.creditCards">×›×¨×˜×™×¡×™ ××©×¨××™</span></a></li>
                    <li class="nav-item"><a href="stocks.html" class="nav-link"><span class="icon">ğŸ“ˆ</span><span data-i18n="nav.stocks">×× ×™×•×ª</span></a></li>
                    <li class="nav-item">
                        <span class="nav-link" style="cursor: default;"><span class="icon">ğŸ“Š</span><span data-i18n="nav.financialProducts">××•×¦×¨×™× ×¤×™× × ×¡×™×™×</span></span>
                        <ul class="nav-submenu">
                            <li class="nav-item"><a href="market-products.html" class="nav-link"><span>ğŸª </span><span data-i18n="nav.marketProducts">××•×¦×¨×™× ×‘×©×•×§</span></a></li>
                            <li class="nav-item"><a href="my-funds.html" class="nav-link"><span>ğŸ’ </span><span data-i18n="nav.myProducts">×”××•×¦×¨×™× ×©×œ×™</span></a></li>
                        </ul>
                    </li>
                    <li class="nav-item"><a href="assets.html" class="nav-link"><span class="icon">ğŸ </span><span data-i18n="nav.assets">× ×›×¡×™×</span></a></li>
                    <li class="nav-item"><a href="loans.html" class="nav-link" data-category="loans"><span class="icon">ğŸ¦</span><span data-i18n="nav.loans">×”×œ×•×•××•×ª</span></a></li>
                    <li class="nav-item"><a href="goals.html" class="nav-link"><span class="icon">ğŸ¯</span><span data-i18n="nav.goals">×™×¢×“×™ ×—×™×¡×›×•×Ÿ</span></a></li>
                    <li class="nav-item"><a href="reports.html" class="nav-link"><span class="icon">ğŸ“‹</span><span data-i18n="nav.reports">×“×•×—×•×ª</span></a></li>
                    <li class="nav-item"><a href="profile.html" class="nav-link"><span class="icon">ğŸ‘¤</span><span data-i18n="nav.profile">×¤×¨×•×¤×™×œ ×¤×™× × ×¡×™</span></a></li>
                    <li class="nav-item"><a href="settings.html" class="nav-link active"><span class="icon">âš™ï¸</span><span data-i18n="nav.settings">×”×’×“×¨×•×ª</span></a></li>
                </ul>
            </nav>

            <div class="sidebar-footer">
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="logo-hero">
                <img src="../img/logo.png" alt="FinSight" class="logo-hero-img">
            </div>
            <header class="page-header">
                <h1>âš™ï¸ <span data-i18n="settings.title">×”×’×“×¨×•×ª</span></h1>
                <p data-i18n="settings.subtitle">×”×ª×××” ××™×©×™×ª ×©×œ ×”××¤×œ×™×§×¦×™×”</p>
            </header>

            <!-- Budget Settings -->
            <div class="settings-section">
                <h2>ğŸ’° <span data-i18n="settings.monthlyBudget">×ª×§×¦×™×‘ ×—×•×“×©×™</span></h2>
                <p style="color: var(--color-text-secondary); margin-bottom: 20px;" data-i18n="settings.budgetDesc">×”×’×“×¨ ×ª×§×¦×™×‘ ×œ×”×ª×¨××•×ª ×›×©×—×•×¨×’×™×</p>

                <div class="setting-row">
                    <div class="setting-label">
                        <span data-i18n="settings.totalBudget">×ª×§×¦×™×‘ ×›×•×œ×œ</span>
                        <span data-i18n="settings.totalBudgetDesc">×¡×”×´×› ×”×•×¦××•×ª ××•×ª×¨×•×ª ×‘×—×•×“×©</span>
                    </div>
                    <div class="budget-input">
                        <span>â‚ª</span>
                        <input type="number" id="totalBudget" step="100" onchange="saveTotalBudget()">
                    </div>
                </div>

                <h3 style="margin: 25px 0 15px; font-size: 1.1rem;">âš ï¸ <span data-i18n="settings.alertThresholds">×¡×£ ×”×ª×¨××•×ª</span></h3>

                <div class="setting-row">
                    <div class="setting-label">
                        <span data-i18n="settings.warningAlert">×”×ª×¨××ª ××–×”×¨×” (×¦×”×•×‘)</span>
                        <span data-i18n="settings.warningAlertDesc">×”×¦×’ ×”×ª×¨××” ×›×©××’×™×¢×™× ×œ××—×•×– ×–×”</span>
                    </div>
                    <div class="budget-input">
                        <input type="number" id="warningThreshold" min="1" max="100" step="5" onchange="saveThresholds()">
                        <span>%</span>
                    </div>
                </div>

                <div class="setting-row">
                    <div class="setting-label">
                        <span data-i18n="settings.dangerAlert">×”×ª×¨××ª ×—×¨×™×’×” (××“×•×)</span>
                        <span data-i18n="settings.dangerAlertDesc">×”×¦×’ ×”×ª×¨××” ×›×©××’×™×¢×™× ×œ××—×•×– ×–×”</span>
                    </div>
                    <div class="budget-input">
                        <input type="number" id="dangerThreshold" min="1" max="150" step="5" onchange="saveThresholds()">
                        <span>%</span>
                    </div>
                </div>

                <h3 style="margin: 25px 0 15px; font-size: 1.1rem;"><span data-i18n="settings.categoryBudget">×ª×§×¦×™×‘ ×œ×¤×™ ×§×˜×’×•×¨×™×”</span></h3>
                <div id="categoryBudgets">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- Custom Categories -->
            <div class="settings-section">
                <h2>ğŸ·ï¸ <span data-i18n="settings.customCategories">×§×˜×’×•×¨×™×•×ª ××•×ª×××•×ª ××™×©×™×ª</span></h2>
                <p style="color: var(--color-text-secondary); margin-bottom: 20px;" data-i18n="settings.customCategoriesDesc">×”×•×¡×£ ×§×˜×’×•×¨×™×•×ª ××©×œ×š ×œ×”×•×¦××•×ª</p>

                <div id="customCategories">
                    <!-- Populated by JS -->
                </div>

                <button class="btn btn-primary" onclick="openCategoryModal()" style="margin-top: 15px;">
                    <span>â•</span>
                    <span data-i18n="settings.addCategory">×”×•×¡×£ ×§×˜×’×•×¨×™×”</span>
                </button>
            </div>

            <!-- Notification Settings -->
            <div class="settings-section" id="notificationSection">
                <h2>ğŸ”” <span data-i18n="settings.notifications">×”×ª×¨××•×ª</span></h2>
                <p style="color: var(--color-text-secondary); margin-bottom: 20px;" data-i18n="settings.notificationsDesc">×”×’×“×¨ ×”×ª×¨××•×ª push ×œ××™×¨×•×¢×™× ×—×©×•×‘×™×</p>

                <div class="setting-row">
                    <div class="setting-label">
                        <span data-i18n="settings.enableNotifications">×”×¤×¢×œ ×”×ª×¨××•×ª</span>
                        <span id="notificationStatus" data-i18n="settings.checkingPermissions">×‘×•×“×§ ×”×¨×©××•×ª...</span>
                    </div>
                    <button class="btn btn-primary" id="notificationToggle" onclick="toggleNotifications()">
                        <span data-i18n="settings.enable">×”×¤×¢×œ</span>
                    </button>
                </div>

                <div id="notificationOptions" style="display: none;">
                    <div class="setting-row">
                        <div class="setting-label">
                            <span data-i18n="settings.stockAlerts">×”×ª×¨××•×ª ×× ×™×•×ª</span>
                            <span data-i18n="settings.stockAlertsDesc">×§×‘×œ ×”×ª×¨××” ×›×©×× ×™×” ××’×™×¢×” ×œ×™×¢×“</span>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="stockAlertsToggle" onchange="saveNotificationSettings()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <div class="setting-row">
                        <div class="setting-label">
                            <span data-i18n="settings.budgetAlerts">×”×ª×¨××•×ª ×ª×§×¦×™×‘</span>
                            <span data-i18n="settings.budgetAlertsDesc">×§×‘×œ ×”×ª×¨××” ×›×©×—×•×¨×’×™× ××ª×§×¦×™×‘</span>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="budgetAlertsToggle" onchange="saveNotificationSettings()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <div class="setting-row">
                        <div class="setting-label">
                            <span data-i18n="settings.monthlyReminder">×ª×–×›×•×¨×ª ×—×•×“×©×™×ª</span>
                            <span data-i18n="settings.monthlyReminderDesc">×ª×–×›×•×¨×ª ×œ×¢×“×›×•×Ÿ ×§×¨× ×•×ª ×•×§×•×¤×•×ª</span>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="monthlyReminderToggle" onchange="saveNotificationSettings()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <div class="setting-row">
                        <div class="setting-label">
                            <span data-i18n="settings.reminderDay">×™×•× ×”×ª×–×›×•×¨×ª</span>
                            <span data-i18n="settings.reminderDayDesc">×‘××™×–×” ×™×•× ×‘×—×•×“×© ×œ×©×œ×•×— ×ª×–×›×•×¨×ª</span>
                        </div>
                        <div class="budget-input">
                            <input type="number" id="reminderDay" min="1" max="28" value="1" onchange="saveNotificationSettings()">
                            <span data-i18n="settings.inMonth">×‘×—×•×“×©</span>
                        </div>
                    </div>

                    <div class="setting-row">
                        <div class="setting-label">
                            <span data-i18n="settings.testNotifications">×‘×“×•×§ ×”×ª×¨××•×ª</span>
                            <span data-i18n="settings.testNotificationsDesc">×©×œ×— ×”×ª×¨××ª ×‘×“×™×§×”</span>
                        </div>
                        <button class="btn btn-secondary" onclick="sendTestNotification()">
                            <span>ğŸ“¤</span>
                            <span data-i18n="settings.sendTest">×©×œ×— ×‘×“×™×§×”</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Data Management -->
            <div class="settings-section">
                <h2>ğŸ“¦ <span data-i18n="settings.dataManagement">× ×™×”×•×œ × ×ª×•× ×™×</span></h2>

                <div class="setting-row">
                    <div class="setting-label">
                        <span data-i18n="settings.exportData">×™×™×¦×•× × ×ª×•× ×™×</span>
                        <span data-i18n="settings.exportDataDesc">×”×•×¨×“ ××ª ×›×œ ×”× ×ª×•× ×™× ×›×§×•×‘×¥ JSON</span>
                    </div>
                    <button class="btn btn-secondary" onclick="App.exportData()">
                        <span>ğŸ“¤</span>
                        <span data-i18n="settings.exportBtn">×™×™×¦×•×</span>
                    </button>
                </div>

                <div class="setting-row">
                    <div class="setting-label">
                        <span data-i18n="settings.importData">×™×™×‘×•× × ×ª×•× ×™×</span>
                        <span data-i18n="settings.importDataDesc">×©×—×–×¨ × ×ª×•× ×™× ××§×•×‘×¥ JSON</span>
                    </div>
                    <button class="btn btn-secondary" onclick="App.importData()">
                        <span>ğŸ“¥</span>
                        <span data-i18n="settings.importBtn">×™×™×‘×•×</span>
                    </button>
                </div>

                <div class="setting-row">
                    <div class="setting-label">
                        <span data-i18n="settings.loadSampleData">×˜×¢×Ÿ × ×ª×•× ×™ ×“×•×’××”</span>
                        <span data-i18n="settings.loadSampleDataDesc">××™×œ×•×™ ×”××¤×œ×™×§×¦×™×” ×‘× ×ª×•× ×™ ×”×“×’××”</span>
                    </div>
                    <button class="btn btn-secondary" onclick="loadSampleData()">
                        <span>ğŸ“‹</span>
                        <span data-i18n="settings.loadSampleBtn">×˜×¢×Ÿ ×“×•×’××”</span>
                    </button>
                </div>
            </div>

            <!-- App Lock (PIN) -->
            <div class="settings-section" style="border-color: rgba(16, 185, 129, 0.3);">
                <h2>ğŸ” <span data-i18n="pinLock.appLock">× ×¢×™×œ×ª ××¤×œ×™×§×¦×™×”</span></h2>
                <p style="color: var(--color-text-secondary); margin-bottom: 20px;" data-i18n="pinLock.appLockDesc">×”×’×Ÿ ×¢×œ ×”× ×ª×•× ×™× ×©×œ×š ×¢× ×§×•×“ PIN</p>

                <div class="setting-row">
                    <div class="setting-label">
                        <span data-i18n="pinLock.enablePin">×”×¤×¢×œ ×§×•×“ PIN</span>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="pinToggle" onchange="togglePinLock()">
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div id="pinEnabledOptions" style="display: none;">
                    <div class="setting-row">
                        <div class="setting-label">
                            <span data-i18n="pinLock.changePin">×©× ×” ×§×•×“ PIN</span>
                        </div>
                        <button class="btn btn-secondary" onclick="changePinCode()">
                            <span>ğŸ”‘</span>
                            <span data-i18n="pinLock.changePin">×©× ×” ×§×•×“ PIN</span>
                        </button>
                    </div>

                    <div class="setting-row">
                        <div class="setting-label">
                            <span data-i18n="pinLock.autoLockAfter">× ×¢×™×œ×” ××•×˜×•××˜×™×ª ××—×¨×™</span>
                        </div>
                        <div class="budget-input">
                            <select id="autoLockTimeout" onchange="saveAutoLockTimeout()" style="padding: 8px 12px; background: var(--color-bg-card); border: 1px solid var(--color-border); border-radius: 8px; color: white;">
                                <option value="1">1</option>
                                <option value="5">5</option>
                                <option value="10">10</option>
                                <option value="15">15</option>
                                <option value="30">30</option>
                            </select>
                            <span data-i18n="pinLock.minutes">×“×§×•×ª</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Security Status (Live) -->
            <div class="settings-section" style="border-color: rgba(16, 185, 129, 0.3);">
                <h2>ğŸ›¡ï¸ <span data-i18n="security.statusTitle">×¡×˜×˜×•×¡ ××‘×˜×—×”</span></h2>
                <div id="securityStatusPanel">
                    <div class="setting-row">
                        <div class="setting-label">
                            <span data-i18n="security.encryptionStatus">×¡×˜×˜×•×¡ ×”×¦×¤× ×”</span>
                        </div>
                        <span id="secStatusPin" style="font-size: 0.9rem;"></span>
                    </div>
                    <div class="setting-row">
                        <div class="setting-label">
                            <span data-i18n="security.cloudEncryption">×”×¦×¤× ×ª ×¢× ×Ÿ</span>
                        </div>
                        <span id="secStatusCloud" style="font-size: 0.9rem;"></span>
                    </div>
                    <div class="setting-row">
                        <div class="setting-label">
                            <span data-i18n="security.failedAttempts">× ×™×¡×™×•× ×•×ª ×›×•×©×œ×™× (×¡×©×Ÿ × ×•×›×—×™)</span>
                        </div>
                        <span id="secStatusFails" style="font-size: 0.9rem;">0</span>
                    </div>
                    <div class="setting-row">
                        <div class="setting-label">
                            <span data-i18n="security.lastSync">×¡× ×›×¨×•×Ÿ ××—×¨×•×Ÿ</span>
                        </div>
                        <span id="secStatusLastSync" style="font-size: 0.9rem;">â€”</span>
                    </div>
                </div>
            </div>

            <!-- Security & Privacy -->
            <div class="settings-section" style="border-color: rgba(16, 185, 129, 0.3);">
                <h2>ğŸ”’ <span data-i18n="settings.securityPrivacy">××‘×˜×—×” ×•×¤×¨×˜×™×•×ª</span></h2>

                <div class="setting-row">
                    <div class="setting-label" style="max-width: 100%; flex: 1;">
                        <span style="color: #10b981; font-size: 1.05rem;" data-i18n="settings.howDataProtected">××™×š ×”× ×ª×•× ×™× ×©×œ×š ××•×’× ×™×</span>
                    </div>
                </div>

                <div style="padding: 15px 0; color: var(--color-text-secondary); font-size: 0.9rem; line-height: 1.8;">
                    <div style="display: flex; align-items: flex-start; gap: 10px; margin-bottom: 12px;">
                        <span style="font-size: 1.2rem;">ğŸ’¾</span>
                        <span><strong style="color: var(--color-text-primary);" data-i18n="settings.localStorage">××—×¡×•×Ÿ ××§×•××™</strong> - <span data-i18n="settings.localStorageDesc">×”× ×ª×•× ×™× × ×©××¨×™× ×¢×œ ×”××›×©×™×¨ ×©×œ×š ×‘×œ×‘×“. ××£ ×©×¨×ª ×—×™×¦×•× ×™ ×œ× ××§×‘×œ ×’×™×©×” ××•×˜×•××˜×™×ª.</span></span>
                    </div>
                    <div style="display: flex; align-items: flex-start; gap: 10px; margin-bottom: 12px;">
                        <span style="font-size: 1.2rem;">â˜ï¸</span>
                        <span><strong style="color: var(--color-text-primary);" data-i18n="settings.cloudSync">×¡× ×›×¨×•×Ÿ ×¢× ×Ÿ (××•×¤×¦×™×•× ×œ×™)</strong> - <span data-i18n="settings.cloudSyncDesc">×¨×§ ×× ×ª×ª×—×‘×¨ ×¢× Google. ×”× ×ª×•× ×™× ××•×¦×¤× ×™× ×œ×¤× ×™ ×”×¢×œ××” ×œ×¢× ×Ÿ ×•×¨×§ ××ª×” ×™×›×•×œ ×œ×¤×¢× ×— ××•×ª×.</span></span>
                    </div>
                    <div style="display: flex; align-items: flex-start; gap: 10px; margin-bottom: 12px;">
                        <span style="font-size: 1.2rem;">ğŸš«</span>
                        <span><strong style="color: var(--color-text-primary);" data-i18n="settings.noBankPasswords">×œ×œ× ×¡×™×¡×××•×ª ×‘× ×§</strong> - <span data-i18n="settings.noBankPasswordsDesc">×”××¤×œ×™×§×¦×™×” ×œ× ×©×•××¨×ª ×¡×™×¡×××•×ª, ×§×•×“×™ ×’×™×©×” ××• ×¤×¨×˜×™ ×”×ª×—×‘×¨×•×ª ×œ×‘× ×§.</span></span>
                    </div>
                    <div style="display: flex; align-items: flex-start; gap: 10px; margin-bottom: 12px;">
                        <span style="font-size: 1.2rem;">ğŸ”</span>
                        <span><strong style="color: var(--color-text-primary);" data-i18n="settings.aesEncryption">×”×¦×¤× ×ª AES-256</strong> - <span data-i18n="settings.aesEncryptionDesc">×›×œ ×”× ×ª×•× ×™× ×”×¨×’×™×©×™× ××•×¦×¤× ×™× ×‘×”×¦×¤× ×” ×¦×‘××™×ª ×œ×¤× ×™ ×©×œ×™×—×” ×œ×¢× ×Ÿ.</span></span>
                    </div>
                    <div style="display: flex; align-items: flex-start; gap: 10px; margin-bottom: 12px;">
                        <span style="font-size: 1.2rem;">â±ï¸</span>
                        <span><strong style="color: var(--color-text-primary);" data-i18n="settings.autoLogout">×”×ª× ×ª×§×•×ª ××•×˜×•××˜×™×ª</strong> - <span data-i18n="settings.autoLogoutDesc">×œ××—×¨ 30 ×“×§×•×ª ×œ×œ× ×¤×¢×™×œ×•×ª, ×”××¢×¨×›×ª ××ª× ×ª×§×ª ××•×˜×•××˜×™×ª.</span></span>
                    </div>
                    <div style="display: flex; align-items: flex-start; gap: 10px;">
                        <span style="font-size: 1.2rem;">ğŸ—‘ï¸</span>
                        <span><strong style="color: var(--color-text-primary);" data-i18n="settings.fullDeletion">××—×™×§×” ××œ××”</strong> - <span data-i18n="settings.fullDeletionDesc">×‘×›×œ ×¨×’×¢ ×ª×•×›×œ ×œ××—×•×§ ××ª ×›×œ ×”× ×ª×•× ×™× ×©×œ×š ××”××›×©×™×¨ ×•××”×¢× ×Ÿ.</span></span>
                    </div>
                </div>
            </div>

            <!-- Danger Zone -->
            <div class="settings-section danger-zone">
                <h2>âš ï¸ <span data-i18n="settings.dangerZone">××–×•×¨ ×¡×›× ×”</span></h2>

                <div class="setting-row">
                    <div class="setting-label">
                        <span data-i18n="settings.deleteAllData">××—×§ ××ª ×›×œ ×”× ×ª×•× ×™×</span>
                        <span data-i18n="settings.deleteAllDataDesc">××—×™×§×” ××”××›×©×™×¨ ×•××”×¢× ×Ÿ - ×¤×¢×•×œ×” ×‘×œ×ª×™ ×”×¤×™×›×”!</span>
                    </div>
                    <button class="btn btn-danger" onclick="Auth.deleteAllData()">
                        <span>ğŸ—‘ï¸</span>
                        <span data-i18n="settings.deleteAllBtn">××—×§ ×”×›×œ</span>
                    </button>
                </div>
            </div>
        </main>

        <button class="mobile-menu-toggle">â˜°</button>
    </div>

    <!-- Add Category Modal -->
    <div class="modal-overlay" id="categoryModal">
        <div class="modal">
            <div class="modal-header">
                <h2 data-i18n="settings.addCategory">×”×•×¡×£ ×§×˜×’×•×¨×™×”</h2>
                <button class="modal-close" onclick="closeCategoryModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="categoryForm">
                    <div class="form-group">
                        <label data-i18n="settings.categoryIcon">××™×™×§×•×Ÿ</label>
                        <select class="form-control" id="catIcon">
                            <option value="ğŸ›’" data-i18n="settings.catIcons.shopping">ğŸ›’ ×§× ×™×•×ª</option>
                            <option value="ğŸ" data-i18n="settings.catIcons.gifts">ğŸ ××ª× ×•×ª</option>
                            <option value="ğŸ•" data-i18n="settings.catIcons.pets">ğŸ• ×—×™×•×ª ××—××“</option>
                            <option value="ğŸ‹ï¸" data-i18n="settings.catIcons.sports">ğŸ‹ï¸ ×¡×¤×•×¨×˜</option>
                            <option value="ğŸ’‡" data-i18n="settings.catIcons.grooming">ğŸ’‡ ×˜×™×¤×•×—</option>
                            <option value="ğŸ " data-i18n="settings.catIcons.home">ğŸ  ×‘×™×ª</option>
                            <option value="ğŸ‘¶" data-i18n="settings.catIcons.kids">ğŸ‘¶ ×™×œ×“×™×</option>
                            <option value="ğŸ“±" data-i18n="settings.catIcons.technology">ğŸ“± ×˜×›× ×•×œ×•×’×™×”</option>
                            <option value="ğŸµ" data-i18n="settings.catIcons.music">ğŸµ ××•×–×™×§×”</option>
                            <option value="ğŸ“š" data-i18n="settings.catIcons.books">ğŸ“š ×¡×¤×¨×™×</option>
                            <option value="âœˆï¸" data-i18n="settings.catIcons.travel">âœˆï¸ × ×¡×™×¢×•×ª</option>
                            <option value="ğŸ·" data-i18n="settings.catIcons.alcohol">ğŸ· ××œ×›×•×”×•×œ</option>
                            <option value="â˜•" data-i18n="settings.catIcons.coffee">â˜• ×§×¤×”</option>
                            <option value="ğŸ’Š" data-i18n="settings.catIcons.medicine">ğŸ’Š ×ª×¨×•×¤×•×ª</option>
                            <option value="ğŸ”§" data-i18n="settings.catIcons.repairs">ğŸ”§ ×ª×™×§×•× ×™×</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label data-i18n="settings.categoryNameHe">×©× ×‘×¢×‘×¨×™×ª</label>
                        <input type="text" class="form-control" id="catNameHe" required placeholder="×œ×“×•×’××”: ×—×™×•×ª ××—××“">
                    </div>

                    <div class="form-group">
                        <label data-i18n="settings.categoryNameEn">×©× ×‘×× ×’×œ×™×ª</label>
                        <input type="text" class="form-control" id="catNameEn" placeholder="e.g. Pets">
                    </div>

                    <div class="form-group">
                        <label data-i18n="settings.categoryColor">×¦×‘×¢</label>
                        <input type="color" class="form-control" id="catColor" value="#6366f1" style="height: 50px; padding: 5px;">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeCategoryModal()" data-i18n="common.cancel">×‘×™×˜×•×œ</button>
                <button class="btn btn-primary" onclick="saveCategory()" data-i18n="common.save">×©××•×¨</button>
            </div>
        </div>
    </div>

    <script src="../js/storage.js"></script>
    <script src="../js/pin-lock.js"></script>
    <script src="../js/i18n.js"></script>
    <script src="../js/alerts.js"></script>
    <script src="../js/tags.js"></script>
    <script src="../js/notifications.js"></script>
    <script src="../data/sample-data.js"></script>
    <script src="../js/app.js"></script>
    <script src="../js/firebase-config.js"></script>
    <script src="../js/crypto.js"></script>
    <script src="../js/auth.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            App.currentPage = 'settings';
            I18n.init();
            loadSettings();
            loadNotificationSettings();
            loadPinSettings();
            loadSecurityStatus();
        });

        function loadSecurityStatus() {
            const pinEnabled = PinLock.isEnabled();
            const pinEl = document.getElementById('secStatusPin');
            if (pinEl) {
                if (pinEnabled) {
                    pinEl.textContent = 'âœ… ' + I18n.t('security.encryptionEnabled');
                    pinEl.style.color = '#10b981';
                } else {
                    pinEl.textContent = 'âš ï¸ ' + I18n.t('security.encryptionDisabled');
                    pinEl.style.color = '#f59e0b';
                }
            }

            const cloudEl = document.getElementById('secStatusCloud');
            if (cloudEl) {
                if (typeof Auth !== 'undefined' && Auth.currentUser) {
                    cloudEl.textContent = 'âœ… ' + I18n.t('security.cloudEncryptionActive');
                    cloudEl.style.color = '#10b981';
                } else {
                    cloudEl.textContent = 'â€” ' + I18n.t('security.cloudNotConnected');
                    cloudEl.style.color = 'var(--color-text-secondary)';
                }
            }

            const failsEl = document.getElementById('secStatusFails');
            if (failsEl) {
                const fails = parseInt(sessionStorage.getItem('pin_fail_count')) || 0;
                failsEl.textContent = String(fails);
                failsEl.style.color = fails > 0 ? '#ef4444' : '#10b981';
            }

            const syncEl = document.getElementById('secStatusLastSync');
            if (syncEl) {
                const lastUpdate = localStorage.getItem('finance_last_update');
                if (lastUpdate) {
                    const d = new Date(lastUpdate);
                    syncEl.textContent = d.toLocaleDateString('he-IL') + ' ' + d.toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' });
                } else {
                    syncEl.textContent = 'â€”';
                }
            }
        }

        // PIN Lock Settings
        function loadPinSettings() {
            const enabled = PinLock.isEnabled();
            document.getElementById('pinToggle').checked = enabled;
            document.getElementById('pinEnabledOptions').style.display = enabled ? 'block' : 'none';
            if (enabled) {
                document.getElementById('autoLockTimeout').value = PinLock.getTimeout();
            }
        }

        function togglePinLock() {
            const checkbox = document.getElementById('pinToggle');
            if (checkbox.checked) {
                // Enable PIN â€” show setup screen
                PinLock.showSetupScreen(async (pin) => {
                    await PinLock.enable(pin);
                    App.notify(I18n.t('pinLock.pinEnabled'), 'success');
                    loadPinSettings();
                });
                // If user cancels, revert checkbox
                const checkCancel = setInterval(() => {
                    const overlay = document.getElementById('pinLockOverlay');
                    if (!overlay || overlay.style.display === 'none') {
                        clearInterval(checkCancel);
                        if (!PinLock.isEnabled()) {
                            checkbox.checked = false;
                        }
                    }
                }, 300);
            } else {
                // Disable PIN â€” verify current PIN first
                PinLock.showVerifyScreen(async (pin) => {
                    await PinLock.disable(pin);
                    App.notify(I18n.t('pinLock.pinDisabled'), 'success');
                    loadPinSettings();
                });
                // If user cancels, revert checkbox
                const checkCancel = setInterval(() => {
                    const overlay = document.getElementById('pinLockOverlay');
                    if (!overlay || overlay.style.display === 'none') {
                        clearInterval(checkCancel);
                        if (PinLock.isEnabled()) {
                            checkbox.checked = true;
                        }
                    }
                }, 300);
            }
        }

        function changePinCode() {
            PinLock.showVerifyScreen(async (oldPin) => {
                PinLock.showSetupScreen(async (newPin) => {
                    await PinLock.changePin(oldPin, newPin);
                    App.notify(I18n.t('pinLock.pinChanged'), 'success');
                });
            });
        }

        function saveAutoLockTimeout() {
            const val = parseInt(document.getElementById('autoLockTimeout').value);
            PinLock.setTimeout(val);
            PinLock._resetTimer();
        }

        function loadSettings() {
            // Load budget settings
            const budgets = Alerts.getBudgets();
            document.getElementById('totalBudget').value = budgets.total || '';

            // Load thresholds
            const thresholds = Alerts.getThresholds();
            document.getElementById('warningThreshold').value = thresholds.warning || 80;
            document.getElementById('dangerThreshold').value = thresholds.danger || 100;

            // Render category budgets
            const categories = Tags.getCategories();
            document.getElementById('categoryBudgets').innerHTML = categories.map(cat => {
                const budget = budgets.categories[cat.id] || '';
                return `
                    <div class="category-budget">
                        <span class="category-icon">${cat.icon}</span>
                        <span class="category-name">${I18n.currentLanguage === 'he' ? cat.nameHe : cat.nameEn}</span>
                        <div class="budget-input">
                            <span>â‚ª</span>
                            <input type="number" value="${budget}" step="100"
                                   onchange="saveCategoryBudget('${cat.id}', this.value)"
                                   placeholder="${I18n.t('settings.noLimit')}">
                        </div>
                    </div>
                `;
            }).join('');

            // Render custom categories
            const customData = Tags.getCustomData();
            const customContainer = document.getElementById('customCategories');

            if (customData.categories.length === 0) {
                customContainer.innerHTML = `<p style="color: var(--color-text-secondary);">${I18n.t('settings.noCustomCategories')}</p>`;
            } else {
                customContainer.innerHTML = customData.categories.map(cat => `
                    <div class="custom-category-item">
                        <span style="font-size: 1.5rem;">${cat.icon}</span>
                        <div class="color-preview" style="background: ${cat.color};"></div>
                        <span style="flex: 1;">${I18n.currentLanguage === 'he' ? cat.nameHe : cat.nameEn}</span>
                        <button class="btn btn-danger btn-sm" onclick="deleteCustomCategory('${cat.id}')">ğŸ—‘ï¸</button>
                    </div>
                `).join('');
            }
        }

        function saveTotalBudget() {
            const amount = parseFloat(document.getElementById('totalBudget').value) || 0;
            Alerts.setTotalBudget(amount);
            App.notify(I18n.t('settings.budgetSaved'), 'success');
        }

        function saveThresholds() {
            const warning = parseInt(document.getElementById('warningThreshold').value) || 80;
            const danger = parseInt(document.getElementById('dangerThreshold').value) || 100;

            if (warning >= danger) {
                App.notify(I18n.t('settings.thresholdError'), 'error');
                return;
            }

            Alerts.setThresholds(warning, danger);
            App.notify(I18n.t('settings.thresholdSaved'), 'success');
        }

        function saveCategoryBudget(category, value) {
            const amount = parseFloat(value) || 0;
            Alerts.setCategoryBudget(category, amount);
            App.notify(I18n.t('settings.budgetSaved'), 'success');
        }

        function openCategoryModal() {
            document.getElementById('categoryForm').reset();
            document.getElementById('categoryModal').classList.add('active');
        }

        function closeCategoryModal() {
            document.getElementById('categoryModal').classList.remove('active');
        }

        function saveCategory() {
            const icon = document.getElementById('catIcon').value;
            const nameHe = document.getElementById('catNameHe').value;
            const nameEn = document.getElementById('catNameEn').value || nameHe;
            const color = document.getElementById('catColor').value;

            if (!nameHe) {
                App.notify(I18n.t('settings.enterName'), 'error');
                return;
            }

            Tags.addCategory({ icon, nameHe, nameEn, color });
            closeCategoryModal();
            loadSettings();
            App.notify(I18n.t('settings.categoryAdded'), 'success');
        }

        function deleteCustomCategory(id) {
            if (confirm(I18n.t('settings.deleteCategory'))) {
                Tags.deleteCategory(id);
                loadSettings();
                App.notify(I18n.t('settings.categoryDeleted'), 'success');
            }
        }

        function loadSampleData() {
            if (confirm(I18n.t('settings.sampleDataConfirm'))) {
                SampleData.load();
            }
        }

        function clearAllData() {
            if (confirm(I18n.t('settings.deleteAllConfirm'))) {
                if (confirm(I18n.t('settings.deleteAllConfirm2'))) {
                    SampleData.clear();
                }
            }
        }

        // Notification Settings
        function loadNotificationSettings() {
            const statusEl = document.getElementById('notificationStatus');
            const toggleBtn = document.getElementById('notificationToggle');
            const optionsEl = document.getElementById('notificationOptions');

            if (!Notifications.isSupported()) {
                statusEl.textContent = I18n.t('settings.notificationsNotSupported');
                statusEl.className = 'notification-denied';
                toggleBtn.disabled = true;
                toggleBtn.textContent = I18n.t('settings.notSupported');
                return;
            }

            const permission = Notifications.getPermission();
            const settings = Notifications.getSettings();

            switch (permission) {
                case 'granted':
                    statusEl.textContent = I18n.t('settings.notificationsEnabled');
                    statusEl.className = 'notification-granted';
                    toggleBtn.textContent = I18n.t('settings.enabled');
                    toggleBtn.classList.remove('btn-primary');
                    toggleBtn.classList.add('btn-secondary');
                    optionsEl.style.display = 'block';
                    break;
                case 'denied':
                    statusEl.textContent = I18n.t('settings.notificationsBlocked');
                    statusEl.className = 'notification-denied';
                    toggleBtn.textContent = I18n.t('settings.notificationsBlockedShort');
                    toggleBtn.disabled = true;
                    break;
                default:
                    statusEl.textContent = I18n.t('settings.clickToEnable');
                    statusEl.className = 'notification-default';
                    toggleBtn.textContent = I18n.t('settings.enable');
            }

            // Load settings
            document.getElementById('stockAlertsToggle').checked = settings.stockAlerts;
            document.getElementById('budgetAlertsToggle').checked = settings.budgetWarnings;
            document.getElementById('monthlyReminderToggle').checked = settings.monthlyReminder;
            document.getElementById('reminderDay').value = settings.reminderDay || 1;
        }

        async function toggleNotifications() {
            const result = await Notifications.requestPermission();

            if (result.success) {
                App.notify(I18n.t('settings.notificationsEnabledMsg'), 'success');
            } else if (result.permission === 'denied') {
                App.notify(I18n.t('settings.notificationsBlockedMsg'), 'error');
            }

            loadNotificationSettings();
        }

        function saveNotificationSettings() {
            const settings = {
                stockAlerts: document.getElementById('stockAlertsToggle').checked,
                budgetWarnings: document.getElementById('budgetAlertsToggle').checked,
                monthlyReminder: document.getElementById('monthlyReminderToggle').checked,
                reminderDay: parseInt(document.getElementById('reminderDay').value) || 1
            };

            Notifications.updateSettings(settings);
            App.notify(I18n.t('settings.settingsSaved'), 'success');
        }

        async function sendTestNotification() {
            const success = await Notifications.show(I18n.t('settings.testNotificationTitle'), {
                body: I18n.t('settings.testNotificationBody'),
                type: 'test'
            });

            if (success) {
                App.notify(I18n.t('settings.testSent'), 'success');
            } else {
                App.notify(I18n.t('settings.testError'), 'error');
            }
        }
    </script>
</body>
</html>
