<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="../img/logo.png">
    <meta name="theme-color" content="#3b82f6">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://www.gstatic.com https://apis.google.com; style-src 'self' 'unsafe-inline'; img-src 'self' https: data:; connect-src 'self' https://*.googleapis.com https://*.firebaseio.com https://*.firebaseapp.com wss://*.firebaseio.com; frame-src https://accounts.google.com https://*.firebaseapp.com; object-src 'none'; base-uri 'self'; form-action 'self' https://accounts.google.com;">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <link rel="manifest" href="../manifest.json">
    <link rel="icon" type="image/png" href="../img/logo.png">
    <title>×—×©×‘×•× ×•×ª ×‘× ×§ - FinSight</title>
    <link rel="stylesheet" href="../css/app.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        .nav-link.active { background: var(--color-bank) !important; }
        .page-header h1 { color: var(--color-bank); }
        .btn-primary { background: var(--color-bank); }
        .btn-primary:hover { background: #2563eb; }
    </style>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar Navigation -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="brand">
                    <img src="../img/logo.png" class="brand-icon" alt="FinSight">
                    <span class="brand-name">Fin<span class="brand-highlight">Sight</span></span>
                </div>
            </div>

            <nav>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a href="../index.html" class="nav-link" data-category="dashboard">
                            <span class="icon">ğŸ </span>
                            <span data-i18n="nav.dashboard">×“××©×‘×•×¨×“</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="bank.html" class="nav-link active" data-category="bank">
                            <span class="icon">ğŸ¦</span>
                            <span data-i18n="nav.bankAccounts">×—×©×‘×•× ×•×ª ×‘× ×§</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="credit.html" class="nav-link" data-category="credit">
                            <span class="icon">ğŸ’³</span>
                            <span data-i18n="nav.creditCards">×›×¨×˜×™×¡×™ ××©×¨××™</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="stocks.html" class="nav-link" data-category="stocks">
                            <span class="icon">ğŸ“ˆ</span>
                            <span data-i18n="nav.stocks">×× ×™×•×ª</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <span class="nav-link" style="cursor: default;">
                            <span class="icon">ğŸ“Š</span>
                            <span data-i18n="nav.financialProducts">××•×¦×¨×™× ×¤×™× × ×¡×™×™×</span>
                        </span>
                        <ul class="nav-submenu">
                            <li class="nav-item"><a href="market-products.html" class="nav-link" data-category="market-products"><span data-i18n="nav.marketProducts">ğŸª ××•×¦×¨×™× ×‘×©×•×§</span></a></li>
                            <li class="nav-item"><a href="my-funds.html" class="nav-link" data-category="my-products"><span data-i18n="nav.myProducts">ğŸ’ ×”×—×¡×›×•× ×•×ª ×©×œ×™</span></a></li>
                        </ul>
                    </li>
                    <li class="nav-item">
                        <a href="assets.html" class="nav-link" data-category="assets">
                            <span class="icon">ğŸ </span>
                            <span data-i18n="nav.assets">× ×›×¡×™×</span>
                        </a>
                    </li>
                    <li class="nav-item"><a href="loans.html" class="nav-link" data-category="loans"><span class="icon">ğŸ¦</span><span data-i18n="nav.loans">×”×œ×•×•××•×ª</span></a></li>
                    <li class="nav-item">
                        <a href="goals.html" class="nav-link" data-category="goals">
                            <span class="icon">ğŸ¯</span>
                            <span data-i18n="nav.goals">×™×¢×“×™ ×—×™×¡×›×•×Ÿ</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="pension-calc.html" class="nav-link" data-category="pension-calc">
                            <span class="icon">ğŸ§®</span>
                            <span data-i18n="nav.pensionCalc">××—×©×‘×•×Ÿ ×¤× ×¡×™×”</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="reports.html" class="nav-link" data-category="reports">
                            <span class="icon">ğŸ“‹</span>
                            <span data-i18n="nav.reports">×“×•×—×•×ª</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="profile.html" class="nav-link">
                            <span class="icon">ğŸ‘¤</span>
                            <span data-i18n="nav.profile">×¤×¨×•×¤×™×œ ×¤×™× × ×¡×™</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="settings.html" class="nav-link" data-category="settings">
                            <span class="icon">âš™ï¸</span>
                            <span data-i18n="nav.settings">×”×’×“×¨×•×ª</span>
                        </a>
                    </li>
                </ul>
            </nav>

            <div class="sidebar-footer">
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="logo-hero">
                <img src="../img/logo.png" alt="FinSight" class="logo-hero-img">
            </div>
            <header class="page-header">
                <h1>
                    <span>ğŸ¦</span>
                    <span data-i18n="bank.title">×—×©×‘×•× ×•×ª ×‘× ×§</span>
                </h1>
            </header>

            <!-- Total Balance Card -->
            <div class="net-worth-banner" style="border-color: var(--color-bank);">
                <div class="label" data-i18n="bank.balance">×™×ª×¨×” ×›×•×œ×œ×ª</div>
                <div class="value" id="totalBalance" style="background: linear-gradient(90deg, var(--color-bank), #60a5fa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">â‚ª0</div>
            </div>

            <!-- Add Account Button -->
            <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="openAddModal()">
                    <span>â•</span>
                    <span data-i18n="bank.addAccount">×”×•×¡×£ ×—×©×‘×•×Ÿ</span>
                </button>
                <button class="btn btn-secondary" onclick="importSmartFile()">
                    <span>ğŸ“¥</span>
                    <span data-i18n="bank.smartImport">×™×™×‘×•× × ×ª×•× ×™×</span>
                </button>
                <button class="btn btn-secondary" onclick="ImageImport.openImagePicker('bank')">
                    <span>ğŸ“·</span>
                    <span data-i18n="bank.importImage">×™×™×‘×•× ××ª××•× ×”</span>
                </button>
            </div>

            <!-- Accounts List -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <span class="icon">ğŸ“‹</span>
                        <span data-i18n="bank.title">×—×©×‘×•× ×•×ª ×‘× ×§</span>
                    </h2>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th data-i18n="bank.accountName">×©× ×”×—×©×‘×•×Ÿ</th>
                                <th data-i18n="bank.bankName">×‘× ×§</th>
                                <th data-i18n="bank.accountNumber">××¡×¤×¨ ×—×©×‘×•×Ÿ</th>
                                <th data-i18n="bank.balance">×™×ª×¨×”</th>
                                <th data-i18n="common.actions">×¤×¢×•×œ×•×ª</th>
                            </tr>
                        </thead>
                        <tbody id="accountsTable">
                            <!-- Will be populated by JS -->
                        </tbody>
                        <tfoot id="accountsFooter" style="display: none;">
                            <tr style="background: var(--color-bg-secondary); font-weight: bold;">
                                <td colspan="3" style="text-align: right;" data-i18n="bank.totalBalanceLabel">×¡×”"×› ×™×ª×¨×•×ª</td>
                                <td id="totalBalanceFooter">â‚ª0</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

            <!-- Balance History Chart -->
            <div class="card" id="historyCard" style="display: none;">
                <div class="card-header">
                    <h2 class="card-title">
                        <span class="icon">ğŸ“ˆ</span>
                        <span data-i18n="bank.balanceHistory">×”×™×¡×˜×•×¨×™×™×ª ×™×ª×¨×•×ª</span>
                    </h2>
                </div>
                <div class="chart-container">
                    <canvas id="balanceHistoryChart"></canvas>
                </div>
            </div>
        </main>

        <!-- Mobile Menu Toggle -->
        <button class="mobile-menu-toggle">â˜°</button>
    </div>

    <!-- Add/Edit Account Modal -->
    <div class="modal-overlay" id="accountModal">
        <div class="modal">
            <div class="modal-header">
                <h2 id="modalTitle" data-i18n="bank.addAccount">×”×•×¡×£ ×—×©×‘×•×Ÿ</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="accountForm">
                    <input type="hidden" id="accountId">

                    <div class="form-group">
                        <label data-i18n="bank.accountName">×©× ×”×—×©×‘×•×Ÿ</label>
                        <input type="text" class="form-control" id="accountName" required>
                    </div>

                    <div class="form-group">
                        <label data-i18n="bank.bankName">×‘× ×§</label>
                        <select class="form-control" id="bankName" required>
                            <option value="leumi" data-i18n="bank.banks.leumi">×‘× ×§ ×œ××•××™</option>
                            <option value="hapoalim" data-i18n="bank.banks.hapoalim">×‘× ×§ ×”×¤×•×¢×œ×™×</option>
                            <option value="discount" data-i18n="bank.banks.discount">×‘× ×§ ×“×™×¡×§×•× ×˜</option>
                            <option value="mizrahi" data-i18n="bank.banks.mizrahi">×‘× ×§ ××–×¨×—×™ ×˜×¤×—×•×ª</option>
                            <option value="international" data-i18n="bank.banks.international">×”×‘× ×§ ×”×‘×™× ×œ××•××™</option>
                            <option value="mercantile" data-i18n="bank.banks.mercantile">×‘× ×§ ××¨×›× ×ª×™×œ</option>
                            <option value="otsar" data-i18n="bank.banks.otsar">××•×¦×¨ ×”×—×™×™×œ</option>
                            <option value="yahav" data-i18n="bank.banks.yahav">×‘× ×§ ×™×”×‘</option>
                            <option value="massad" data-i18n="bank.banks.massad">×‘× ×§ ××¡×“</option>
                            <option value="other" data-i18n="bank.banks.other">××—×¨</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label data-i18n="bank.accountNumber">××¡×¤×¨ ×—×©×‘×•×Ÿ</label>
                        <input type="text" class="form-control" id="accountNumber" maxlength="10" pattern="[0-9]{1,10}">
                    </div>

                    <div class="form-group">
                        <label data-i18n="bank.balance">×™×ª×¨×”</label>
                        <input type="number" class="form-control" id="balance" step="0.01" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()" data-i18n="common.cancel">×‘×™×˜×•×œ</button>
                <button class="btn btn-primary" onclick="saveAccount()" data-i18n="common.save">×©××•×¨</button>
            </div>
        </div>
    </div>

    <!-- Update Balance Modal -->
    <div class="modal-overlay" id="updateBalanceModal">
        <div class="modal">
            <div class="modal-header">
                <h2 data-i18n="bank.updateBalance">×¢×“×›×Ÿ ×™×ª×¨×”</h2>
                <button class="modal-close" onclick="closeUpdateModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="updateBalanceForm">
                    <input type="hidden" id="updateAccountId">
                    <div class="form-group">
                        <label data-i18n="bank.balance">×™×ª×¨×” ×—×“×©×”</label>
                        <input type="number" class="form-control" id="newBalance" step="0.01" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeUpdateModal()" data-i18n="common.cancel">×‘×™×˜×•×œ</button>
                <button class="btn btn-primary" onclick="updateBalance()" data-i18n="common.update">×¢×“×›×Ÿ</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="../js/storage.js"></script>
    <script src="../js/pin-lock.js"></script>
    <script src="../js/i18n.js"></script>
    <script src="../js/charts.js"></script>
    <script src="../js/csv-import.js"></script>
    <script src="../js/smart-import.js"></script>
    <script src="../js/image-import.js"></script>
    <script src="../js/app.js"></script>
    <script src="../js/firebase-config.js"></script>
    <script src="../js/crypto.js"></script>
    <script src="../js/auth.js"></script>
    <script>
        // Page specific code
        document.addEventListener('DOMContentLoaded', () => {
            App.currentPage = 'bank';
            loadAccounts();
        });

        function loadAccounts() {
            const accounts = Storage.getBankAccounts();
            const tbody = document.getElementById('accountsTable');
            const totalEl = document.getElementById('totalBalance');

            const footer = document.getElementById('accountsFooter');
            const footerTotal = document.getElementById('totalBalanceFooter');

            if (accounts.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" style="text-align: center; color: var(--color-text-secondary);">${I18n.t('bank.noAccounts')}</td></tr>`;
                totalEl.textContent = I18n.formatCurrency(0);
                footer.style.display = 'none';
                document.getElementById('historyCard').style.display = 'none';
                return;
            }

            const total = accounts.reduce((sum, acc) => sum + (acc.balance || 0), 0);
            totalEl.textContent = I18n.formatCurrency(total);
            footerTotal.textContent = I18n.formatCurrency(total);
            footer.style.display = 'table-footer-group';

            tbody.innerHTML = accounts.map(acc => {
                // Mask account number - show last 4 digits only
                const accNum = acc.accountNumber || '';
                const maskedNum = accNum.length > 4 ? '****' + accNum.slice(-4) : accNum;
                return `
                <tr>
                    <td>${I18n.currentLanguage === 'he' ? acc.nameHe || acc.nameEn : acc.nameEn || acc.nameHe}</td>
                    <td>${I18n.t('bank.banks.' + acc.bank) || acc.bank}</td>
                    <td>${maskedNum}</td>
                    <td>${I18n.formatCurrency(acc.balance)}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-secondary btn-sm" onclick="openUpdateBalanceModal('${acc.id}', ${acc.balance})" title="${I18n.t('bank.updateBalance')}">ğŸ’°</button>
                            <button class="btn btn-secondary btn-sm" onclick="editAccount('${acc.id}')" title="${I18n.t('common.edit')}">âœï¸</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteAccount('${acc.id}')" title="${I18n.t('common.delete')}">ğŸ—‘ï¸</button>
                        </div>
                    </td>
                </tr>
            `;
            }).join('');

            // Show history chart with combined history
            document.getElementById('historyCard').style.display = 'block';
            const combinedHistory = [];
            accounts.forEach(acc => {
                if (acc.history) {
                    acc.history.forEach(h => {
                        const existing = combinedHistory.find(ch => ch.date === h.date);
                        if (existing) {
                            existing.balance += h.balance;
                        } else {
                            combinedHistory.push({ date: h.date, balance: h.balance });
                        }
                    });
                }
            });
            if (combinedHistory.length > 0) {
                Charts.createBalanceHistory('balanceHistoryChart', combinedHistory, I18n.t('bank.balance'), '#3b82f6');
            }
        }

        function openAddModal() {
            document.getElementById('modalTitle').textContent = I18n.t('bank.addAccount');
            document.getElementById('accountForm').reset();
            document.getElementById('accountId').value = '';
            document.getElementById('accountModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('accountModal').classList.remove('active');
        }

        function editAccount(id) {
            const accounts = Storage.getBankAccounts();
            const account = accounts.find(a => a.id === id);
            if (!account) return;

            document.getElementById('modalTitle').textContent = I18n.t('common.edit');
            document.getElementById('accountId').value = account.id;
            document.getElementById('accountName').value = account.nameHe || account.nameEn || '';
            document.getElementById('bankName').value = account.bank;
            document.getElementById('accountNumber').value = account.accountNumber;
            document.getElementById('balance').value = account.balance;
            document.getElementById('accountModal').classList.add('active');
        }

        function saveAccount() {
            const id = document.getElementById('accountId').value;
            const nameHe = document.getElementById('accountName').value;
            const bank = document.getElementById('bankName').value;
            const accountNumber = document.getElementById('accountNumber').value;
            const balance = parseFloat(document.getElementById('balance').value);

            if (!nameHe || !balance) {
                App.notify('Please fill all required fields', 'error');
                return;
            }

            if (id) {
                // Update existing
                Storage.updateBankAccount(id, { nameHe, nameEn: nameHe, bank, accountNumber, balance });
            } else {
                // Add new
                Storage.addBankAccount({ nameHe, nameEn: nameHe, bank, accountNumber, balance, currency: 'ILS' });
            }

            closeModal();
            loadAccounts();
            App.notify(I18n.t('common.save') + ' âœ“', 'success');
        }

        function openUpdateBalanceModal(id, currentBalance) {
            document.getElementById('updateAccountId').value = id;
            document.getElementById('newBalance').value = currentBalance;
            document.getElementById('updateBalanceModal').classList.add('active');
        }

        function closeUpdateModal() {
            document.getElementById('updateBalanceModal').classList.remove('active');
        }

        function updateBalance() {
            const id = document.getElementById('updateAccountId').value;
            const newBalance = parseFloat(document.getElementById('newBalance').value);

            Storage.updateBankAccount(id, { balance: newBalance });
            closeUpdateModal();
            loadAccounts();
            App.notify(I18n.t('bank.updateBalance') + ' âœ“', 'success');
        }

        function deleteAccount(id) {
            if (confirm(I18n.t('common.confirmDelete'))) {
                Storage.deleteBankAccount(id);
                loadAccounts();
                App.notify(I18n.t('common.delete') + ' âœ“', 'success');
            }
        }

        function parseHTMLTable(html) {
            const rows = [];
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');

            // Prefer dataTable class, fallback to any table
            let tables = doc.querySelectorAll('table.dataTable');
            if (tables.length === 0) {
                tables = doc.querySelectorAll('table');
            }

            const seenRows = new Set();

            for (const table of tables) {
                const tableRows = table.querySelectorAll('tr');
                for (const tr of tableRows) {
                    const cells = tr.querySelectorAll('th, td');
                    if (cells.length >= 2 && cells.length <= 10) {
                        const rowData = [];
                        cells.forEach(cell => {
                            // Clean up text - remove extra spaces and special characters
                            let text = cell.textContent.trim()
                                .replace(/\s+/g, ' ')
                                .replace(/[â€â€\u200e\u200f]/g, ''); // Remove RTL/LTR marks
                            rowData.push(text);
                        });

                        // Skip empty or duplicate rows
                        const rowKey = rowData.join('|');
                        if (rowData.some(cell => cell.length > 0) && !seenRows.has(rowKey)) {
                            seenRows.add(rowKey);
                            rows.push(rowData);
                        }
                    }
                }
            }

            return rows;
        }

        // Bank account column mappings (multi-language)
        const bankColumnMappings = {
            name: ['×©×', '×©× ×—×©×‘×•×Ÿ', '×¡×•×’ ×¤×¢×™×œ×•×ª', '×¤×¢×™×œ×•×ª', '×ª×™××•×¨', 'name', 'account name', 'description', 'nome', 'nome da conta', 'descriÃ§Ã£o', 'activity', 'tipo', 'type'],
            bank: ['×‘× ×§', '×©× ×‘× ×§', 'bank', 'bank name', 'banco', 'instituiÃ§Ã£o'],
            accountNumber: ['××¡×¤×¨ ×—×©×‘×•×Ÿ', '×—×©×‘×•×Ÿ', 'account number', 'account', 'nÃºmero', 'nÃºmero da conta', 'conta'],
            balance: ['×™×ª×¨×”', '×™×ª×¨×” ×‘×©', '×™×ª×¨×” ×‘×©×—', '×¡×›×•×', '×¡×›×•× ×‘×©', 'balance', 'amount', 'total', 'value', 'saldo', 'valor', 'montante']
        };

        async function importSmartFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xlsx,.xls,.csv,.html,.txt';

            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                try {
                    let rows = [];
                    const content = await file.text();

                    // Check if it's HTML (bank exports often use .xls for HTML)
                    if (content.includes('<HTML') || content.includes('<html') || content.includes('<table')) {
                        rows = parseHTMLTable(content);
                    } else if (file.name.endsWith('.xls') || file.name.endsWith('.xlsx')) {
                        // Use SheetJS for real Excel files
                        const data = await file.arrayBuffer();
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        rows = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                    } else {
                        // CSV/TXT - use existing parser
                        rows = SmartImport.parseFile(content, file.name);
                    }

                    if (rows.length < 2) {
                        App.notify(I18n.t('bank.fileEmptyOrInvalid'), 'error');
                        return;
                    }

                    // Find header row
                    const headerIdx = findBankHeaderRow(rows);
                    const headers = rows[headerIdx];

                    // Auto-detect columns
                    const detected = detectBankColumns(headers);

                    // If balance column not found, show manual mapping
                    if (detected.balance === undefined) {
                        showColumnMappingModal(headers, rows, headerIdx);
                        return;
                    }

                    // Import the data
                    const imported = importBankData(rows, headerIdx, detected);

                    if (imported > 0) {
                        App.notify(I18n.t('bank.importedAccounts') + ` (${imported})`, 'success');
                        loadAccounts();
                    } else {
                        App.notify(I18n.t('bank.noAccountsToImport'), 'error');
                    }
                } catch (error) {
                    console.error('Import error:', error);
                    App.notify(I18n.t('bank.importError') + ': ' + error.message, 'error');
                }
            };

            input.click();
        }

        function findBankHeaderRow(rows) {
            for (let i = 0; i < Math.min(rows.length, 15); i++) {
                const row = rows[i];
                if (!row || row.length < 2) continue;

                const rowText = row.map(c => String(c || '').toLowerCase()).join(' ');

                // Check for balance-related words
                const hasBalanceWord = bankColumnMappings.balance.some(w => rowText.includes(w.toLowerCase()));
                const hasNameWord = bankColumnMappings.name.some(w => rowText.includes(w.toLowerCase()));

                if (hasBalanceWord || hasNameWord) {
                    return i;
                }
            }
            return 0;
        }

        function detectBankColumns(headers) {
            const detected = {};
            headers.forEach((header, index) => {
                if (!header) return;
                const headerLower = String(header).toLowerCase().trim();
                Object.keys(bankColumnMappings).forEach(field => {
                    if (detected[field] !== undefined) return;
                    const matches = bankColumnMappings[field].some(kw =>
                        headerLower.includes(kw.toLowerCase())
                    );
                    if (matches) detected[field] = index;
                });
            });
            return detected;
        }

        function importBankData(rows, headerIdx, detected) {
            let imported = 0;
            const dataRows = rows.slice(headerIdx + 1);

            for (const row of dataRows) {
                // Skip empty rows and summary rows
                const firstCell = String(row[0] || '').trim();
                if (!firstCell || firstCell.includes('×¡×”"×›') || firstCell.includes('×¡×”×›') || firstCell.includes('total')) continue;

                const balanceVal = row[detected.balance];
                const balance = typeof balanceVal === 'number' ? balanceVal :
                    parseFloat(String(balanceVal || '0').replace(/[^\d.-]/g, ''));
                if (isNaN(balance)) continue;

                const name = detected.name !== undefined ? String(row[detected.name] || I18n.t('bank.importedAccount')).trim() : I18n.t('bank.importedAccount');
                const bank = detected.bank !== undefined ? String(row[detected.bank] || 'other') : 'other';
                const accountNumber = detected.accountNumber !== undefined ?
                    String(row[detected.accountNumber] || '').replace(/[^\d]/g, '').slice(-10) : '';

                // Map bank name to internal key
                const bankKey = mapBankName(bank);

                // Detect account type from name
                let accountType = 'checking';
                if (name.includes('× ×™×™×¨×•×ª ×¢×¨×š') || name.includes('× ×™"×¢')) {
                    accountType = 'securities';
                } else if (name.includes('××˜×‘×¢ ×—×•×¥') || name.includes('××˜"×—')) {
                    accountType = 'forex';
                } else if (name.includes('×›.×. ×—×•×¥') || name.includes('×›×¨×˜×™×¡ ××©×¨××™')) {
                    accountType = 'creditcard';
                }

                Storage.addBankAccount({
                    nameHe: name,
                    nameEn: name,
                    bank: bankKey,
                    accountNumber: accountNumber,
                    balance: balance,
                    currency: 'ILS',
                    type: accountType
                });
                imported++;
            }
            return imported;
        }

        function showColumnMappingModal(headers, rows, headerIdx) {
            // Create modal for manual column mapping
            const modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.id = 'mappingModal';
            modal.innerHTML = `
                <div class="modal" style="max-width: 500px;">
                    <div class="modal-header">
                        <h2>${I18n.t('bank.selectColumns')}</h2>
                        <button class="modal-close" onclick="document.getElementById('mappingModal').remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <p>${I18n.t('bank.autoDetectFailed')}</p>
                        <div class="form-group">
                            <label>${I18n.t('bank.nameDescCol')}</label>
                            <select id="mapName" class="form-control">
                                <option value="-1">${I18n.t('bank.notSelected')}</option>
                                ${headers.map((h, i) => `<option value="${i}">${h || '×¢××•×“×” ' + (i+1)}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>${I18n.t('bank.balanceCol')}</label>
                            <select id="mapBalance" class="form-control" required>
                                <option value="-1">${I18n.t('bank.selectBalanceCol')}</option>
                                ${headers.map((h, i) => `<option value="${i}">${h || '×¢××•×“×” ' + (i+1)}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>${I18n.t('bank.bankCol')}</label>
                            <select id="mapBank" class="form-control">
                                <option value="-1">${I18n.t('bank.notSelected')}</option>
                                ${headers.map((h, i) => `<option value="${i}">${h || '×¢××•×“×” ' + (i+1)}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>${I18n.t('bank.accountCol')}</label>
                            <select id="mapAccount" class="form-control">
                                <option value="-1">${I18n.t('bank.notSelected')}</option>
                                ${headers.map((h, i) => `<option value="${i}">${h || '×¢××•×“×” ' + (i+1)}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="document.getElementById('mappingModal').remove()">${I18n.t('common.cancel')}</button>
                        <button class="btn btn-primary" onclick="applyManualMapping()">${I18n.t('bank.smartImport')}</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // Store data for later use
            window._importData = { rows, headerIdx };
        }

        function applyManualMapping() {
            const balanceIdx = parseInt(document.getElementById('mapBalance').value);
            if (balanceIdx < 0) {
                App.notify(I18n.t('bank.mustSelectBalance'), 'error');
                return;
            }

            const detected = {
                name: parseInt(document.getElementById('mapName').value),
                balance: balanceIdx,
                bank: parseInt(document.getElementById('mapBank').value),
                accountNumber: parseInt(document.getElementById('mapAccount').value)
            };

            // Clean up -1 values
            Object.keys(detected).forEach(k => {
                if (detected[k] < 0) delete detected[k];
            });

            const { rows, headerIdx } = window._importData;
            const imported = importBankData(rows, headerIdx, detected);

            document.getElementById('mappingModal').remove();
            delete window._importData;

            if (imported > 0) {
                App.notify(I18n.t('bank.importedAccounts') + ` (${imported})`, 'success');
                loadAccounts();
            } else {
                App.notify(I18n.t('bank.noAccountsToImport'), 'error');
            }
        }

        function mapBankName(bankText) {
            if (!bankText) return 'other';
            const bankLower = bankText.toLowerCase();

            if (bankLower.includes('×œ××•××™') || bankLower.includes('leumi')) return 'leumi';
            if (bankLower.includes('×¤×•×¢×œ×™×') || bankLower.includes('hapoalim')) return 'hapoalim';
            if (bankLower.includes('×“×™×¡×§×•× ×˜') || bankLower.includes('discount')) return 'discount';
            if (bankLower.includes('××–×¨×—×™') || bankLower.includes('mizrahi')) return 'mizrahi';
            if (bankLower.includes('×‘×™× ×œ××•××™') || bankLower.includes('international')) return 'international';
            if (bankLower.includes('××¨×›× ×ª×™×œ') || bankLower.includes('mercantile')) return 'mercantile';
            if (bankLower.includes('××•×¦×¨') || bankLower.includes('otsar')) return 'otsar';
            if (bankLower.includes('×™×”×‘') || bankLower.includes('yahav')) return 'yahav';
            if (bankLower.includes('××¡×“') || bankLower.includes('massad')) return 'massad';

            return 'other';
        }
    </script>
</body>
</html>
