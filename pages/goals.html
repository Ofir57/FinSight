<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="../img/logo.png">
    <meta name="theme-color" content="#10b981">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://www.gstatic.com https://apis.google.com; style-src 'self' 'unsafe-inline'; img-src 'self' https: data:; connect-src 'self' https://*.googleapis.com https://*.firebaseio.com https://*.firebaseapp.com wss://*.firebaseio.com; frame-src https://accounts.google.com https://*.firebaseapp.com; object-src 'none'; base-uri 'self'; form-action 'self' https://accounts.google.com;">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <link rel="manifest" href="../manifest.json">
    <link rel="icon" type="image/png" href="../img/logo.png">
    <title>×™×¢×“×™ ×—×™×¡×›×•×Ÿ - FinSight</title>
    <link rel="stylesheet" href="../css/app.css">
    <style>
        .nav-link.active { background: var(--color-dashboard) !important; }
        .page-header h1 { color: var(--color-dashboard); }
        .btn-primary { background: var(--color-dashboard); }
        .btn-primary:hover { background: #059669; }

        .goal-card {
            background: var(--color-bg-card);
            border: 1px solid var(--color-border);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .goal-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .goal-title {
            font-size: 1.3rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .goal-icon {
            font-size: 2rem;
        }

        .goal-deadline {
            color: var(--color-text-secondary);
            font-size: 0.9rem;
        }

        .progress-bar-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            height: 20px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .progress-bar {
            height: 100%;
            border-radius: 10px;
            background: linear-gradient(90deg, var(--color-dashboard), #34d399);
            transition: width 0.5s ease;
        }

        .progress-bar.warning {
            background: linear-gradient(90deg, #f59e0b, #fbbf24);
        }

        .progress-bar.complete {
            background: linear-gradient(90deg, #10b981, #34d399);
        }

        .goal-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            text-align: center;
        }

        .goal-stat .label {
            color: var(--color-text-secondary);
            font-size: 0.85rem;
            margin-bottom: 5px;
        }

        .goal-stat .value {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .goal-stat .value.positive { color: var(--color-positive); }

        .goals-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .summary-item {
            background: var(--color-bg-card);
            border: 1px solid var(--color-border);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
        }

        .summary-item .icon { font-size: 2rem; margin-bottom: 5px; }
        .summary-item .value { font-size: 1.5rem; font-weight: bold; color: var(--color-dashboard); }
        .summary-item .label { color: var(--color-text-secondary); font-size: 0.85rem; }

        .add-amount-btn {
            background: var(--color-dashboard);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .empty-goals {
            text-align: center;
            padding: 60px 20px;
            color: var(--color-text-secondary);
        }

        .empty-goals .icon { font-size: 4rem; margin-bottom: 20px; opacity: 0.5; }
    </style>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar Navigation -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="brand">
                    <img src="../img/logo.png" class="brand-icon" alt="FinSight">
                    <span class="brand-name">Fin<span class="brand-highlight">Sight</span></span>
                </div>
            </div>

            <nav>
                <ul class="nav-menu">
                    <li class="nav-item"><a href="../index.html" class="nav-link"><span class="icon">ğŸ </span><span data-i18n="nav.dashboard">×“××©×‘×•×¨×“</span></a></li>
                    <li class="nav-item"><a href="bank.html" class="nav-link"><span class="icon">ğŸ¦</span><span data-i18n="nav.bankAccounts">×—×©×‘×•× ×•×ª ×‘× ×§</span></a></li>
                    <li class="nav-item"><a href="credit.html" class="nav-link"><span class="icon">ğŸ’³</span><span data-i18n="nav.creditCards">×›×¨×˜×™×¡×™ ××©×¨××™</span></a></li>
                    <li class="nav-item"><a href="stocks.html" class="nav-link"><span class="icon">ğŸ“ˆ</span><span data-i18n="nav.stocks">×× ×™×•×ª</span></a></li>
                    <li class="nav-item">
                        <span class="nav-link" style="cursor: default;"><span class="icon">ğŸ“Š</span><span data-i18n="nav.financialProducts">××•×¦×¨×™× ×¤×™× × ×¡×™×™×</span></span>
                        <ul class="nav-submenu">
                            <li class="nav-item"><a href="market-products.html" class="nav-link"><span>ğŸª </span><span data-i18n="nav.marketProducts">××•×¦×¨×™× ×‘×©×•×§</span></a></li>
                            <li class="nav-item"><a href="my-funds.html" class="nav-link"><span>ğŸ’ </span><span data-i18n="nav.myProducts">×”×—×¡×›×•× ×•×ª ×©×œ×™</span></a></li>
                        </ul>
                    </li>
                    <li class="nav-item"><a href="assets.html" class="nav-link"><span class="icon">ğŸ </span><span data-i18n="nav.assets">× ×›×¡×™×</span></a></li>
                    <li class="nav-item"><a href="loans.html" class="nav-link" data-category="loans"><span class="icon">ğŸ¦</span><span data-i18n="nav.loans">×”×œ×•×•××•×ª</span></a></li>
                    <li class="nav-item"><a href="goals.html" class="nav-link active"><span class="icon">ğŸ¯</span><span data-i18n="nav.goals">×™×¢×“×™ ×—×™×¡×›×•×Ÿ</span></a></li>
                    <li class="nav-item"><a href="reports.html" class="nav-link"><span class="icon">ğŸ“‹</span><span data-i18n="nav.reports">×“×•×—×•×ª</span></a></li>
                    <li class="nav-item"><a href="profile.html" class="nav-link"><span class="icon">ğŸ‘¤</span><span data-i18n="nav.profile">×¤×¨×•×¤×™×œ ×¤×™× × ×¡×™</span></a></li>
                    <li class="nav-item"><a href="settings.html" class="nav-link"><span class="icon">âš™ï¸</span><span data-i18n="nav.settings">×”×’×“×¨×•×ª</span></a></li>
                </ul>
            </nav>

            <div class="sidebar-footer">
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="logo-hero">
                <img src="../img/logo.png" alt="FinSight" class="logo-hero-img">
            </div>
            <header class="page-header">
                <h1>ğŸ¯ <span data-i18n="goals.title">×™×¢×“×™ ×—×™×¡×›×•×Ÿ</span></h1>
                <p data-i18n="goals.subtitle">×¢×§×•×‘ ××—×¨ ×”×”×ª×§×“××•×ª ×©×œ×š ×œ×™×¢×“×™× ×¤×™× × ×¡×™×™×</p>
            </header>

            <!-- Summary -->
            <div class="goals-summary" id="goalsSummary">
                <!-- Populated by JS -->
            </div>

            <!-- Add Goal Button -->
            <div style="margin-bottom: 20px;">
                <button class="btn btn-primary" onclick="openGoalModal()">
                    <span>â•</span>
                    <span data-i18n="goals.addGoal">×”×•×¡×£ ×™×¢×“ ×—×“×©</span>
                </button>
            </div>

            <!-- Goals List -->
            <div id="goalsList">
                <!-- Populated by JS -->
            </div>
        </main>

        <button class="mobile-menu-toggle">â˜°</button>
    </div>

    <!-- Add/Edit Goal Modal -->
    <div class="modal-overlay" id="goalModal">
        <div class="modal">
            <div class="modal-header">
                <h2 id="modalTitle" data-i18n="goals.addGoal">×”×•×¡×£ ×™×¢×“ ×—×“×©</h2>
                <button class="modal-close" onclick="closeGoalModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="goalForm">
                    <input type="hidden" id="goalId">

                    <div class="form-group">
                        <label data-i18n="goals.goalIcon">××™×™×§×•×Ÿ</label>
                        <select class="form-control" id="goalIcon">
                            <option value="ğŸ " data-i18n="goals.goalIcons.home">ğŸ  ×‘×™×ª</option>
                            <option value="ğŸš—" data-i18n="goals.goalIcons.car">ğŸš— ×¨×›×‘</option>
                            <option value="âœˆï¸" data-i18n="goals.goalIcons.trip">âœˆï¸ ×˜×™×•×œ</option>
                            <option value="ğŸ’" data-i18n="goals.goalIcons.wedding">ğŸ’ ×—×ª×•× ×”</option>
                            <option value="ğŸ“" data-i18n="goals.goalIcons.education">ğŸ“ ×œ×™××•×“×™×</option>
                            <option value="ğŸ’»" data-i18n="goals.goalIcons.technology">ğŸ’» ×˜×›× ×•×œ×•×’×™×”</option>
                            <option value="ğŸ–ï¸" data-i18n="goals.goalIcons.vacation">ğŸ–ï¸ ×—×•×¤×©×”</option>
                            <option value="ğŸ‘¶" data-i18n="goals.goalIcons.baby">ğŸ‘¶ ×ª×™× ×•×§</option>
                            <option value="ğŸ’°" data-i18n="goals.goalIcons.savings">ğŸ’° ×—×™×¡×›×•×Ÿ</option>
                            <option value="ğŸ¯" data-i18n="goals.goalIcons.goal">ğŸ¯ ×™×¢×“</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label data-i18n="goals.goalName">×©× ×”×™×¢×“</label>
                        <input type="text" class="form-control" id="goalName" required data-i18n-placeholder="goals.goalNamePlaceholder" placeholder="×œ×“×•×’××”: ××§×“××” ×œ×“×™×¨×”">
                    </div>

                    <div class="form-group">
                        <label data-i18n="goals.targetAmount">×¡×›×•× ×™×¢×“</label>
                        <input type="number" class="form-control" id="goalTarget" required min="1" step="100">
                    </div>

                    <div class="form-group">
                        <label data-i18n="goals.currentAmount">×¡×›×•× × ×•×›×—×™ (××•×¤×¦×™×•× ×œ×™)</label>
                        <input type="number" class="form-control" id="goalCurrent" min="0" step="100" value="0">
                    </div>

                    <div class="form-group">
                        <label data-i18n="goals.goalDeadline">×ª××¨×™×š ×™×¢×“ (××•×¤×¦×™×•× ×œ×™)</label>
                        <input type="date" class="form-control" id="goalDeadline">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeGoalModal()" data-i18n="common.cancel">×‘×™×˜×•×œ</button>
                <button class="btn btn-primary" onclick="saveGoal()" data-i18n="common.save">×©××•×¨</button>
            </div>
        </div>
    </div>

    <!-- Add Amount Modal -->
    <div class="modal-overlay" id="addAmountModal">
        <div class="modal">
            <div class="modal-header">
                <h2 data-i18n="goals.addAmountTitle">×”×•×¡×£ ×¡×›×•× ×œ×™×¢×“</h2>
                <button class="modal-close" onclick="closeAddAmountModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addAmountForm">
                    <input type="hidden" id="addAmountGoalId">
                    <div class="form-group">
                        <label data-i18n="goals.amountToAdd">×¡×›×•× ×œ×”×•×¡×¤×”</label>
                        <input type="number" class="form-control" id="amountToAdd" required min="1" step="100">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeAddAmountModal()" data-i18n="common.cancel">×‘×™×˜×•×œ</button>
                <button class="btn btn-primary" onclick="addAmount()" data-i18n="common.add">×”×•×¡×£</button>
            </div>
        </div>
    </div>

    <script src="../js/storage.js"></script>
    <script src="../js/pin-lock.js"></script>
    <script src="../js/i18n.js"></script>
    <script src="../js/goals.js"></script>
    <script src="../js/app.js"></script>
    <script src="../js/firebase-config.js"></script>
    <script src="../js/crypto.js"></script>
    <script src="../js/auth.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            App.currentPage = 'goals';
            I18n.init();
            loadGoals();
        });

        function loadGoals() {
            const goals = Goals.getAll();
            const summary = Goals.getSummary();

            // Render summary
            document.getElementById('goalsSummary').innerHTML = `
                <div class="summary-item">
                    <div class="icon">ğŸ¯</div>
                    <div class="value">${summary.total}</div>
                    <div class="label">${I18n.t('goals.totalGoals')}</div>
                </div>
                <div class="summary-item">
                    <div class="icon">â³</div>
                    <div class="value">${summary.active}</div>
                    <div class="label">${I18n.t('goals.inProgress')}</div>
                </div>
                <div class="summary-item">
                    <div class="icon">âœ…</div>
                    <div class="value">${summary.completed}</div>
                    <div class="label">${I18n.t('goals.completed')}</div>
                </div>
                <div class="summary-item">
                    <div class="icon">ğŸ’°</div>
                    <div class="value">${I18n.formatCurrency(summary.totalCurrent)}</div>
                    <div class="label">${I18n.t('goals.savedSoFar')}</div>
                </div>
            `;

            // Render goals
            const container = document.getElementById('goalsList');

            if (goals.length === 0) {
                container.innerHTML = `
                    <div class="empty-goals">
                        <div class="icon">ğŸ¯</div>
                        <h3>${I18n.t('goals.noGoalsYet')}</h3>
                        <p>${I18n.t('goals.noGoalsDesc')}</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = goals.map(goal => {
                const progress = Goals.getProgress(goal);
                const progressClass = progress.isComplete ? 'complete' : (progress.percentage >= 80 ? 'warning' : '');

                return `
                    <div class="goal-card">
                        <div class="goal-header">
                            <div>
                                <div class="goal-title">
                                    <span class="goal-icon">${goal.icon || 'ğŸ¯'}</span>
                                    <span>${goal.name}</span>
                                    ${progress.isComplete ? `<span class="badge badge-success">${I18n.t('goals.goalComplete')}</span>` : ''}
                                </div>
                                ${goal.deadline ? `<div class="goal-deadline">${I18n.t('goals.deadline')}: ${I18n.formatDate(goal.deadline)}</div>` : ''}
                            </div>
                            <div class="action-buttons">
                                <button class="add-amount-btn" onclick="openAddAmountModal('${goal.id}')">â• ${I18n.t('goals.addBtn')}</button>
                                <button class="btn btn-secondary btn-sm" onclick="editGoal('${goal.id}')">âœï¸</button>
                                <button class="btn btn-danger btn-sm" onclick="deleteGoal('${goal.id}')">ğŸ—‘ï¸</button>
                            </div>
                        </div>

                        <div class="progress-bar-container">
                            <div class="progress-bar ${progressClass}" style="width: ${progress.percentage}%"></div>
                        </div>

                        <div class="goal-stats">
                            <div class="goal-stat">
                                <div class="label">${I18n.t('goals.saved')}</div>
                                <div class="value positive">${I18n.formatCurrency(goal.currentAmount)}</div>
                            </div>
                            <div class="goal-stat">
                                <div class="label">${I18n.t('goals.target')}</div>
                                <div class="value">${I18n.formatCurrency(goal.targetAmount)}</div>
                            </div>
                            <div class="goal-stat">
                                <div class="label">${I18n.t('goals.remaining')}</div>
                                <div class="value">${I18n.formatCurrency(progress.remaining)}</div>
                            </div>
                        </div>

                        ${progress.monthlyNeeded > 0 ? `
                            <div style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px; text-align: center; color: var(--color-text-secondary);">
                                ${I18n.t('goals.monthlyNeeded')} <strong style="color: var(--color-dashboard);">${I18n.formatCurrency(progress.monthlyNeeded)}</strong> ${I18n.t('goals.perMonth')}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function openGoalModal() {
            document.getElementById('modalTitle').textContent = I18n.t('goals.addGoal');
            document.getElementById('goalForm').reset();
            document.getElementById('goalId').value = '';
            document.getElementById('goalCurrent').value = '0';
            document.getElementById('goalModal').classList.add('active');
        }

        function closeGoalModal() {
            document.getElementById('goalModal').classList.remove('active');
        }

        function editGoal(id) {
            const goals = Goals.getAll();
            const goal = goals.find(g => g.id === id);
            if (!goal) return;

            document.getElementById('modalTitle').textContent = I18n.t('goals.editGoal');
            document.getElementById('goalId').value = goal.id;
            document.getElementById('goalIcon').value = goal.icon || 'ğŸ¯';
            document.getElementById('goalName').value = goal.name;
            document.getElementById('goalTarget').value = goal.targetAmount;
            document.getElementById('goalCurrent').value = goal.currentAmount || 0;
            document.getElementById('goalDeadline').value = goal.deadline || '';
            document.getElementById('goalModal').classList.add('active');
        }

        function saveGoal() {
            const id = document.getElementById('goalId').value;
            const icon = document.getElementById('goalIcon').value;
            const name = document.getElementById('goalName').value;
            const targetAmount = parseFloat(document.getElementById('goalTarget').value);
            const currentAmount = parseFloat(document.getElementById('goalCurrent').value) || 0;
            const deadline = document.getElementById('goalDeadline').value || null;

            if (!name || !targetAmount) {
                App.notify(I18n.t('goals.fillAllFields'), 'error');
                return;
            }

            if (id) {
                Goals.update(id, { icon, name, targetAmount, currentAmount, deadline });
            } else {
                Goals.add({ icon, name, targetAmount, currentAmount, deadline });
            }

            closeGoalModal();
            loadGoals();
            App.notify(I18n.t('goals.goalSaved'), 'success');
        }

        function deleteGoal(id) {
            if (confirm(I18n.t('goals.deleteGoalConfirm'))) {
                Goals.delete(id);
                loadGoals();
                App.notify(I18n.t('goals.goalDeleted'), 'success');
            }
        }

        function openAddAmountModal(id) {
            document.getElementById('addAmountGoalId').value = id;
            document.getElementById('amountToAdd').value = '';
            document.getElementById('addAmountModal').classList.add('active');
        }

        function closeAddAmountModal() {
            document.getElementById('addAmountModal').classList.remove('active');
        }

        function addAmount() {
            const id = document.getElementById('addAmountGoalId').value;
            const amount = parseFloat(document.getElementById('amountToAdd').value);

            if (!amount || amount <= 0) {
                App.notify(I18n.t('goals.enterValidAmount'), 'error');
                return;
            }

            Goals.addAmount(id, amount);
            closeAddAmountModal();
            loadGoals();
            App.notify(I18n.t('goals.amountAdded').replace('{amount}', I18n.formatCurrency(amount)), 'success');
        }
    </script>
</body>
</html>
