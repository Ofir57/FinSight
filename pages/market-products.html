<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#00d2ff">
    <link rel="manifest" href="../manifest.json">
    <link rel="icon" type="image/png" href="../img/logo.png">
    <title>××•×¦×¨×™× ×‘×©×•×§ - FinSight</title>
    <link rel="stylesheet" href="../css/app.css">
    <style>
        .nav-link.active { background: #00d2ff !important; color: #1a1a2e !important; }
        .page-header h1 { color: #00d2ff; }

        .product-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .product-tab {
            padding: 10px 20px;
            border: 2px solid var(--color-border);
            border-radius: var(--radius-md);
            background: var(--color-bg-secondary);
            color: var(--color-text-primary);
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            font-size: 0.95rem;
        }

        .product-tab:hover { border-color: #00d2ff; }

        .product-tab.active {
            background: #00d2ff;
            border-color: #00d2ff;
            color: #1a1a2e;
        }

        /* Source toggle */
        .source-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }

        .source-tab {
            padding: 8px 16px;
            border: 1px solid var(--color-border);
            border-radius: 20px;
            background: transparent;
            color: var(--color-text-secondary);
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.85rem;
        }

        .source-tab:hover { border-color: #00d2ff; color: #00d2ff; }

        .source-tab.active {
            background: rgba(0, 210, 255, 0.15);
            border-color: #00d2ff;
            color: #00d2ff;
        }

        .source-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            font-size: 0.85rem;
            color: var(--color-text-secondary);
        }

        .source-info a { color: #00d2ff; text-decoration: none; }

        /* My products */
        .my-products-section {
            background: var(--color-bg-card);
            border: 1px solid rgba(0, 210, 255, 0.3);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-bottom: 25px;
        }

        .my-products-section h3 {
            color: #00d2ff;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .my-product-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: var(--color-bg-secondary);
            border-radius: var(--radius-md);
            margin-bottom: 8px;
            border: 1px solid var(--color-border);
        }

        .my-product-card .name { font-weight: 600; }
        .my-product-card .company { font-size: 0.85rem; color: var(--color-text-secondary); }
        .my-product-card .value { font-weight: 700; color: #00d2ff; font-size: 1.1rem; }

        .my-products-empty { text-align: center; color: var(--color-text-secondary); padding: 20px; }
        .my-products-link { display: inline-block; margin-top: 10px; color: #00d2ff; text-decoration: none; font-size: 0.9rem; }
        .my-products-link:hover { text-decoration: underline; }

        /* Stats row */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: var(--color-bg-card);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 1px solid var(--color-border);
        }

        .stat-card h3 { color: var(--color-text-secondary); font-size: 0.9rem; margin-bottom: 10px; }

        .stat-card .value {
            font-size: 1.8rem;
            font-weight: bold;
            background: linear-gradient(90deg, #00d2ff, #3a7bd5);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Winners / Analysis */
        .analysis-section {
            background: linear-gradient(135deg, rgba(0, 210, 255, 0.1) 0%, rgba(58, 123, 213, 0.1) 100%);
            border: 2px solid #00d2ff;
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
        }

        .analysis-title {
            font-size: 1.4rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #00d2ff;
        }

        .winners-grid { display: flex; flex-direction: column; gap: 15px; }

        .winner-card {
            background: rgba(0, 210, 255, 0.15);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .winner-card.second { background: rgba(192, 192, 192, 0.1); }
        .winner-card.third { background: rgba(205, 127, 50, 0.1); }

        .winner-badge {
            background: linear-gradient(135deg, #ffd700, #ffaa00);
            color: #1a1a2e;
            padding: 8px 16px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .winner-badge.silver { background: linear-gradient(135deg, #c0c0c0, #a8a8a8); }
        .winner-badge.bronze { background: linear-gradient(135deg, #cd7f32, #b87333); }

        .winner-info { flex: 1; min-width: 200px; }
        .winner-name { font-size: 1.3rem; font-weight: bold; color: #fff; margin-bottom: 5px; }
        .winner-company { color: var(--color-text-secondary); font-size: 0.95rem; }

        .winner-stats { display: flex; gap: 15px; flex-wrap: wrap; }

        .winner-stat {
            text-align: center;
            padding: 10px 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }

        .winner-stat-value { font-size: 1.2rem; font-weight: bold; color: #00ff88; }
        .winner-stat-label { font-size: 0.75rem; color: var(--color-text-secondary); margin-top: 3px; }

        .analysis-note {
            margin-top: 15px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            font-size: 0.9rem;
            color: var(--color-text-secondary);
            border-right: 3px solid #00d2ff;
        }

        /* 4 tables grid */
        .tables-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 25px;
        }

        .table-block {
            background: var(--color-bg-card);
            border-radius: 16px;
            padding: 20px;
            overflow-x: auto;
            border: 1px solid var(--color-border);
        }

        .table-block .section-title {
            font-size: 1.2rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .table-block .section-title .icon { font-size: 1.5rem; }
        .table-block .sort-indicator { font-size: 0.9rem; color: #00d2ff; margin-right: auto; }

        .table-block table { width: 100%; border-collapse: collapse; }

        .table-block th, .table-block td {
            padding: 12px 10px;
            text-align: right;
            border-bottom: 1px solid var(--color-border);
        }

        .table-block th {
            background: rgba(0, 210, 255, 0.1);
            color: #00d2ff;
            font-weight: 600;
            font-size: 0.8rem;
        }

        .table-block th.sorted { background: rgba(0, 210, 255, 0.25); }
        .table-block tr:hover { background: rgba(255, 255, 255, 0.05); }

        .rank { width: 40px; text-align: center; }
        .rank-1 { color: #ffd700; font-weight: bold; }
        .rank-2 { color: #c0c0c0; font-weight: bold; }
        .rank-3 { color: #cd7f32; font-weight: bold; }

        .positive { color: #00ff88; }
        .negative { color: #ff4757; }
        .performance { font-weight: 600; font-size: 1.05rem; }

        .fund-name { font-weight: 500; }
        .company-cell { color: var(--color-text-secondary); font-size: 0.85rem; }

        /* Full table with search */
        .full-table-section { margin-bottom: 25px; }

        .search-box {
            width: 100%;
            padding: 10px 15px;
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            color: var(--color-text-primary);
            font-size: 0.95rem;
            margin-bottom: 15px;
        }

        .search-box::placeholder { color: var(--color-text-secondary); }
        .search-box:focus { outline: none; border-color: #00d2ff; }

        .full-table { overflow-x: auto; }

        .full-table table { width: 100%; border-collapse: collapse; }

        .full-table th {
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
            padding: 12px 10px;
            background: rgba(0, 210, 255, 0.1);
            color: #00d2ff;
            font-weight: 600;
            font-size: 0.85rem;
            text-align: right;
            border-bottom: 1px solid var(--color-border);
        }

        .full-table th:hover { color: #fff; }
        .full-table th .sort-arrow { margin-right: 4px; font-size: 0.7rem; }

        .full-table td {
            padding: 12px 10px;
            white-space: nowrap;
            text-align: right;
            border-bottom: 1px solid var(--color-border);
        }

        .full-table tr:hover { background: rgba(255, 255, 255, 0.05); }

        .no-data-msg { text-align: center; color: var(--color-text-secondary); padding: 40px 20px; }

        /* Import button */
        .import-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            background: rgba(16, 185, 129, 0.15);
            border: 1px solid #10b981;
            border-radius: 8px;
            color: #10b981;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.3s;
        }

        .import-btn:hover {
            background: #10b981;
            color: #fff;
        }

        /* Import Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--color-bg-card);
            border-radius: 16px;
            max-width: 850px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--color-border);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 25px;
            border-bottom: 1px solid var(--color-border);
        }

        .modal-header h2 {
            font-size: 1.2rem;
            color: #10b981;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--color-text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
            line-height: 1;
        }

        .modal-close:hover { color: #ff4757; }

        .modal-body { padding: 25px; }

        .import-source-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }

        .import-src-tab {
            padding: 8px 16px;
            border: 1px solid var(--color-border);
            border-radius: 20px;
            background: transparent;
            color: var(--color-text-secondary);
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s;
        }

        .import-src-tab:hover { border-color: #10b981; color: #10b981; }

        .import-src-tab.active {
            background: rgba(16, 185, 129, 0.15);
            border-color: #10b981;
            color: #10b981;
        }

        .import-source-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 18px;
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid #10b981;
            border-radius: 8px;
            color: #10b981;
            text-decoration: none;
            margin-bottom: 15px;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .import-source-link:hover { background: #10b981; color: #fff; }

        .import-instructions {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .import-instructions h4 { margin-bottom: 8px; color: #10b981; font-size: 0.9rem; }

        .import-instructions ol {
            margin: 0;
            padding-right: 20px;
        }

        .import-instructions li {
            margin-bottom: 5px;
            color: var(--color-text-secondary);
            font-size: 0.85rem;
        }

        .import-paste-area {
            width: 100%;
            min-height: 160px;
            padding: 15px;
            background: var(--color-bg-main);
            border: 2px dashed var(--color-border);
            border-radius: 12px;
            color: #fff;
            font-family: monospace;
            font-size: 0.85rem;
            resize: vertical;
            transition: border-color 0.3s;
        }

        .import-paste-area:focus { outline: none; border-color: #10b981; }
        .import-paste-area::placeholder { color: var(--color-text-secondary); }

        .import-preview { margin-top: 15px; }

        .import-preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .import-preview-count {
            background: #10b981;
            color: #fff;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
        }

        .import-preview table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .import-preview th, .import-preview td {
            padding: 8px 10px;
            text-align: right;
            border-bottom: 1px solid var(--color-border);
        }

        .import-preview th {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
            font-size: 0.8rem;
        }

        .import-preview tr:hover { background: rgba(255,255,255,0.05); }

        .import-actions {
            display: flex;
            gap: 12px;
            margin-top: 15px;
        }

        .import-success {
            display: none;
            padding: 12px;
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid #10b981;
            border-radius: 10px;
            color: #10b981;
            margin-top: 12px;
            align-items: center;
            gap: 8px;
        }

        .import-success.active { display: flex; }

        .update-status-bar {
            display: flex;
            gap: 15px;
            align-items: center;
            padding: 12px 16px;
            background: var(--color-bg-card);
            border: 1px solid var(--color-border);
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 0.85rem;
            color: var(--color-text-secondary);
            flex-wrap: wrap;
        }

        .update-status-bar .status-label { font-weight: 500; }
        .update-status-bar .status-ok { color: #10b981; }
        .update-status-bar .status-warn { color: #f59e0b; }
        .update-status-bar .status-old { color: #ff4757; }

        @media (max-width: 1200px) {
            .tables-grid { grid-template-columns: 1fr; }
        }

        @media (max-width: 768px) {
            .table-block th, .table-block td { padding: 8px 6px; font-size: 0.8rem; }
            .stat-card .value { font-size: 1.4rem; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar Navigation -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="brand">
                    <img src="../img/logo.png" class="brand-icon" alt="FinSight">
                    <span class="brand-name">Fin<span class="brand-highlight">Sight</span></span>
                </div>
            </div>

            <nav>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a href="../index.html" class="nav-link" data-category="dashboard">
                            <span class="icon">ğŸ </span>
                            <span data-i18n="nav.dashboard">×“××©×‘×•×¨×“</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="bank.html" class="nav-link" data-category="bank">
                            <span class="icon">ğŸ¦</span>
                            <span data-i18n="nav.bankAccounts">×—×©×‘×•× ×•×ª ×‘× ×§</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="credit.html" class="nav-link" data-category="credit">
                            <span class="icon">ğŸ’³</span>
                            <span data-i18n="nav.creditCards">×›×¨×˜×™×¡×™ ××©×¨××™</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="stocks.html" class="nav-link" data-category="stocks">
                            <span class="icon">ğŸ“ˆ</span>
                            <span data-i18n="nav.stocks">×× ×™×•×ª</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <span class="nav-link" style="cursor: default;">
                            <span class="icon">ğŸ“Š</span>
                            <span data-i18n="nav.financialProducts">××•×¦×¨×™× ×¤×™× × ×¡×™×™×</span>
                        </span>
                        <ul class="nav-submenu">
                            <li class="nav-item">
                                <a href="market-products.html" class="nav-link active" data-category="market-products">
                                    <span>ğŸª </span><span data-i18n="nav.marketProducts">××•×¦×¨×™× ×‘×©×•×§</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="my-funds.html" class="nav-link" data-category="my-products">
                                    <span>ğŸ’ </span><span data-i18n="nav.myProducts">×”××•×¦×¨×™× ×©×œ×™</span>
                                </a>
                            </li>
                        </ul>
                    </li>
                    <li class="nav-item">
                        <a href="assets.html" class="nav-link" data-category="assets">
                            <span class="icon">ğŸ </span>
                            <span data-i18n="nav.assets">× ×›×¡×™×</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="goals.html" class="nav-link">
                            <span class="icon">ğŸ¯</span>
                            <span data-i18n="nav.goals">×™×¢×“×™ ×—×™×¡×›×•×Ÿ</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="reports.html" class="nav-link">
                            <span class="icon">ğŸ“‹</span>
                            <span data-i18n="nav.reports">×“×•×—×•×ª</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="settings.html" class="nav-link">
                            <span class="icon">âš™ï¸</span>
                            <span data-i18n="nav.settings">×”×’×“×¨×•×ª</span>
                        </a>
                    </li>
                </ul>
            </nav>

            <div class="sidebar-footer">
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="logo-hero">
                <img src="../img/logo.png" alt="FinSight" class="logo-hero-img">
            </div>
            <header class="page-header">
                <h1>
                    <span>ğŸª</span>
                    <span data-i18n="marketProducts.title">××•×¦×¨×™× ×‘×©×•×§</span>
                </h1>
            </header>

            <!-- Product Type Tabs -->
            <div class="product-tabs">
                <button class="product-tab active" data-tab="training" onclick="switchTab('training', this)">ğŸ“ <span data-i18n="marketProducts.trainingFund">×§×¨×Ÿ ×”×©×ª×œ××•×ª</span></button>
                <button class="product-tab" data-tab="pension" onclick="switchTab('pension', this)">ğŸ›ï¸ <span data-i18n="marketProducts.pension">×¤× ×¡×™×”</span></button>
                <button class="product-tab" data-tab="gemel" onclick="switchTab('gemel', this)">ğŸ’¼ <span data-i18n="marketProducts.providentFund">×§×•×¤×ª ×’××œ</span></button>
                <button class="product-tab" data-tab="savings" onclick="switchTab('savings', this)">ğŸ· <span data-i18n="marketProducts.savingsPolicy">×¤×•×œ×™×¡×ª ×—×™×¡×›×•×Ÿ</span></button>
            </div>

            <!-- Source Toggle -->
            <div class="source-tabs">
                <button class="source-tab active" onclick="switchSource('themarker', this)">TheMarker / ××œ×˜×©×•×œ×¨</button>
                <button class="source-tab" onclick="switchSource('igemel', this)">iGemel-Net</button>
            </div>

            <div class="source-info">
                <span id="sourceLabel"></span>
                <a id="sourceLink" href="#" target="_blank" data-i18n="marketProducts.toSourceSite">×œ××ª×¨ ×”××§×•×¨</a>
            </div>

            <!-- Import & Status Bar -->
            <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 20px; flex-wrap: wrap;">
                <button class="import-btn" onclick="openImportModal()" style="padding: 12px 24px; font-size: 1rem; font-weight: 600;">
                    ğŸ“¥ <span data-i18n="marketProducts.importData">×™×™×‘×•× × ×ª×•× ×™×</span>
                </button>
                <div class="update-status-bar" id="updateStatusBar" style="margin-bottom: 0; flex: 1;"></div>
            </div>

            <!-- My Products Section -->
            <div class="my-products-section">
                <h3>
                    <span>ğŸ’</span>
                    <span id="myProductsTitle"></span>
                </h3>
                <div id="myProductsList"></div>
                <a href="my-funds.html" class="my-products-link" data-i18n="marketProducts.manageMyProducts">× ×™×”×•×œ ×”××•×¦×¨×™× ×©×œ×™</a> &larr;
            </div>

            <!-- Dynamic content container -->
            <div id="dynamicContent"></div>

            <!-- No data message -->
            <div id="noDataMsg" class="no-data-msg" style="display: none;">
                <p data-i18n="marketProducts.noMarketData">××™×Ÿ × ×ª×•× ×™ ×©×•×§ ×–××™× ×™× ×œ×¡×•×’ ××•×¦×¨ ×–×”</p>
            </div>
        </main>

        <!-- Import Modal -->
        <div class="modal-overlay" id="importModal">
            <div class="modal">
                <div class="modal-header">
                    <h2><span>ğŸ“¥</span> <span data-i18n="marketProducts.importFundType">×™×™×‘×•× × ×ª×•× ×™</span> <span id="importTypeLabel"></span></h2>
                    <button class="modal-close" onclick="closeImportModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="import-source-tabs">
                        <button class="import-src-tab active" onclick="switchImportSource('themarker', this)">TheMarker / ××œ×˜×©×•×œ×¨</button>
                        <button class="import-src-tab" onclick="switchImportSource('igemel', this)">iGemel-Net</button>
                    </div>

                    <a id="importSourceLink" href="#" target="_blank" class="import-source-link">
                        <span>ğŸ”—</span>
                        <span id="importSourceName"></span>
                        <span>â†—</span>
                    </a>

                    <div class="import-instructions">
                        <h4>ğŸ“‹ <span data-i18n="marketProducts.instructions">×”×•×¨××•×ª:</span></h4>
                        <ol>
                            <li data-i18n="marketProducts.instruction1">×œ×—×¥ ×¢×œ ×”×§×™×©×•×¨ ×œ××¢×œ×” ×œ×¤×ª×™×—×ª ××ª×¨ ×”××§×•×¨</li>
                            <li data-i18n="marketProducts.instruction2">×¡××Ÿ ××ª ×›×œ ×”×˜×‘×œ×” (Ctrl+A ×¢×œ ×”×˜×‘×œ×”)</li>
                            <li data-i18n="marketProducts.instruction3">×”×¢×ª×§ (Ctrl+C)</li>
                            <li data-i18n="marketProducts.instruction4">×”×“×‘×§ ×›××Ÿ ×œ××˜×” (Ctrl+V)</li>
                        </ol>
                    </div>

                    <textarea class="import-paste-area" id="importPasteArea"
                        data-i18n-placeholder="marketProducts.pasteHere"
                        placeholder="×”×“×‘×§ ×›××Ÿ ××ª ×”× ×ª×•× ×™× ××”××ª×¨..."
                        oninput="parseImportData()"></textarea>

                    <div class="import-preview" id="importPreview" style="display: none;">
                        <div class="import-preview-header">
                            <h4>ğŸ‘ï¸ <span data-i18n="marketProducts.preview">×ª×¦×•×’×” ××§×“×™××”</span></h4>
                            <span class="import-preview-count" id="importCount"></span>
                        </div>
                        <div style="overflow-x: auto; max-height: 300px;">
                            <table>
                                <thead>
                                    <tr>
                                        <th data-i18n="marketProducts.fundName">×©× ×§×¨×Ÿ</th>
                                        <th data-i18n="marketProducts.company">×—×‘×¨×”</th>
                                        <th data-i18n="marketProducts.month">×—×•×“×©</th>
                                        <th data-i18n="marketProducts.year">×©× ×”</th>
                                        <th data-i18n="marketProducts.threeYears">3 ×©× ×™×</th>
                                        <th data-i18n="marketProducts.fiveYears">5 ×©× ×™×</th>
                                    </tr>
                                </thead>
                                <tbody id="importPreviewBody"></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="import-actions">
                        <button class="btn btn-primary" onclick="saveImportData()" style="background: #10b981;">
                            <span>ğŸ’¾</span>
                            <span data-i18n="marketProducts.saveData">×©××•×¨ × ×ª×•× ×™×</span>
                        </button>
                        <button class="btn btn-secondary" onclick="clearImportData()">
                            <span>ğŸ—‘ï¸</span>
                            <span data-i18n="marketProducts.clear">× ×§×”</span>
                        </button>
                    </div>

                    <div class="import-success" id="importSuccess">
                        <span>âœ…</span>
                        <span data-i18n="marketProducts.dataSaved">×”× ×ª×•× ×™× × ×©××¨×• ×‘×”×¦×œ×—×”!</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="../data/market-funds.js"></script>
    <script src="../data/mygemel-funds.js"></script>
    <script src="../js/storage.js"></script>
    <script src="../js/i18n.js"></script>
    <script src="../js/app.js"></script>
    <script>
        let currentTab = 'training';
        let currentSource = 'themarker';
        let fullSortCol = 'year5';
        let fullSortDir = -1;

        function getTabLabels() {
            return {
                training: I18n.t('marketProducts.trainingFund'),
                pension: I18n.t('marketProducts.pension'),
                gemel: I18n.t('marketProducts.providentFund'),
                savings: I18n.t('marketProducts.savingsPolicy')
            };
        }

        function switchTab(tab, btn) {
            currentTab = tab;
            document.querySelectorAll('.product-tab').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('myProductsTitle').textContent = I18n.t('marketProducts.myProductsPrefix') + getTabLabels()[tab];
            fullSortCol = 'year5';
            fullSortDir = -1;
            renderAll();
        }

        function switchSource(source, btn) {
            currentSource = source;
            document.querySelectorAll('.source-tab').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderAll();
        }

        function getMarketData() {
            if (currentTab === 'savings') return [];
            if (currentSource === 'themarker') return MarketFunds.getData(currentTab) || [];
            return MyGemelFunds.getData(currentTab) || [];
        }

        function renderAll() {
            updateSourceInfo();
            renderMyProducts();
            renderAnalysis();
        }

        function updateSourceInfo() {
            const srcLabel = I18n.t('marketProducts.source');
            const updateLabel = I18n.t('marketProducts.update');
            if (currentSource === 'themarker') {
                document.getElementById('sourceLabel').textContent = srcLabel + ': TheMarker SuperMarker | ' + updateLabel + ': ' + (MarketFunds.getLastUpdate() || '');
                document.getElementById('sourceLink').href = MarketFunds.getSourceUrl(currentTab) || '#';
            } else {
                document.getElementById('sourceLabel').textContent = srcLabel + ': iGemel-Net | ' + updateLabel + ': ' + (MyGemelFunds.getLastUpdate() || '');
                document.getElementById('sourceLink').href = (MyGemelFunds.meta.sourceUrls[currentTab]) || '#';
            }
        }

        // ========= My Products =========
        function renderMyProducts() {
            const container = document.getElementById('myProductsList');
            let funds = [];
            try { funds = JSON.parse(localStorage.getItem('finance_my_funds') || '[]'); } catch (e) { }
            const filtered = funds.filter(f => f.type === currentTab);
            if (filtered.length === 0) {
                container.innerHTML = `<div class="my-products-empty">${I18n.t('marketProducts.noProductsYet')} <a href="my-funds.html" style="color:#00d2ff;">${I18n.t('marketProducts.addViaMyProducts')}</a></div>`;
                return;
            }
            container.innerHTML = filtered.map(f => {
                const val = f.value ? 'â‚ª' + Number(f.value).toLocaleString() : '';
                return `<div class="my-product-card"><div><div class="name">${f.name || ''}</div><div class="company">${f.company || ''}</div></div><div class="value">${val}</div></div>`;
            }).join('');
        }

        // ========= Analysis Rendering =========
        function fmtPct(v, primary) {
            if (v === null || v === undefined) return '<span style="color: var(--color-text-secondary);">-</span>';
            const cls = v >= 0 ? 'positive' : 'negative';
            const bold = primary ? ' performance' : '';
            return `<span class="${cls}${bold}">${v.toFixed(2)}%</span>`;
        }

        function rankClass(r) { return r <= 3 ? 'rank-' + r : ''; }

        function renderAnalysis() {
            const data = getMarketData();
            const container = document.getElementById('dynamicContent');
            const noData = document.getElementById('noDataMsg');

            if (data.length === 0) {
                container.innerHTML = '';
                noData.style.display = 'block';
                if (currentTab === 'savings') {
                    noData.innerHTML = `<p>ğŸ· ${I18n.t('marketProducts.noSavingsData')}<br>${I18n.t('marketProducts.manageViaMyProducts')} <a href="my-funds.html" style="color:#00d2ff;">${I18n.t('marketProducts.myProducts')}</a></p>`;
                } else {
                    noData.innerHTML = `<p>${I18n.t('marketProducts.noDataAvailable')}</p>`;
                }
                return;
            }

            noData.style.display = 'none';

            // Stats
            const maxMonth = Math.max(...data.map(f => f.month || 0));
            const maxYear1 = Math.max(...data.map(f => f.year1 || 0));
            const y5Data = data.filter(f => f.year5 != null);
            const maxYear5 = y5Data.length ? Math.max(...y5Data.map(f => f.year5)) : 0;

            let html = `<div class="stats-row">
                <div class="stat-card"><h3>${I18n.t('marketProducts.totalFunds')}</h3><div class="value">${data.length}</div></div>
                <div class="stat-card"><h3>${I18n.t('marketProducts.topMonthlyReturn')}</h3><div class="value">${maxMonth.toFixed(2)}%</div></div>
                <div class="stat-card"><h3>${I18n.t('marketProducts.topYearlyReturn')}</h3><div class="value">${maxYear1.toFixed(2)}%</div></div>
                <div class="stat-card"><h3>${I18n.t('marketProducts.topFiveYearReturn')}</h3><div class="value">${maxYear5.toFixed(2)}%</div></div>
            </div>`;

            // Winners (top 3 by 5-year)
            const top3 = [...data].filter(f => f.year5 != null).sort((a, b) => b.year5 - a.year5).slice(0, 3);
            const icons = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'];
            const places = [I18n.t('marketProducts.firstPlace'), I18n.t('marketProducts.secondPlace'), I18n.t('marketProducts.thirdPlace')];
            const badges = ['winner-badge', 'winner-badge silver', 'winner-badge bronze'];
            const cards = ['winner-card', 'winner-card second', 'winner-card third'];

            if (top3.length > 0) {
                html += `<div class="analysis-section">
                    <h2 class="analysis-title"><span>ğŸ†</span><span>${I18n.t('marketProducts.topFundsAnalysis')}</span></h2>
                    <div class="winners-grid">`;

                top3.forEach((f, i) => {
                    html += `<div class="${cards[i]}">
                        <div class="${badges[i]}"><span>${icons[i]}</span><span>${places[i]}</span></div>
                        <div class="winner-info">
                            <div class="winner-name">${f.nameHe || f.nameEn}</div>
                            <div class="winner-company">${f.companyHe || f.companyEn}</div>
                        </div>
                        <div class="winner-stats">
                            <div class="winner-stat"><div class="winner-stat-value">${f.year5?.toFixed(2) || '-'}%</div><div class="winner-stat-label">${I18n.t('marketProducts.fiveYears')}</div></div>
                            <div class="winner-stat"><div class="winner-stat-value">${f.year3?.toFixed(2) || '-'}%</div><div class="winner-stat-label">${I18n.t('marketProducts.threeYears')}</div></div>
                            <div class="winner-stat"><div class="winner-stat-value">${f.year1?.toFixed(2) || '-'}%</div><div class="winner-stat-label">${I18n.t('marketProducts.year')}</div></div>
                            <div class="winner-stat"><div class="winner-stat-value">${f.month?.toFixed(2) || '-'}%</div><div class="winner-stat-label">${I18n.t('marketProducts.month')}</div></div>
                        </div>
                    </div>`;
                });

                const srcName = currentSource === 'themarker' ? 'TheMarker' : 'iGemel-Net';
                html += `</div>
                    <div class="analysis-note">${I18n.t('marketProducts.source')}: ${srcName}.</div>
                </div>`;
            }

            // 4 sorted tables (top 5 each)
            const sortConfigs = [
                { key: 'year5', icon: 'ğŸ†', label: I18n.t('marketProducts.sortedBy5Years'), cols: ['year5', 'year3', 'year1', 'month'], headers: [I18n.t('marketProducts.fiveYears') + ' â–¼', I18n.t('marketProducts.threeYears'), I18n.t('marketProducts.year'), I18n.t('marketProducts.month')] },
                { key: 'year3', icon: 'ğŸš€', label: I18n.t('marketProducts.sortedBy3Years'), cols: ['year3', 'year5', 'year1', 'month'], headers: [I18n.t('marketProducts.threeYears') + ' â–¼', I18n.t('marketProducts.fiveYears'), I18n.t('marketProducts.year'), I18n.t('marketProducts.month')] },
                { key: 'year1', icon: 'ğŸ“ˆ', label: I18n.t('marketProducts.sortedByYear'), cols: ['year1', 'year5', 'year3', 'month'], headers: [I18n.t('marketProducts.year') + ' â–¼', I18n.t('marketProducts.fiveYears'), I18n.t('marketProducts.threeYears'), I18n.t('marketProducts.month')] },
                { key: 'month', icon: 'ğŸ“…', label: I18n.t('marketProducts.sortedByMonth'), cols: ['month', 'year5', 'year3', 'year1'], headers: [I18n.t('marketProducts.month') + ' â–¼', I18n.t('marketProducts.fiveYears'), I18n.t('marketProducts.threeYears'), I18n.t('marketProducts.year')] }
            ];

            html += '<div class="tables-grid">';
            sortConfigs.forEach(cfg => {
                const sorted = [...data].filter(f => f[cfg.key] != null).sort((a, b) => b[cfg.key] - a[cfg.key]).slice(0, 5);
                html += `<div class="table-block">
                    <h2 class="section-title"><span class="icon">${cfg.icon}</span><span>${cfg.label}</span><span class="sort-indicator">â–¼</span></h2>
                    <table><thead><tr>
                        <th class="rank">#</th><th>${I18n.t('marketProducts.fundName')}</th><th>${I18n.t('marketProducts.company')}</th>`;
                cfg.headers.forEach((h, i) => {
                    html += `<th${i === 0 ? ' class="sorted"' : ''}>${h}</th>`;
                });
                html += `</tr></thead><tbody>`;
                sorted.forEach((f, idx) => {
                    const r = idx + 1;
                    html += `<tr>
                        <td class="rank ${rankClass(r)}">${r}</td>
                        <td><div class="fund-name">${f.nameHe || f.nameEn}</div></td>
                        <td class="company-cell">${f.companyHe || f.companyEn}</td>`;
                    cfg.cols.forEach((col, i) => { html += `<td>${fmtPct(f[col], i === 0)}</td>`; });
                    html += '</tr>';
                });
                html += '</tbody></table></div>';
            });
            html += '</div>';

            // Full sortable table with search
            html += `<div class="full-table-section card">
                <div class="card-header"><h2 class="card-title"><span class="icon">ğŸ“‹</span><span>${I18n.t('marketProducts.allFundsFullTable')}</span></h2></div>
                <div style="padding: 0 20px;">
                    <input type="text" class="search-box" id="searchBox" placeholder="${I18n.t('marketProducts.searchFund')}" oninput="renderFullTable()">
                </div>
                <div class="full-table" style="padding: 0 20px 20px;">
                    <table>
                        <thead><tr>
                            <th onclick="sortFull('name')"># ${I18n.t('marketProducts.fundName')} <span class="sort-arrow"></span></th>
                            <th onclick="sortFull('company')">${I18n.t('marketProducts.company')} <span class="sort-arrow"></span></th>
                            <th onclick="sortFull('month')">${I18n.t('marketProducts.month')} <span class="sort-arrow"></span></th>
                            <th onclick="sortFull('year1')">${I18n.t('marketProducts.year')} <span class="sort-arrow"></span></th>
                            <th onclick="sortFull('year3')">${I18n.t('marketProducts.threeYears')} <span class="sort-arrow"></span></th>
                            <th onclick="sortFull('year5')">${I18n.t('marketProducts.fiveYears')} <span class="sort-arrow"></span></th>
                            <th onclick="sortFull('fee')">${I18n.t('marketProducts.managementFee')} <span class="sort-arrow"></span></th>
                        </tr></thead>
                        <tbody id="fullTableBody"></tbody>
                    </table>
                </div>
            </div>`;

            container.innerHTML = html;
            renderFullTable();
        }

        // ========= Full Table =========
        function renderFullTable() {
            const data = getMarketData();
            const tbody = document.getElementById('fullTableBody');
            if (!tbody) return;

            const sorted = [...data].sort((a, b) => {
                if (fullSortCol === 'name') return fullSortDir * (a.nameHe || '').localeCompare(b.nameHe || '', 'he');
                if (fullSortCol === 'company') return fullSortDir * (a.companyHe || '').localeCompare(b.companyHe || '', 'he');
                return fullSortDir * ((a[fullSortCol] ?? -Infinity) - (b[fullSortCol] ?? -Infinity));
            });

            const q = (document.getElementById('searchBox')?.value || '').trim().toLowerCase();
            const filtered = q ? sorted.filter(f =>
                (f.nameHe || '').includes(q) || (f.nameEn || '').toLowerCase().includes(q) ||
                (f.companyHe || '').includes(q) || (f.companyEn || '').toLowerCase().includes(q)
            ) : sorted;

            tbody.innerHTML = filtered.map((f, i) => {
                const fee = f.fee != null ? f.fee.toFixed(2) + '%' : '-';
                return `<tr>
                    <td>${i + 1}. ${f.nameHe || f.nameEn || ''}</td>
                    <td class="company-cell">${f.companyHe || f.companyEn || ''}</td>
                    <td>${fmtPct(f.month)}</td>
                    <td>${fmtPct(f.year1)}</td>
                    <td>${fmtPct(f.year3)}</td>
                    <td>${fmtPct(f.year5)}</td>
                    <td>${fee}</td>
                </tr>`;
            }).join('');

            // Sort arrows
            document.querySelectorAll('.full-table th .sort-arrow').forEach(el => el.textContent = '');
            const ths = document.querySelectorAll('.full-table th');
            const colMap = ['name', 'company', 'month', 'year1', 'year3', 'year5', 'fee'];
            colMap.forEach((col, idx) => {
                if (col === fullSortCol) {
                    const arrow = ths[idx]?.querySelector('.sort-arrow');
                    if (arrow) arrow.textContent = fullSortDir === -1 ? ' â–¼' : ' â–²';
                }
            });
        }

        function sortFull(col) {
            if (fullSortCol === col) fullSortDir *= -1;
            else { fullSortCol = col; fullSortDir = -1; }
            renderFullTable();
        }

        // ========= Update Status =========
        function updateStatusBar() {
            const bar = document.getElementById('updateStatusBar');
            const tmUpdate = MarketFunds.getLastUpdate();
            const igUpdate = MyGemelFunds.getLastUpdate();
            const tmNeeds = MarketFunds.needsUpdate();
            const igNeeds = MyGemelFunds.needsUpdate();

            const tmClass = !tmUpdate ? 'status-old' : tmNeeds ? 'status-warn' : 'status-ok';
            const igClass = !igUpdate ? 'status-old' : igNeeds ? 'status-warn' : 'status-ok';

            bar.innerHTML = `
                <span class="status-label">TheMarker:</span>
                <span class="${tmClass}">${tmUpdate || I18n.t('marketProducts.notUpdated')}</span>
                <span style="color: var(--color-border);">|</span>
                <span class="status-label">iGemel-Net:</span>
                <span class="${igClass}">${igUpdate || I18n.t('marketProducts.notUpdated')}</span>
            `;
        }

        // ========= Import Modal =========
        let importSource = 'themarker';
        let importParsedData = [];

        const theMarkerUrls = {
            training: 'https://www.supermarker.themarker.com/Gemel/CompareHishtalmutFunds.aspx',
            pension: 'https://www.supermarker.themarker.com/pension/ComparePensionFunds.aspx',
            gemel: 'https://www.supermarker.themarker.com/Gemel/CompareGemelFunds.aspx'
        };

        const iGemelUrls = {
            training: 'https://www.igemel-net.co.il/%D7%A7%D7%A8%D7%A0%D7%95%D7%AA-%D7%94%D7%A9%D7%AA%D7%9C%D7%9E%D7%95%D7%AA/',
            pension: 'https://www.igemel-net.co.il/%D7%A7%D7%A8%D7%A0%D7%95%D7%AA-%D7%A4%D7%A0%D7%A1%D7%99%D7%94/',
            gemel: 'https://www.igemel-net.co.il/%D7%92%D7%9E%D7%9C-%D7%9C%D7%94%D7%A9%D7%A7%D7%A2%D7%94/'
        };

        function openImportModal() {
            document.getElementById('importTypeLabel').textContent = getTabLabels()[currentTab];
            importSource = 'themarker';
            importParsedData = [];
            document.getElementById('importPasteArea').value = '';
            document.getElementById('importPreview').style.display = 'none';
            document.getElementById('importSuccess').classList.remove('active');

            // Reset source tabs
            document.querySelectorAll('.import-src-tab').forEach(b => b.classList.remove('active'));
            document.querySelector('.import-src-tab').classList.add('active');

            updateImportSourceLink();
            document.getElementById('importModal').classList.add('active');
        }

        function closeImportModal() {
            document.getElementById('importModal').classList.remove('active');
        }

        function switchImportSource(source, btn) {
            importSource = source;
            document.querySelectorAll('.import-src-tab').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            updateImportSourceLink();
            // Clear existing data when switching source
            document.getElementById('importPasteArea').value = '';
            document.getElementById('importPreview').style.display = 'none';
            document.getElementById('importSuccess').classList.remove('active');
            importParsedData = [];
        }

        function updateImportSourceLink() {
            const link = document.getElementById('importSourceLink');
            const nameEl = document.getElementById('importSourceName');

            if (currentTab === 'savings') {
                link.style.display = 'none';
                return;
            }

            link.style.display = 'inline-flex';
            const tabLabels = getTabLabels();
            if (importSource === 'themarker') {
                link.href = theMarkerUrls[currentTab] || '#';
                nameEl.textContent = I18n.t('marketProducts.openTheMarker') + ' - ' + tabLabels[currentTab];
            } else {
                link.href = iGemelUrls[currentTab] || '#';
                nameEl.textContent = I18n.t('marketProducts.openIGemel') + ' - ' + tabLabels[currentTab];
            }
        }

        function parseImportData() {
            const text = document.getElementById('importPasteArea').value;

            if (!text.trim()) {
                document.getElementById('importPreview').style.display = 'none';
                importParsedData = [];
                return;
            }

            const funds = parseTableData(text);
            importParsedData = funds;

            const tbody = document.getElementById('importPreviewBody');
            tbody.innerHTML = funds.map(fund => `
                <tr>
                    <td>${fund.nameHe}</td>
                    <td>${fund.companyHe}</td>
                    <td>${fmtImportPct(fund.month)}</td>
                    <td>${fmtImportPct(fund.year1)}</td>
                    <td>${fmtImportPct(fund.year3)}</td>
                    <td>${fmtImportPct(fund.year5)}</td>
                </tr>
            `).join('');

            document.getElementById('importCount').textContent = I18n.t('marketProducts.fundsCount').replace('{count}', funds.length);
            document.getElementById('importPreview').style.display = 'block';
            document.getElementById('importSuccess').classList.remove('active');
        }

        function fmtImportPct(v) {
            if (v === null || v === undefined) return '-';
            const style = v >= 0 ? 'color: var(--color-positive)' : 'color: var(--color-negative)';
            return `<span style="${style}">${v.toFixed(2)}%</span>`;
        }

        function parseTableData(text) {
            const lines = text.trim().split('\n');
            const funds = [];

            // Skip header lines
            let startIndex = 0;
            for (let i = 0; i < Math.min(3, lines.length); i++) {
                if (lines[i].includes('×©×') || lines[i].includes('×ª×©×•××”') ||
                    lines[i].includes('×—×‘×¨×”') || lines[i].includes('Name')) {
                    startIndex = i + 1;
                }
            }

            for (let i = startIndex; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;

                const parts = line.split(/\t+|\s{2,}/).filter(p => p.trim());

                if (parts.length >= 4) {
                    const fund = {
                        nameHe: parts[0]?.trim() || '',
                        nameEn: parts[0]?.trim() || '',
                        companyHe: extractCompany(parts),
                        companyEn: extractCompany(parts),
                        month: parsePercent(findPercentValue(parts, 0)),
                        year1: parsePercent(findPercentValue(parts, 1)),
                        year3: parsePercent(findPercentValue(parts, 2)),
                        year5: parsePercent(findPercentValue(parts, 3)),
                        fee: null,
                        assets: null
                    };

                    if (fund.nameHe && (fund.month !== null || fund.year1 !== null)) {
                        funds.push(fund);
                    }
                }
            }

            return funds;
        }

        function extractCompany(parts) {
            if (parts.length >= 2) {
                const company = parts[1].trim();
                if (!company.includes('%') && !company.match(/^[\d.-]+$/)) {
                    return company;
                }
            }
            return '';
        }

        function findPercentValue(parts, index) {
            const percentValues = parts.filter(p =>
                p.includes('%') || p.match(/^-?[\d.]+$/)
            );
            return percentValues[index] || null;
        }

        function parsePercent(value) {
            if (!value) return null;
            const num = parseFloat(value.replace('%', '').replace(',', '.').trim());
            return isNaN(num) ? null : num;
        }

        function saveImportData() {
            if (importParsedData.length === 0) {
                alert(I18n.t('marketProducts.noDataToSave'));
                return;
            }

            let success;
            if (importSource === 'themarker') {
                success = MarketFunds.updateData(currentTab, importParsedData);
            } else {
                success = MyGemelFunds.updateData(currentTab, importParsedData);
            }

            if (success) {
                document.getElementById('importSuccess').classList.add('active');
                updateStatusBar();
                // Refresh the analysis view with updated data
                renderAll();
            } else {
                alert(I18n.t('marketProducts.saveError'));
            }
        }

        function clearImportData() {
            document.getElementById('importPasteArea').value = '';
            document.getElementById('importPreview').style.display = 'none';
            document.getElementById('importSuccess').classList.remove('active');
            importParsedData = [];
        }

        // ========= Init =========
        I18n.init();
        document.getElementById('myProductsTitle').textContent = I18n.t('marketProducts.myProductsPrefix') + getTabLabels()[currentTab];
        renderAll();
        updateStatusBar();
    </script>
</body>
</html>
