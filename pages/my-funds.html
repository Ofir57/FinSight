<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#8b5cf6">
    <link rel="manifest" href="../manifest.json">
    <link rel="icon" type="image/png" href="../img/logo.png">
    <title>×”×§×•×¤×•×ª ×©×œ×™ - FinSight</title>
    <link rel="stylesheet" href="../css/app.css">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .nav-link.active { background: var(--color-funds) !important; }
        .page-header h1 { color: var(--color-funds); }
        .btn-primary { background: var(--color-funds); }
        .btn-primary:hover { background: #7c3aed; }

        .fund-type-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .fund-type-tab {
            padding: 10px 20px;
            border: 2px solid var(--color-border);
            border-radius: var(--radius-md);
            background: var(--color-bg-secondary);
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .fund-type-tab:hover {
            border-color: var(--color-funds);
        }

        .fund-type-tab.active {
            background: var(--color-funds);
            border-color: var(--color-funds);
            color: white;
        }

        .fund-type-tab .icon {
            margin-left: 8px;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .summary-card {
            background: var(--color-bg-secondary);
            border-radius: var(--radius-md);
            padding: 20px;
            border: 1px solid var(--color-border);
        }

        .summary-card .label {
            font-size: 0.85rem;
            color: var(--color-text-secondary);
            margin-bottom: 5px;
        }

        .summary-card .value {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .summary-card.pension .value { color: #f59e0b; }
        .summary-card.training .value { color: #10b981; }
        .summary-card.gemel .value { color: #3b82f6; }
        .summary-card.savings .value { color: #ec4899; }
        .summary-card.total .value { color: var(--color-funds); }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar Navigation -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="brand">
                    <img src="../img/logo.png" class="brand-icon" alt="FinSight">
                    <span class="brand-name">Fin<span class="brand-highlight">Sight</span></span>
                </div>
            </div>

            <nav>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a href="../index.html" class="nav-link" data-category="dashboard">
                            <span class="icon">ğŸ </span>
                            <span data-i18n="nav.dashboard">×“××©×‘×•×¨×“</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="bank.html" class="nav-link" data-category="bank">
                            <span class="icon">ğŸ¦</span>
                            <span data-i18n="nav.bankAccounts">×—×©×‘×•× ×•×ª ×‘× ×§</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="credit.html" class="nav-link" data-category="credit">
                            <span class="icon">ğŸ’³</span>
                            <span data-i18n="nav.creditCards">×›×¨×˜×™×¡×™ ××©×¨××™</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="stocks.html" class="nav-link" data-category="stocks">
                            <span class="icon">ğŸ“ˆ</span>
                            <span data-i18n="nav.stocks">×× ×™×•×ª</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="my-funds.html" class="nav-link active" data-category="funds">
                            <span class="icon">ğŸ’</span>
                            <span>×”×§×•×¤×•×ª ×©×œ×™</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="assets.html" class="nav-link" data-category="assets">
                            <span class="icon">ğŸ </span>
                            <span data-i18n="nav.assets">× ×›×¡×™×</span>
                        </a>
                    </li>
                </ul>
            </nav>

            <div class="sidebar-footer">
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="page-header">
                <h1>
                    <span>ğŸ’</span>
                    <span>×”×§×•×¤×•×ª ×©×œ×™</span>
                </h1>
            </header>

            <!-- Summary Cards -->
            <div class="summary-cards">
                <div class="summary-card pension">
                    <div class="label">ğŸ›ï¸ ×¤× ×¡×™×”</div>
                    <div class="value" id="pensionTotal">â‚ª0</div>
                </div>
                <div class="summary-card training">
                    <div class="label">ğŸ“ ×§×¨×Ÿ ×”×©×ª×œ××•×ª</div>
                    <div class="value" id="trainingTotal">â‚ª0</div>
                </div>
                <div class="summary-card gemel">
                    <div class="label">ğŸ’¼ ×§×•×¤×ª ×’××œ</div>
                    <div class="value" id="gemelTotal">â‚ª0</div>
                </div>
                <div class="summary-card savings">
                    <div class="label">ğŸ· ×¤×•×œ×™×¡×ª ×—×™×¡×›×•×Ÿ</div>
                    <div class="value" id="savingsTotal">â‚ª0</div>
                </div>
                <div class="summary-card total">
                    <div class="label">ğŸ’ ×¡×”"×› ×§×¨× ×•×ª</div>
                    <div class="value" id="allFundsTotal">â‚ª0</div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="openAddModal()">
                    <span>â•</span>
                    <span>×”×•×¡×£ ×§×¨×Ÿ</span>
                </button>
                <button class="btn btn-secondary" onclick="importSmartFile()">
                    <span>ğŸ“¥</span>
                    <span>×™×™×‘×•× ×—×›×</span>
                </button>
            </div>

            <!-- Fund Type Tabs -->
            <div class="fund-type-tabs">
                <button class="fund-type-tab active" data-type="all" onclick="filterByType('all')">
                    <span class="icon">ğŸ“Š</span>×”×›×œ
                </button>
                <button class="fund-type-tab" data-type="pension" onclick="filterByType('pension')">
                    <span class="icon">ğŸ›ï¸</span>×¤× ×¡×™×”
                </button>
                <button class="fund-type-tab" data-type="training" onclick="filterByType('training')">
                    <span class="icon">ğŸ“</span>×§×¨×Ÿ ×”×©×ª×œ××•×ª
                </button>
                <button class="fund-type-tab" data-type="gemel" onclick="filterByType('gemel')">
                    <span class="icon">ğŸ’¼</span>×§×•×¤×ª ×’××œ
                </button>
                <button class="fund-type-tab" data-type="savings" onclick="filterByType('savings')">
                    <span class="icon">ğŸ·</span>×¤×•×œ×™×¡×ª ×—×™×¡×›×•×Ÿ
                </button>
            </div>

            <!-- Funds List -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <span class="icon">ğŸ“‹</span>
                        <span>×¨×©×™××ª ×§×¨× ×•×ª</span>
                    </h2>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>×©× ×”×§×¨×Ÿ</th>
                                <th>×¡×•×’</th>
                                <th>×©×•×•×™ × ×•×›×—×™</th>
                                <th>×—×•×“×©</th>
                                <th>×©× ×”</th>
                                <th>3 ×©× ×™×</th>
                                <th>5 ×©× ×™×</th>
                                <th>×¤×¢×•×œ×•×ª</th>
                            </tr>
                        </thead>
                        <tbody id="fundsTable">
                            <!-- Will be populated by JS -->
                        </tbody>
                        <tfoot id="fundsFooter" style="display: none;">
                            <tr style="background: var(--color-bg-secondary); font-weight: bold;">
                                <td colspan="2" style="text-align: right;">×¡×”"×›</td>
                                <td id="totalValueFooter">â‚ª0</td>
                                <td colspan="5"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

            <!-- Distribution Chart -->
            <div class="card" id="chartCard" style="display: none;">
                <div class="card-header">
                    <h2 class="card-title">
                        <span class="icon">ğŸ“Š</span>
                        <span>×”×ª×¤×œ×’×•×ª ×§×¨× ×•×ª</span>
                    </h2>
                </div>
                <div class="chart-container" style="max-width: 400px; margin: 0 auto;">
                    <canvas id="fundsChart"></canvas>
                </div>
            </div>
        </main>

        <!-- Mobile Menu Toggle -->
        <button class="mobile-menu-toggle">â˜°</button>
    </div>

    <!-- Add/Edit Fund Modal -->
    <div class="modal-overlay" id="fundModal">
        <div class="modal">
            <div class="modal-header">
                <h2 id="modalTitle">×”×•×¡×£ ×§×¨×Ÿ</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="fundForm">
                    <input type="hidden" id="fundId">

                    <div class="form-group">
                        <label>×¡×•×’ ×§×¨×Ÿ *</label>
                        <select class="form-control" id="fundType" required>
                            <option value="pension">ğŸ›ï¸ ×¤× ×¡×™×”</option>
                            <option value="training">ğŸ“ ×§×¨×Ÿ ×”×©×ª×œ××•×ª</option>
                            <option value="gemel">ğŸ’¼ ×§×•×¤×ª ×’××œ</option>
                            <option value="savings">ğŸ· ×¤×•×œ×™×¡×ª ×—×™×¡×›×•×Ÿ</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>×©× ×”×§×¨×Ÿ *</label>
                        <input type="text" class="form-control" id="fundName" required placeholder="×œ×“×•×’××”: ××™×˜×‘ ×“×© ×¤× ×¡×™×”">
                    </div>

                    <div class="form-group">
                        <label>×—×‘×¨×” ×× ×”×œ×ª</label>
                        <select class="form-control" id="fundCompany">
                            <option value="">-- ×‘×—×¨ --</option>
                            <option value="meitav">××™×˜×‘ ×“×©</option>
                            <option value="altshuler">××œ×˜×©×•×œ×¨ ×©×—×</option>
                            <option value="harel">×”×¨××œ</option>
                            <option value="migdal">××’×“×œ</option>
                            <option value="menora">×× ×•×¨×” ××‘×˜×—×™×</option>
                            <option value="phoenix">×”×¤× ×™×§×¡</option>
                            <option value="clal">×›×œ×œ</option>
                            <option value="psagot">×¤×¡×’×•×ª</option>
                            <option value="analyst">×× ×œ×™×¡×˜</option>
                            <option value="yelin">×™×œ×™×Ÿ ×œ×¤×™×“×•×ª</option>
                            <option value="more">××•×¨</option>
                            <option value="other">××—×¨</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>×©×•×•×™ × ×•×›×—×™ (â‚ª) *</label>
                        <input type="number" class="form-control" id="fundValue" step="0.01" required>
                    </div>

                    <div class="form-group">
                        <label>×”×¤×§×“×” ×—×•×“×©×™×ª (â‚ª)</label>
                        <input type="number" class="form-control" id="monthlyDeposit" step="0.01" value="0">
                    </div>

                    <div class="form-group">
                        <label>××¡×¤×¨ ×—×©×‘×•×Ÿ/×¤×•×œ×™×¡×”</label>
                        <input type="text" class="form-control" id="accountNumber" maxlength="20">
                    </div>

                    <div class="form-group" id="actuarialGroup" style="display: none;">
                        <label>××™×–×•×Ÿ ××§×˜×•××¨×™ (â‚ª) - ×œ×¤× ×¡×™×” ×‘×œ×‘×“</label>
                        <input type="number" class="form-control" id="actuarialBalance" step="0.01">
                    </div>

                    <div class="form-group">
                        <label>×”×¢×¨×•×ª</label>
                        <textarea class="form-control" id="fundNotes" rows="2"></textarea>
                    </div>
                </form>
                <script>
                    document.getElementById('fundType').addEventListener('change', function() {
                        document.getElementById('actuarialGroup').style.display =
                            this.value === 'pension' ? 'block' : 'none';
                    });
                </script>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">×‘×™×˜×•×œ</button>
                <button class="btn btn-primary" onclick="saveFund()">×©××•×¨</button>
            </div>
        </div>
    </div>

    <!-- Update Value Modal -->
    <div class="modal-overlay" id="updateValueModal">
        <div class="modal">
            <div class="modal-header">
                <h2>×¢×“×›×Ÿ ×©×•×•×™</h2>
                <button class="modal-close" onclick="closeUpdateModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="updateValueForm">
                    <input type="hidden" id="updateFundId">
                    <div class="form-group">
                        <label>×©×•×•×™ ×—×“×© (â‚ª)</label>
                        <input type="number" class="form-control" id="newValue" step="0.01" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeUpdateModal()">×‘×™×˜×•×œ</button>
                <button class="btn btn-primary" onclick="updateValue()">×¢×“×›×Ÿ</button>
            </div>
        </div>
    </div>

    <script src="../js/storage.js"></script>
    <script src="../js/i18n.js"></script>
    <script src="../js/smart-import.js"></script>
    <script src="../js/app.js"></script>
    <script>
        const FUNDS_KEY = 'finance_my_funds';
        let currentFilter = 'all';
        let fundsChart = null;

        const fundTypeNames = {
            pension: 'ğŸ›ï¸ ×¤× ×¡×™×”',
            training: 'ğŸ“ ×§×¨×Ÿ ×”×©×ª×œ××•×ª',
            gemel: 'ğŸ’¼ ×§×•×¤×ª ×’××œ',
            savings: 'ğŸ· ×¤×•×œ×™×¡×ª ×—×™×¡×›×•×Ÿ'
        };

        const companyNames = {
            meitav: '××™×˜×‘ ×“×©',
            altshuler: '××œ×˜×©×•×œ×¨ ×©×—×',
            harel: '×”×¨××œ',
            migdal: '××’×“×œ',
            menora: '×× ×•×¨×” ××‘×˜×—×™×',
            phoenix: '×”×¤× ×™×§×¡',
            clal: '×›×œ×œ',
            psagot: '×¤×¡×’×•×ª',
            analyst: '×× ×œ×™×¡×˜',
            yelin: '×™×œ×™×Ÿ ×œ×¤×™×“×•×ª',
            more: '××•×¨',
            other: '××—×¨'
        };

        document.addEventListener('DOMContentLoaded', () => {
            App.currentPage = 'funds';
            loadFunds();
        });

        function getFunds() {
            const data = localStorage.getItem(FUNDS_KEY);
            return data ? JSON.parse(data) : [];
        }

        function saveFunds(funds) {
            localStorage.setItem(FUNDS_KEY, JSON.stringify(funds));
        }

        function loadFunds() {
            const funds = getFunds();
            const tbody = document.getElementById('fundsTable');
            const footer = document.getElementById('fundsFooter');

            // Update summary cards
            const totals = { pension: 0, training: 0, gemel: 0, savings: 0 };
            funds.forEach(f => {
                if (totals[f.type] !== undefined) {
                    totals[f.type] += f.value || 0;
                }
            });

            document.getElementById('pensionTotal').textContent = I18n.formatCurrency(totals.pension);
            document.getElementById('trainingTotal').textContent = I18n.formatCurrency(totals.training);
            document.getElementById('gemelTotal').textContent = I18n.formatCurrency(totals.gemel);
            document.getElementById('savingsTotal').textContent = I18n.formatCurrency(totals.savings);

            const grandTotal = Object.values(totals).reduce((a, b) => a + b, 0);
            document.getElementById('allFundsTotal').textContent = I18n.formatCurrency(grandTotal);

            // Filter funds
            const filteredFunds = currentFilter === 'all' ? funds : funds.filter(f => f.type === currentFilter);

            if (filteredFunds.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" style="text-align: center; color: var(--color-text-secondary);">××™×Ÿ ×§×¨× ×•×ª ×œ×”×¦×’×”</td></tr>`;
                footer.style.display = 'none';
                document.getElementById('chartCard').style.display = 'none';
                return;
            }

            const totalValue = filteredFunds.reduce((sum, f) => sum + (f.value || 0), 0);
            const totalDeposit = filteredFunds.reduce((sum, f) => sum + (f.monthlyDeposit || 0), 0);

            tbody.innerHTML = filteredFunds.map(fund => {
                const returns = calculateReturns(fund);
                const formatReturn = (val) => {
                    if (val === null) return '<span style="color: var(--color-text-secondary);">-</span>';
                    const num = parseFloat(val);
                    const color = num >= 0 ? '#10b981' : '#ef4444';
                    return `<span style="color: ${color}; font-weight: 600;">${num >= 0 ? '+' : ''}${val}%</span>`;
                };
                const actuarialInfo = fund.type === 'pension' && fund.actuarialBalance
                    ? `<br><small style="color: var(--color-text-secondary);">××™×–×•×Ÿ: ${I18n.formatCurrency(fund.actuarialBalance)}</small>` : '';
                return `
                <tr>
                    <td>
                        <strong>${fund.name}</strong>
                        <br><small style="color: var(--color-text-secondary);">${companyNames[fund.company] || fund.company || ''}</small>
                    </td>
                    <td>${fundTypeNames[fund.type] || fund.type}</td>
                    <td>${I18n.formatCurrency(fund.value)}${actuarialInfo}</td>
                    <td>${formatReturn(returns.month)}</td>
                    <td>${formatReturn(returns.year1)}</td>
                    <td>${formatReturn(returns.year3)}</td>
                    <td>${formatReturn(returns.year5)}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-secondary btn-sm" onclick="openUpdateValueModal('${fund.id}', ${fund.value})" title="×¢×“×›×Ÿ ×©×•×•×™">ğŸ’°</button>
                            <button class="btn btn-secondary btn-sm" onclick="editFund('${fund.id}')" title="×¢×¨×•×š">âœï¸</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteFund('${fund.id}')" title="××—×§">ğŸ—‘ï¸</button>
                        </div>
                    </td>
                </tr>
            `;
            }).join('');

            document.getElementById('totalValueFooter').textContent = I18n.formatCurrency(totalValue);
            footer.style.display = 'table-footer-group';

            // Update chart
            updateChart(totals);
        }

        function updateChart(totals) {
            const chartCard = document.getElementById('chartCard');
            const hasData = Object.values(totals).some(v => v > 0);

            if (!hasData) {
                chartCard.style.display = 'none';
                return;
            }

            chartCard.style.display = 'block';
            const ctx = document.getElementById('fundsChart').getContext('2d');

            if (fundsChart) {
                fundsChart.destroy();
            }

            fundsChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['×¤× ×¡×™×”', '×§×¨×Ÿ ×”×©×ª×œ××•×ª', '×§×•×¤×ª ×’××œ', '×¤×•×œ×™×¡×ª ×—×™×¡×›×•×Ÿ'],
                    datasets: [{
                        data: [totals.pension, totals.training, totals.gemel, totals.savings],
                        backgroundColor: ['#f59e0b', '#10b981', '#3b82f6', '#ec4899'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#fff' }
                        }
                    }
                }
            });
        }

        function filterByType(type) {
            currentFilter = type;
            document.querySelectorAll('.fund-type-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.type === type);
            });
            loadFunds();
        }

        function openAddModal() {
            document.getElementById('modalTitle').textContent = '×”×•×¡×£ ×§×¨×Ÿ';
            document.getElementById('fundForm').reset();
            document.getElementById('fundId').value = '';
            document.getElementById('fundModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('fundModal').classList.remove('active');
        }

        function editFund(id) {
            const funds = getFunds();
            const fund = funds.find(f => f.id === id);
            if (!fund) return;

            document.getElementById('modalTitle').textContent = '×¢×¨×•×š ×§×¨×Ÿ';
            document.getElementById('fundId').value = fund.id;
            document.getElementById('fundType').value = fund.type;
            document.getElementById('fundType').dispatchEvent(new Event('change'));
            document.getElementById('fundName').value = fund.name;
            document.getElementById('fundCompany').value = fund.company || '';
            document.getElementById('fundValue').value = fund.value;
            document.getElementById('monthlyDeposit').value = fund.monthlyDeposit || 0;
            document.getElementById('accountNumber').value = fund.accountNumber || '';
            document.getElementById('actuarialBalance').value = fund.actuarialBalance || '';
            document.getElementById('fundNotes').value = fund.notes || '';
            document.getElementById('fundModal').classList.add('active');
        }

        function saveFund() {
            const id = document.getElementById('fundId').value;
            const type = document.getElementById('fundType').value;
            const name = document.getElementById('fundName').value.trim();
            const company = document.getElementById('fundCompany').value;
            const value = parseFloat(document.getElementById('fundValue').value) || 0;
            const monthlyDeposit = parseFloat(document.getElementById('monthlyDeposit').value) || 0;
            const accountNumber = document.getElementById('accountNumber').value.trim();
            const actuarialBalance = parseFloat(document.getElementById('actuarialBalance').value) || null;
            const notes = document.getElementById('fundNotes').value.trim();

            if (!name || !value) {
                App.notify('×™×© ×œ××œ× ×©× ×§×¨×Ÿ ×•×©×•×•×™', 'error');
                return;
            }

            const funds = getFunds();
            const now = new Date().toISOString();
            const today = now.split('T')[0];

            if (id) {
                // Update existing
                const idx = funds.findIndex(f => f.id === id);
                if (idx !== -1) {
                    const oldFund = funds[idx];
                    // Add to history if value changed
                    let history = oldFund.history || [];
                    if (oldFund.value !== value) {
                        history = [...history, { date: today, value: value }];
                    }
                    funds[idx] = { ...oldFund, type, name, company, value, monthlyDeposit, accountNumber, actuarialBalance, notes, history, updatedAt: now };
                }
            } else {
                // Add new with initial history
                funds.push({
                    id: 'fund_' + Date.now(),
                    type,
                    name,
                    company,
                    value,
                    monthlyDeposit,
                    accountNumber,
                    actuarialBalance,
                    notes,
                    history: [{ date: today, value: value }],
                    createdAt: now,
                    updatedAt: now
                });
            }

            saveFunds(funds);
            closeModal();
            loadFunds();
            App.notify('×”×§×¨×Ÿ × ×©××¨×” ×‘×”×¦×œ×—×”', 'success');
        }

        function openUpdateValueModal(id, currentValue) {
            document.getElementById('updateFundId').value = id;
            document.getElementById('newValue').value = currentValue;
            document.getElementById('updateValueModal').classList.add('active');
        }

        function closeUpdateModal() {
            document.getElementById('updateValueModal').classList.remove('active');
        }

        function updateValue() {
            const id = document.getElementById('updateFundId').value;
            const newValue = parseFloat(document.getElementById('newValue').value);

            if (isNaN(newValue)) {
                App.notify('×™×© ×œ×”×–×™×Ÿ ×©×•×•×™ ×ª×§×™×Ÿ', 'error');
                return;
            }

            const funds = getFunds();
            const idx = funds.findIndex(f => f.id === id);
            if (idx !== -1) {
                const now = new Date().toISOString();
                const today = now.split('T')[0];
                // Add to history
                let history = funds[idx].history || [];
                history = [...history, { date: today, value: newValue }];
                funds[idx].value = newValue;
                funds[idx].history = history;
                funds[idx].updatedAt = now;
                saveFunds(funds);
            }

            closeUpdateModal();
            loadFunds();
            App.notify('×”×©×•×•×™ ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”', 'success');
        }

        // Calculate returns based on history
        function calculateReturns(fund) {
            const history = fund.history || [];
            if (history.length < 2) return { month: null, year1: null, year3: null, year5: null };

            const now = new Date();
            const currentValue = fund.value;

            const getValueAtDate = (targetDate) => {
                const sorted = [...history].sort((a, b) => new Date(a.date) - new Date(b.date));
                let closest = sorted[0];
                for (const h of sorted) {
                    if (new Date(h.date) <= targetDate) {
                        closest = h;
                    }
                }
                return closest?.value;
            };

            const monthAgo = new Date(now);
            monthAgo.setMonth(monthAgo.getMonth() - 1);
            const year1Ago = new Date(now);
            year1Ago.setFullYear(year1Ago.getFullYear() - 1);
            const year3Ago = new Date(now);
            year3Ago.setFullYear(year3Ago.getFullYear() - 3);
            const year5Ago = new Date(now);
            year5Ago.setFullYear(year5Ago.getFullYear() - 5);

            const calcReturn = (oldValue) => {
                if (!oldValue || oldValue === 0) return null;
                return ((currentValue - oldValue) / oldValue * 100).toFixed(2);
            };

            return {
                month: calcReturn(getValueAtDate(monthAgo)),
                year1: calcReturn(getValueAtDate(year1Ago)),
                year3: calcReturn(getValueAtDate(year3Ago)),
                year5: calcReturn(getValueAtDate(year5Ago))
            };
        }

        function deleteFund(id) {
            if (!confirm('×”×× ×œ××—×•×§ ××ª ×”×§×¨×Ÿ?')) return;

            const funds = getFunds().filter(f => f.id !== id);
            saveFunds(funds);
            loadFunds();
            App.notify('×”×§×¨×Ÿ × ××—×§×”', 'success');
        }

        // Smart Import
        const fundColumnMappings = {
            name: ['×©×', '×©× ×§×¨×Ÿ', '×§×¨×Ÿ', '×ª×™××•×¨', 'name', 'fund name', 'description'],
            type: ['×¡×•×’', '×¡×•×’ ×§×¨×Ÿ', 'type', 'fund type', 'tipo'],
            company: ['×—×‘×¨×”', '×—×‘×¨×” ×× ×”×œ×ª', '×× ×”×œ', 'company', 'manager'],
            value: ['×©×•×•×™', '×™×ª×¨×”', '×¡×›×•×', '×¢×¨×š', 'value', 'balance', 'amount', 'total'],
            monthlyDeposit: ['×”×¤×§×“×”', '×”×¤×§×“×” ×—×•×“×©×™×ª', 'deposit', 'monthly']
        };

        async function importSmartFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xlsx,.xls,.csv,.html,.txt';

            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                try {
                    let rows = [];
                    const content = await file.text();

                    if (content.includes('<HTML') || content.includes('<html') || content.includes('<table')) {
                        rows = parseHTMLTable(content);
                    } else if (file.name.endsWith('.xls') || file.name.endsWith('.xlsx')) {
                        const data = await file.arrayBuffer();
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        rows = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                    } else {
                        rows = SmartImport.parseFile(content, file.name);
                    }

                    if (rows.length < 2) {
                        App.notify('×”×§×•×‘×¥ ×¨×™×§ ××• ×œ× ×ª×§×™×Ÿ', 'error');
                        return;
                    }

                    const headerIdx = findHeaderRow(rows);
                    const headers = rows[headerIdx];
                    const detected = detectColumns(headers);

                    if (detected.value === undefined) {
                        showMappingModal(headers, rows, headerIdx);
                        return;
                    }

                    const imported = importFundData(rows, headerIdx, detected);

                    if (imported > 0) {
                        App.notify(`×™×•×‘××• ${imported} ×§×¨× ×•×ª ×‘×”×¦×œ×—×”`, 'success');
                        loadFunds();
                    } else {
                        App.notify('×œ× × ××¦××• ×§×¨× ×•×ª ×œ×™×™×‘×•×', 'error');
                    }
                } catch (error) {
                    console.error('Import error:', error);
                    App.notify('×©×’×™××” ×‘×™×™×‘×•×: ' + error.message, 'error');
                }
            };

            input.click();
        }

        function parseHTMLTable(html) {
            const rows = [];
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            let tables = doc.querySelectorAll('table.dataTable');
            if (tables.length === 0) tables = doc.querySelectorAll('table');

            const seenRows = new Set();
            for (const table of tables) {
                for (const tr of table.querySelectorAll('tr')) {
                    const cells = tr.querySelectorAll('th, td');
                    if (cells.length >= 2 && cells.length <= 15) {
                        const rowData = [];
                        cells.forEach(cell => {
                            rowData.push(cell.textContent.trim().replace(/\s+/g, ' ').replace(/[â€â€\u200e\u200f]/g, ''));
                        });
                        const rowKey = rowData.join('|');
                        if (rowData.some(c => c.length > 0) && !seenRows.has(rowKey)) {
                            seenRows.add(rowKey);
                            rows.push(rowData);
                        }
                    }
                }
            }
            return rows;
        }

        function findHeaderRow(rows) {
            for (let i = 0; i < Math.min(rows.length, 15); i++) {
                const row = rows[i];
                if (!row || row.length < 2) continue;
                const rowText = row.map(c => String(c || '').toLowerCase()).join(' ');
                if (fundColumnMappings.value.some(w => rowText.includes(w.toLowerCase())) ||
                    fundColumnMappings.name.some(w => rowText.includes(w.toLowerCase()))) {
                    return i;
                }
            }
            return 0;
        }

        function detectColumns(headers) {
            const detected = {};
            headers.forEach((header, index) => {
                if (!header) return;
                const headerLower = String(header).toLowerCase().trim();
                Object.keys(fundColumnMappings).forEach(field => {
                    if (detected[field] !== undefined) return;
                    if (fundColumnMappings[field].some(kw => headerLower.includes(kw.toLowerCase()))) {
                        detected[field] = index;
                    }
                });
            });
            return detected;
        }

        function mapFundType(typeText) {
            if (!typeText) return 'savings';
            const t = typeText.toLowerCase();
            if (t.includes('×¤× ×¡×™×”') || t.includes('pension')) return 'pension';
            if (t.includes('×”×©×ª×œ××•×ª') || t.includes('training')) return 'training';
            if (t.includes('×’××œ') || t.includes('gemel') || t.includes('provident')) return 'gemel';
            return 'savings';
        }

        function importFundData(rows, headerIdx, detected) {
            let imported = 0;
            const dataRows = rows.slice(headerIdx + 1);
            const funds = getFunds();
            const now = new Date().toISOString();

            for (const row of dataRows) {
                const firstCell = String(row[0] || '').trim();
                if (!firstCell || firstCell.includes('×¡×”"×›') || firstCell.includes('total')) continue;

                const valueVal = row[detected.value];
                const value = typeof valueVal === 'number' ? valueVal :
                    parseFloat(String(valueVal || '0').replace(/[^\d.-]/g, ''));
                if (isNaN(value) || value === 0) continue;

                const name = detected.name !== undefined ? String(row[detected.name] || '×§×¨×Ÿ ××™×•×‘××ª').trim() : '×§×¨×Ÿ ××™×•×‘××ª';
                const type = detected.type !== undefined ? mapFundType(String(row[detected.type])) : 'savings';
                const company = detected.company !== undefined ? String(row[detected.company] || '') : '';
                const monthlyDeposit = detected.monthlyDeposit !== undefined ?
                    parseFloat(String(row[detected.monthlyDeposit] || '0').replace(/[^\d.-]/g, '')) || 0 : 0;

                funds.push({
                    id: 'fund_' + Date.now() + '_' + imported,
                    type,
                    name,
                    company,
                    value,
                    monthlyDeposit,
                    createdAt: now,
                    updatedAt: now
                });
                imported++;
            }

            if (imported > 0) saveFunds(funds);
            return imported;
        }

        function showMappingModal(headers, rows, headerIdx) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.id = 'mappingModal';
            modal.innerHTML = `
                <div class="modal" style="max-width: 500px;">
                    <div class="modal-header">
                        <h2>×‘×—×¨ ×¢××•×“×•×ª</h2>
                        <button class="modal-close" onclick="document.getElementById('mappingModal').remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <p>×× × ×‘×—×¨ ××ª ×”×¢××•×“×•×ª ×”××ª××™××•×ª:</p>
                        <div class="form-group">
                            <label>×¢××•×“×ª ×©×:</label>
                            <select id="mapName" class="form-control">
                                <option value="-1">-- ×œ× × ×‘×—×¨ --</option>
                                ${headers.map((h, i) => `<option value="${i}">${h || '×¢××•×“×” ' + (i+1)}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>×¢××•×“×ª ×©×•×•×™: *</label>
                            <select id="mapValue" class="form-control" required>
                                <option value="-1">-- ×‘×—×¨ --</option>
                                ${headers.map((h, i) => `<option value="${i}">${h || '×¢××•×“×” ' + (i+1)}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>×¢××•×“×ª ×¡×•×’:</label>
                            <select id="mapType" class="form-control">
                                <option value="-1">-- ×œ× × ×‘×—×¨ --</option>
                                ${headers.map((h, i) => `<option value="${i}">${h || '×¢××•×“×” ' + (i+1)}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="document.getElementById('mappingModal').remove()">×‘×™×˜×•×œ</button>
                        <button class="btn btn-primary" onclick="applyMapping()">×™×™×‘×</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            window._importData = { rows, headerIdx };
        }

        function applyMapping() {
            const valueIdx = parseInt(document.getElementById('mapValue').value);
            if (valueIdx < 0) {
                App.notify('×™×© ×œ×‘×—×•×¨ ×¢××•×“×ª ×©×•×•×™', 'error');
                return;
            }

            const detected = {
                name: parseInt(document.getElementById('mapName').value),
                value: valueIdx,
                type: parseInt(document.getElementById('mapType').value)
            };

            Object.keys(detected).forEach(k => { if (detected[k] < 0) delete detected[k]; });

            const { rows, headerIdx } = window._importData;
            const imported = importFundData(rows, headerIdx, detected);

            document.getElementById('mappingModal').remove();
            delete window._importData;

            if (imported > 0) {
                App.notify(`×™×•×‘××• ${imported} ×§×¨× ×•×ª ×‘×”×¦×œ×—×”`, 'success');
                loadFunds();
            } else {
                App.notify('×œ× × ××¦××• ×§×¨× ×•×ª ×œ×™×™×‘×•×', 'error');
            }
        }
    </script>
</body>
</html>
