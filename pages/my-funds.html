<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="../img/logo.png">
    <meta name="theme-color" content="#8b5cf6">
    <link rel="manifest" href="../manifest.json">
    <link rel="icon" type="image/png" href="../img/logo.png">
    <title>×”×§×•×¤×•×ª ×©×œ×™ - FinSight</title>
    <link rel="stylesheet" href="../css/app.css">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        .nav-link.active { background: #8b5cf6 !important; }
        .page-header h1 { color: #8b5cf6; }
        .btn-primary { background: #8b5cf6; color: #fff; }
        .btn-primary:hover { background: #7c3aed; }

        .fund-type-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .fund-type-tab {
            padding: 10px 20px;
            border: 2px solid var(--color-border);
            border-radius: var(--radius-md);
            background: var(--color-bg-secondary);
            color: var(--color-text-primary);
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .fund-type-tab:hover {
            border-color: var(--color-funds);
        }

        .fund-type-tab.active {
            background: var(--color-funds);
            border-color: var(--color-funds);
            color: white;
        }

        .fund-type-tab .icon {
            margin-left: 8px;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .summary-card {
            background: var(--color-bg-secondary);
            border-radius: var(--radius-md);
            padding: 20px;
            border: 1px solid var(--color-border);
        }

        .summary-card .label {
            font-size: 0.85rem;
            color: var(--color-text-secondary);
            margin-bottom: 5px;
        }

        .summary-card .value {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .track-row {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 8px;
        }
        .track-row input[type="text"] { flex: 2; }
        .track-row input[type="number"] { flex: 1; min-width: 70px; }
        .track-row .btn-remove-track {
            background: #ef4444;
            color: #fff;
            border: none;
            border-radius: var(--radius-sm);
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 1rem;
            line-height: 1;
            flex-shrink: 0;
        }
        .track-row .btn-remove-track:hover { background: #dc2626; }
        .track-total {
            font-size: 0.85rem;
            margin-top: 4px;
            font-weight: 600;
        }
        .track-total.ok { color: #10b981; }
        .track-total.warn { color: #ef4444; }
        .track-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 4px;
        }
        .track-badge {
            font-size: 0.75rem;
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: 12px;
            padding: 1px 8px;
            color: var(--color-text-secondary);
        }

        .summary-card.pension .value { color: #f59e0b; }
        .summary-card.training .value { color: #10b981; }
        .summary-card.gemel .value { color: #3b82f6; }
        .summary-card.savings .value { color: #ec4899; }
        .summary-card.total .value { color: var(--color-funds); }
    </style>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar Navigation -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="brand">
                    <img src="../img/logo.png" class="brand-icon" alt="FinSight">
                    <span class="brand-name">Fin<span class="brand-highlight">Sight</span></span>
                </div>
            </div>

            <nav>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a href="../index.html" class="nav-link" data-category="dashboard">
                            <span class="icon">ğŸ </span>
                            <span data-i18n="nav.dashboard">×“××©×‘×•×¨×“</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="bank.html" class="nav-link" data-category="bank">
                            <span class="icon">ğŸ¦</span>
                            <span data-i18n="nav.bankAccounts">×—×©×‘×•× ×•×ª ×‘× ×§</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="credit.html" class="nav-link" data-category="credit">
                            <span class="icon">ğŸ’³</span>
                            <span data-i18n="nav.creditCards">×›×¨×˜×™×¡×™ ××©×¨××™</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="stocks.html" class="nav-link" data-category="stocks">
                            <span class="icon">ğŸ“ˆ</span>
                            <span data-i18n="nav.stocks">×× ×™×•×ª</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <span class="nav-link" style="cursor: default;">
                            <span class="icon">ğŸ“Š</span>
                            <span data-i18n="nav.financialProducts">××•×¦×¨×™× ×¤×™× × ×¡×™×™×</span>
                        </span>
                        <ul class="nav-submenu">
                            <li class="nav-item"><a href="market-products.html" class="nav-link" data-category="market-products"><span>ğŸª </span><span data-i18n="nav.marketProducts">××•×¦×¨×™× ×‘×©×•×§</span></a></li>
                            <li class="nav-item"><a href="my-funds.html" class="nav-link active" data-category="my-products"><span>ğŸ’ </span><span data-i18n="nav.myProducts">×”××•×¦×¨×™× ×©×œ×™</span></a></li>
                        </ul>
                    </li>
                    <li class="nav-item">
                        <a href="assets.html" class="nav-link" data-category="assets">
                            <span class="icon">ğŸ </span>
                            <span data-i18n="nav.assets">× ×›×¡×™×</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="goals.html" class="nav-link">
                            <span class="icon">ğŸ¯</span>
                            <span data-i18n="nav.goals">×™×¢×“×™ ×—×™×¡×›×•×Ÿ</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="reports.html" class="nav-link">
                            <span class="icon">ğŸ“‹</span>
                            <span data-i18n="nav.reports">×“×•×—×•×ª</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="profile.html" class="nav-link">
                            <span class="icon">ğŸ‘¤</span>
                            <span data-i18n="nav.profile">×¤×¨×•×¤×™×œ ×¤×™× × ×¡×™</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="settings.html" class="nav-link">
                            <span class="icon">âš™ï¸</span>
                            <span data-i18n="nav.settings">×”×’×“×¨×•×ª</span>
                        </a>
                    </li>
                </ul>
            </nav>

            <div class="sidebar-footer">
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="logo-hero">
                <img src="../img/logo.png" alt="FinSight" class="logo-hero-img">
            </div>
            <header class="page-header">
                <h1>
                    <span>ğŸ’</span>
                    <span data-i18n="myFunds.title">×”×§×•×¤×•×ª ×©×œ×™</span>
                </h1>
            </header>

            <!-- Summary Cards -->
            <div class="summary-cards">
                <div class="summary-card pension">
                    <div class="label">ğŸ›ï¸ <span data-i18n="myFunds.pension">×¤× ×¡×™×”</span></div>
                    <div class="value" id="pensionTotal">â‚ª0</div>
                </div>
                <div class="summary-card training">
                    <div class="label">ğŸ“ <span data-i18n="myFunds.trainingFund">×§×¨×Ÿ ×”×©×ª×œ××•×ª</span></div>
                    <div class="value" id="trainingTotal">â‚ª0</div>
                </div>
                <div class="summary-card gemel">
                    <div class="label">ğŸ’¼ <span data-i18n="myFunds.providentFund">×§×•×¤×ª ×’××œ</span></div>
                    <div class="value" id="gemelTotal">â‚ª0</div>
                </div>
                <div class="summary-card savings">
                    <div class="label">ğŸ· <span data-i18n="myFunds.savingsPolicy">×¤×•×œ×™×¡×ª ×—×™×¡×›×•×Ÿ</span></div>
                    <div class="value" id="savingsTotal">â‚ª0</div>
                </div>
                <div class="summary-card total">
                    <div class="label">ğŸ’ <span data-i18n="myFunds.totalFunds">×¡×”"×› ×§×¨× ×•×ª</span></div>
                    <div class="value" id="allFundsTotal">â‚ª0</div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="openAddModal()">
                    <span>â•</span>
                    <span data-i18n="myFunds.addFund">×”×•×¡×£ ×§×¨×Ÿ</span>
                </button>
                <button class="btn btn-secondary" onclick="importSmartFile()">
                    <span>ğŸ“¥</span>
                    <span data-i18n="myFunds.smartImport">×™×™×‘×•× ×—×›×</span>
                </button>
                <button class="btn btn-secondary" onclick="ImageImport.openImagePicker('funds')">
                    <span>ğŸ“·</span>
                    <span data-i18n="myFunds.imageImport">×™×™×‘×•× ××ª××•× ×”</span>
                </button>
                <button class="btn btn-secondary" onclick="ImageImport.openPayslipPicker()">
                    <span>ğŸ“„</span>
                    <span data-i18n="profile.scanPayslip">×¡×¨×•×§ ×ª×œ×•×© ××©×›×•×¨×ª</span>
                </button>
            </div>

            <!-- Fund Type Tabs -->
            <div class="fund-type-tabs">
                <button class="fund-type-tab active" data-type="all" onclick="filterByType('all')">
                    <span class="icon">ğŸ“Š</span><span data-i18n="myFunds.all">×”×›×œ</span>
                </button>
                <button class="fund-type-tab" data-type="pension" onclick="filterByType('pension')">
                    <span class="icon">ğŸ›ï¸</span><span data-i18n="myFunds.pension">×¤× ×¡×™×”</span>
                </button>
                <button class="fund-type-tab" data-type="training" onclick="filterByType('training')">
                    <span class="icon">ğŸ“</span><span data-i18n="myFunds.trainingFund">×§×¨×Ÿ ×”×©×ª×œ××•×ª</span>
                </button>
                <button class="fund-type-tab" data-type="gemel" onclick="filterByType('gemel')">
                    <span class="icon">ğŸ’¼</span><span data-i18n="myFunds.providentFund">×§×•×¤×ª ×’××œ</span>
                </button>
                <button class="fund-type-tab" data-type="savings" onclick="filterByType('savings')">
                    <span class="icon">ğŸ·</span><span data-i18n="myFunds.savingsPolicy">×¤×•×œ×™×¡×ª ×—×™×¡×›×•×Ÿ</span>
                </button>
            </div>

            <!-- Funds List -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <span class="icon">ğŸ“‹</span>
                        <span data-i18n="myFunds.fundList">×¨×©×™××ª ×§×¨× ×•×ª</span>
                    </h2>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th data-i18n="myFunds.fundName">×©× ×”×§×¨×Ÿ</th>
                                <th data-i18n="myFunds.type">×¡×•×’</th>
                                <th data-i18n="myFunds.currentValue">×©×•×•×™ × ×•×›×—×™</th>
                                <th data-i18n="myFunds.monthCol">×—×•×“×©</th>
                                <th data-i18n="myFunds.yearCol">×©× ×”</th>
                                <th data-i18n="myFunds.threeYears">3 ×©× ×™×</th>
                                <th data-i18n="myFunds.fiveYears">5 ×©× ×™×</th>
                                <th data-i18n="myFunds.actions">×¤×¢×•×œ×•×ª</th>
                            </tr>
                        </thead>
                        <tbody id="fundsTable">
                            <!-- Will be populated by JS -->
                        </tbody>
                        <tfoot id="fundsFooter" style="display: none;">
                            <tr style="background: var(--color-bg-secondary); font-weight: bold;">
                                <td colspan="2" style="text-align: right;" data-i18n="myFunds.totalRow">×¡×”"×›</td>
                                <td id="totalValueFooter">â‚ª0</td>
                                <td colspan="5"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

            <!-- Distribution Chart -->
            <div class="card" id="chartCard" style="display: none;">
                <div class="card-header">
                    <h2 class="card-title">
                        <span class="icon">ğŸ“Š</span>
                        <span data-i18n="myFunds.fundsDistribution">×”×ª×¤×œ×’×•×ª ×§×¨× ×•×ª</span>
                    </h2>
                </div>
                <div class="chart-container" style="max-width: 400px; margin: 0 auto;">
                    <canvas id="fundsChart"></canvas>
                </div>
            </div>
        </main>

        <!-- Mobile Menu Toggle -->
        <button class="mobile-menu-toggle">â˜°</button>
    </div>

    <!-- Add/Edit Fund Modal -->
    <div class="modal-overlay" id="fundModal">
        <div class="modal">
            <div class="modal-header">
                <h2 id="modalTitle" data-i18n="myFunds.addFund">×”×•×¡×£ ×§×¨×Ÿ</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="fundForm">
                    <input type="hidden" id="fundId">

                    <div class="form-group">
                        <label data-i18n="myFunds.fundType">×¡×•×’ ×§×¨×Ÿ *</label>
                        <select class="form-control" id="fundType" required>
                            <option value="pension">ğŸ›ï¸ ×¤× ×¡×™×”</option>
                            <option value="training">ğŸ“ ×§×¨×Ÿ ×”×©×ª×œ××•×ª</option>
                            <option value="gemel">ğŸ’¼ ×§×•×¤×ª ×’××œ</option>
                            <option value="savings">ğŸ· ×¤×•×œ×™×¡×ª ×—×™×¡×›×•×Ÿ</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label data-i18n="myFunds.fundNameLabel">×©× ×”×§×¨×Ÿ *</label>
                        <input type="text" class="form-control" id="fundName" required data-i18n-placeholder="myFunds.fundNamePlaceholder" placeholder="×œ×“×•×’××”: ××™×˜×‘ ×“×© ×¤× ×¡×™×”">
                    </div>

                    <div class="form-group">
                        <label data-i18n="myFunds.managingCompany">×—×‘×¨×” ×× ×”×œ×ª</label>
                        <select class="form-control" id="fundCompany">
                            <option value="" data-i18n="myFunds.selectCompany">-- ×‘×—×¨ --</option>
                            <option value="meitav" data-i18n="myFunds.companyMeitav">××™×˜×‘ ×“×©</option>
                            <option value="altshuler" data-i18n="myFunds.companyAltshuler">××œ×˜×©×•×œ×¨ ×©×—×</option>
                            <option value="harel" data-i18n="myFunds.companyHarel">×”×¨××œ</option>
                            <option value="migdal" data-i18n="myFunds.companyMigdal">××’×“×œ</option>
                            <option value="menora" data-i18n="myFunds.companyMenora">×× ×•×¨×” ××‘×˜×—×™×</option>
                            <option value="phoenix" data-i18n="myFunds.companyPhoenix">×”×¤× ×™×§×¡</option>
                            <option value="clal" data-i18n="myFunds.companyClal">×›×œ×œ</option>
                            <option value="psagot" data-i18n="myFunds.companyPsagot">×¤×¡×’×•×ª</option>
                            <option value="analyst" data-i18n="myFunds.companyAnalyst">×× ×œ×™×¡×˜</option>
                            <option value="yelin" data-i18n="myFunds.companyYelin">×™×œ×™×Ÿ ×œ×¤×™×“×•×ª</option>
                            <option value="more" data-i18n="myFunds.companyMore">××•×¨</option>
                            <option value="other" data-i18n="myFunds.companyOther">××—×¨</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label data-i18n="myFunds.currentValueLabel">×©×•×•×™ × ×•×›×—×™ (â‚ª) *</label>
                        <input type="number" class="form-control" id="fundValue" step="0.01" required>
                    </div>

                    <div class="form-group">
                        <label data-i18n="myFunds.monthlyDeposit">×”×¤×§×“×” ×—×•×“×©×™×ª (â‚ª)</label>
                        <input type="number" class="form-control" id="monthlyDeposit" step="0.01" value="0">
                    </div>

                    <div class="form-group">
                        <label data-i18n="myFunds.accountNumber">××¡×¤×¨ ×—×©×‘×•×Ÿ/×¤×•×œ×™×¡×”</label>
                        <input type="text" class="form-control" id="accountNumber" maxlength="20">
                    </div>

                    <div class="form-group" id="actuarialGroup" style="display: none;">
                        <label data-i18n="myFunds.actuarialBalance">××™×–×•×Ÿ ××§×˜×•××¨×™ (â‚ª) - ×œ×¤× ×¡×™×” ×‘×œ×‘×“</label>
                        <input type="number" class="form-control" id="actuarialBalance" step="0.01">
                    </div>

                    <div class="form-group">
                        <label data-i18n="myFunds.notes">×”×¢×¨×•×ª</label>
                        <textarea class="form-control" id="fundNotes" rows="2"></textarea>
                    </div>

                    <div class="form-group">
                        <label data-i18n="myFunds.tracks">××¡×œ×•×œ×™ ×”×©×§×¢×”</label>
                        <div id="tracksContainer"></div>
                        <button type="button" class="btn btn-secondary btn-sm" onclick="addTrackRow()" style="margin-top: 6px;">
                            â• <span data-i18n="myFunds.addTrack">×”×•×¡×£ ××¡×œ×•×œ</span>
                        </button>
                        <div id="trackTotal" class="track-total"></div>
                        <datalist id="trackSuggestions">
                            <option value="×× ×™×•×ª">
                            <option value="××’&quot;×—">
                            <option value="×›×œ×œ×™">
                            <option value="×©×§×œ×™">
                            <option value="××“×“×™">
                            <option value="×—×•&quot;×œ">
                            <option value="×”×œ×›×ª×™">
                            <option value="S&P 500">
                        </datalist>
                    </div>

                    <div class="form-group">
                        <label style="cursor: pointer;" onclick="document.getElementById('returnsSection').style.display = document.getElementById('returnsSection').style.display === 'none' ? 'block' : 'none'">
                            <span>ğŸ“Š</span> <span data-i18n="myFunds.returns">×ª×©×•××•×ª</span> â–¾
                        </label>
                        <div id="returnsSection" style="display: none;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                                <div>
                                    <label style="font-size: 0.8rem;" data-i18n="myFunds.returnMonth">×ª×©×•××” ×—×•×“×©×™×ª (%)</label>
                                    <input type="number" class="form-control" id="fundReturnMonth" step="0.01" placeholder="0.00">
                                </div>
                                <div>
                                    <label style="font-size: 0.8rem;" data-i18n="myFunds.returnYear">×ª×©×•××” ×©× ×ª×™×ª (%)</label>
                                    <input type="number" class="form-control" id="fundReturnYear" step="0.01" placeholder="0.00">
                                </div>
                                <div>
                                    <label style="font-size: 0.8rem;" data-i18n="myFunds.return3y">×ª×©×•××” 3 ×©× ×™× (%)</label>
                                    <input type="number" class="form-control" id="fundReturn3y" step="0.01" placeholder="0.00">
                                </div>
                                <div>
                                    <label style="font-size: 0.8rem;" data-i18n="myFunds.return5y">×ª×©×•××” 5 ×©× ×™× (%)</label>
                                    <input type="number" class="form-control" id="fundReturn5y" step="0.01" placeholder="0.00">
                                </div>
                            </div>
                            <button type="button" class="btn btn-secondary btn-sm" onclick="autoFillReturns()">
                                ğŸ” <span data-i18n="myFunds.fetchFromMarket">×©×œ×•×£ ×× ×ª×•× ×™ ×©×•×§</span>
                            </button>
                        </div>
                    </div>
                </form>
                <script>
                    document.getElementById('fundType').addEventListener('change', function() {
                        document.getElementById('actuarialGroup').style.display =
                            this.value === 'pension' ? 'block' : 'none';
                    });
                </script>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()" data-i18n="common.cancel">×‘×™×˜×•×œ</button>
                <button class="btn btn-primary" onclick="saveFund()" data-i18n="common.save">×©××•×¨</button>
            </div>
        </div>
    </div>

    <!-- Update Value Modal -->
    <div class="modal-overlay" id="updateValueModal">
        <div class="modal">
            <div class="modal-header">
                <h2 data-i18n="myFunds.updateValue">×¢×“×›×Ÿ ×©×•×•×™</h2>
                <button class="modal-close" onclick="closeUpdateModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="updateValueForm">
                    <input type="hidden" id="updateFundId">
                    <div class="form-group">
                        <label data-i18n="myFunds.newValue">×©×•×•×™ ×—×“×© (â‚ª)</label>
                        <input type="number" class="form-control" id="newValue" step="0.01" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeUpdateModal()" data-i18n="common.cancel">×‘×™×˜×•×œ</button>
                <button class="btn btn-primary" onclick="updateValue()" data-i18n="common.update">×¢×“×›×Ÿ</button>
            </div>
        </div>
    </div>

    <script src="../data/market-funds.js"></script>
    <script src="../data/mygemel-funds.js"></script>
    <script src="../js/storage.js"></script>
    <script src="../js/pin-lock.js"></script>
    <script src="../js/i18n.js"></script>
    <script src="../js/smart-import.js"></script>
    <script src="../js/image-import.js"></script>
    <script src="../js/app.js"></script>
    <script src="../js/firebase-config.js"></script>
    <script src="../js/crypto.js"></script>
    <script src="../js/auth.js"></script>
    <script>
        const FUNDS_KEY = 'finance_my_funds';
        let currentFilter = 'all';
        let fundsChart = null;
        let _returnsSource = null;

        function getFundTypeNames() {
            return {
                pension: 'ğŸ›ï¸ ' + I18n.t('myFunds.pension'),
                training: 'ğŸ“ ' + I18n.t('myFunds.trainingFund'),
                gemel: 'ğŸ’¼ ' + I18n.t('myFunds.providentFund'),
                savings: 'ğŸ· ' + I18n.t('myFunds.savingsPolicy')
            };
        }

        function getCompanyNames() {
            return {
                meitav: I18n.t('myFunds.companyMeitav'),
                altshuler: I18n.t('myFunds.companyAltshuler'),
                harel: I18n.t('myFunds.companyHarel'),
                migdal: I18n.t('myFunds.companyMigdal'),
                menora: I18n.t('myFunds.companyMenora'),
                phoenix: I18n.t('myFunds.companyPhoenix'),
                clal: I18n.t('myFunds.companyClal'),
                psagot: I18n.t('myFunds.companyPsagot'),
                analyst: I18n.t('myFunds.companyAnalyst'),
                yelin: I18n.t('myFunds.companyYelin'),
                more: I18n.t('myFunds.companyMore'),
                other: I18n.t('myFunds.companyOther')
            };
        }

        function matchMarketFund(name, company, type) {
            const marketType = type === 'savings' ? null : type;
            if (!marketType) return null;

            const sources = [];
            if (typeof MarketFunds !== 'undefined' && MarketFunds[marketType]) {
                sources.push(...MarketFunds[marketType]);
            }
            if (typeof MyGemelFunds !== 'undefined' && MyGemelFunds[marketType]) {
                sources.push(...MyGemelFunds[marketType]);
            }
            if (sources.length === 0) return null;

            const nameLower = name.toLowerCase().trim();
            const companyNames = getCompanyNames();
            const companyDisplay = companyNames[company] || company || '';

            // Try exact substring match on fund name
            let match = sources.find(f => f.nameHe && nameLower.includes(f.nameHe.toLowerCase()));
            if (!match) match = sources.find(f => f.nameHe && f.nameHe.toLowerCase().includes(nameLower));

            // Try matching by company + partial name
            if (!match && companyDisplay) {
                const companyLower = companyDisplay.toLowerCase();
                const companyMatches = sources.filter(f => f.companyHe && f.companyHe.toLowerCase().includes(companyLower));
                if (companyMatches.length === 1) {
                    match = companyMatches[0];
                } else if (companyMatches.length > 1) {
                    // Try to narrow down by name keywords
                    const nameWords = nameLower.split(/\s+/).filter(w => w.length > 2);
                    match = companyMatches.find(f => {
                        const fName = f.nameHe.toLowerCase();
                        return nameWords.some(w => fName.includes(w));
                    }) || companyMatches[0];
                }
            }

            if (!match) return null;
            return {
                month: match.month,
                year1: match.year1,
                year3: match.year3,
                year5: match.year5,
                matchName: match.nameHe
            };
        }

        function autoFillReturns() {
            const name = document.getElementById('fundName').value.trim();
            const company = document.getElementById('fundCompany').value;
            const type = document.getElementById('fundType').value;

            if (!name) {
                App.notify(I18n.t('myFunds.fillNameAndValue'), 'error');
                return;
            }

            const result = matchMarketFund(name, company, type);
            if (result) {
                document.getElementById('fundReturnMonth').value = result.month ?? '';
                document.getElementById('fundReturnYear').value = result.year1 ?? '';
                document.getElementById('fundReturn3y').value = result.year3 ?? '';
                document.getElementById('fundReturn5y').value = result.year5 ?? '';
                _returnsSource = 'market';
                App.notify(I18n.t('myFunds.marketMatchFound') + ' (' + result.matchName + ')', 'success');
            } else {
                App.notify(I18n.t('myFunds.marketMatchNotFound'), 'error');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            App.currentPage = 'funds';
            I18n.init();
            // Translate fund type select options
            const fundTypeNames = getFundTypeNames();
            document.querySelectorAll('#fundType option').forEach(opt => {
                if (fundTypeNames[opt.value]) opt.textContent = fundTypeNames[opt.value];
            });
            loadFunds();
        });

        function getFunds() {
            const data = localStorage.getItem(FUNDS_KEY);
            return data ? JSON.parse(data) : [];
        }

        function saveFunds(funds) {
            localStorage.setItem(FUNDS_KEY, JSON.stringify(funds));
        }

        function loadFunds() {
            const funds = getFunds();
            const tbody = document.getElementById('fundsTable');
            const footer = document.getElementById('fundsFooter');

            // Update summary cards
            const totals = { pension: 0, training: 0, gemel: 0, savings: 0 };
            funds.forEach(f => {
                if (totals[f.type] !== undefined) {
                    totals[f.type] += f.value || 0;
                }
            });

            document.getElementById('pensionTotal').textContent = I18n.formatCurrency(totals.pension);
            document.getElementById('trainingTotal').textContent = I18n.formatCurrency(totals.training);
            document.getElementById('gemelTotal').textContent = I18n.formatCurrency(totals.gemel);
            document.getElementById('savingsTotal').textContent = I18n.formatCurrency(totals.savings);

            const grandTotal = Object.values(totals).reduce((a, b) => a + b, 0);
            document.getElementById('allFundsTotal').textContent = I18n.formatCurrency(grandTotal);

            // Filter funds
            const filteredFunds = currentFilter === 'all' ? funds : funds.filter(f => f.type === currentFilter);

            if (filteredFunds.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" style="text-align: center; color: var(--color-text-secondary);">${I18n.t('myFunds.noFundsToShow')}</td></tr>`;
                footer.style.display = 'none';
                document.getElementById('chartCard').style.display = 'none';
                return;
            }

            const totalValue = filteredFunds.reduce((sum, f) => sum + (f.value || 0), 0);
            const totalDeposit = filteredFunds.reduce((sum, f) => sum + (f.monthlyDeposit || 0), 0);

            tbody.innerHTML = filteredFunds.map(fund => {
                const returns = fund.returns || calculateReturns(fund);
                const formatReturn = (val) => {
                    if (val === null) return '<span style="color: var(--color-text-secondary);">-</span>';
                    const num = parseFloat(val);
                    const color = num >= 0 ? '#10b981' : '#ef4444';
                    return `<span style="color: ${color}; font-weight: 600;">${num >= 0 ? '+' : ''}${val}%</span>`;
                };
                const fundTypeNames = getFundTypeNames();
                const actuarialInfo = fund.type === 'pension' && fund.actuarialBalance
                    ? `<br><small style="color: var(--color-text-secondary);">${I18n.t('myFunds.balance')}: ${I18n.formatCurrency(fund.actuarialBalance)}</small>` : '';
                const trackBadges = fund.tracks && fund.tracks.length > 0
                    ? `<div class="track-badges">${fund.tracks.map(t => `<span class="track-badge">${t.name} ${t.percentage}%</span>`).join('')}</div>`
                    : '';
                const srcLabel = fund.returns
                    ? (fund.returnsSource === 'market'
                        ? `<span class="track-badge" style="background:#3b82f6; color:#fff; border-color:#3b82f6;">ğŸ“Š ${I18n.t('myFunds.sourceMarket')}</span>`
                        : `<span class="track-badge" style="background:#f59e0b; color:#fff; border-color:#f59e0b;">âœï¸ ${I18n.t('myFunds.sourceManual')}</span>`)
                    : '';
                return `
                <tr>
                    <td>
                        <strong>${fund.name}</strong>
                        <br><small style="color: var(--color-text-secondary);">${getCompanyNames()[fund.company] || fund.company || ''}</small>
                        ${trackBadges}
                        ${srcLabel ? `<div class="track-badges">${srcLabel}</div>` : ''}
                    </td>
                    <td>${fundTypeNames[fund.type] || fund.type}</td>
                    <td>${I18n.formatCurrency(fund.value)}${actuarialInfo}</td>
                    <td>${formatReturn(returns.month)}</td>
                    <td>${formatReturn(returns.year1)}</td>
                    <td>${formatReturn(returns.year3)}</td>
                    <td>${formatReturn(returns.year5)}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-secondary btn-sm" onclick="openUpdateValueModal('${fund.id}', ${fund.value})" title="${I18n.t('myFunds.updateValue')}">ğŸ’°</button>
                            <button class="btn btn-secondary btn-sm" onclick="editFund('${fund.id}')" title="${I18n.t('common.edit')}">âœï¸</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteFund('${fund.id}')" title="${I18n.t('common.delete')}">ğŸ—‘ï¸</button>
                        </div>
                    </td>
                </tr>
            `;
            }).join('');

            document.getElementById('totalValueFooter').textContent = I18n.formatCurrency(totalValue);
            footer.style.display = 'table-footer-group';

            // Update chart
            updateChart(totals);
        }

        function updateChart(totals) {
            const chartCard = document.getElementById('chartCard');
            const hasData = Object.values(totals).some(v => v > 0);

            if (!hasData) {
                chartCard.style.display = 'none';
                return;
            }

            chartCard.style.display = 'block';
            const ctx = document.getElementById('fundsChart').getContext('2d');

            if (fundsChart) {
                fundsChart.destroy();
            }

            fundsChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: [I18n.t('myFunds.pension'), I18n.t('myFunds.trainingFund'), I18n.t('myFunds.providentFund'), I18n.t('myFunds.savingsPolicy')],
                    datasets: [{
                        data: [totals.pension, totals.training, totals.gemel, totals.savings],
                        backgroundColor: ['#f59e0b', '#10b981', '#3b82f6', '#ec4899'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#fff' }
                        }
                    }
                }
            });
        }

        function filterByType(type) {
            currentFilter = type;
            document.querySelectorAll('.fund-type-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.type === type);
            });
            loadFunds();
        }

        function addTrackRow(name, percentage) {
            const container = document.getElementById('tracksContainer');
            const row = document.createElement('div');
            row.className = 'track-row';
            row.innerHTML = `
                <input type="text" class="form-control" list="trackSuggestions" placeholder="${I18n.t('myFunds.trackName')}" value="${name || ''}">
                <input type="number" class="form-control" placeholder="%" min="0" max="100" step="0.1" value="${percentage != null ? percentage : ''}" oninput="updateTrackTotal()">
                <button type="button" class="btn-remove-track" onclick="removeTrackRow(this)">&times;</button>
            `;
            container.appendChild(row);
            updateTrackTotal();
        }

        function removeTrackRow(btn) {
            btn.closest('.track-row').remove();
            updateTrackTotal();
        }

        function getTracksFromForm() {
            const rows = document.querySelectorAll('#tracksContainer .track-row');
            const tracks = [];
            rows.forEach(row => {
                const name = row.querySelector('input[type="text"]').value.trim();
                const pct = parseFloat(row.querySelector('input[type="number"]').value);
                if (name && !isNaN(pct)) {
                    tracks.push({ name, percentage: pct });
                }
            });
            return tracks;
        }

        function updateTrackTotal() {
            const rows = document.querySelectorAll('#tracksContainer .track-row');
            const el = document.getElementById('trackTotal');
            if (rows.length === 0) { el.textContent = ''; return; }
            let sum = 0;
            rows.forEach(row => {
                sum += parseFloat(row.querySelector('input[type="number"]').value) || 0;
            });
            const isOk = Math.abs(sum - 100) < 0.01;
            el.className = 'track-total ' + (isOk ? 'ok' : 'warn');
            el.textContent = I18n.t('myFunds.totalPercentage') + ': ' + sum.toFixed(1) + '%' + (isOk ? '' : ' â€” ' + I18n.t('myFunds.percentageWarning'));
        }

        function openAddModal() {
            document.getElementById('modalTitle').textContent = I18n.t('myFunds.addFund');
            document.getElementById('fundForm').reset();
            document.getElementById('fundId').value = '';
            document.getElementById('tracksContainer').innerHTML = '';
            document.getElementById('trackTotal').textContent = '';
            document.getElementById('fundReturnMonth').value = '';
            document.getElementById('fundReturnYear').value = '';
            document.getElementById('fundReturn3y').value = '';
            document.getElementById('fundReturn5y').value = '';
            document.getElementById('returnsSection').style.display = 'none';
            _returnsSource = null;
            document.getElementById('fundModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('fundModal').classList.remove('active');
        }

        function editFund(id) {
            const funds = getFunds();
            const fund = funds.find(f => f.id === id);
            if (!fund) return;

            document.getElementById('modalTitle').textContent = I18n.t('myFunds.editFund');
            document.getElementById('fundId').value = fund.id;
            document.getElementById('fundType').value = fund.type;
            document.getElementById('fundType').dispatchEvent(new Event('change'));
            document.getElementById('fundName').value = fund.name;
            document.getElementById('fundCompany').value = fund.company || '';
            document.getElementById('fundValue').value = fund.value;
            document.getElementById('monthlyDeposit').value = fund.monthlyDeposit || 0;
            document.getElementById('accountNumber').value = fund.accountNumber || '';
            document.getElementById('actuarialBalance').value = fund.actuarialBalance || '';
            document.getElementById('fundNotes').value = fund.notes || '';
            // Load tracks
            document.getElementById('tracksContainer').innerHTML = '';
            if (fund.tracks && fund.tracks.length > 0) {
                fund.tracks.forEach(t => addTrackRow(t.name, t.percentage));
            }
            updateTrackTotal();
            // Load returns
            const r = fund.returns || {};
            document.getElementById('fundReturnMonth').value = r.month ?? '';
            document.getElementById('fundReturnYear').value = r.year1 ?? '';
            document.getElementById('fundReturn3y').value = r.year3 ?? '';
            document.getElementById('fundReturn5y').value = r.year5 ?? '';
            document.getElementById('returnsSection').style.display = (r.month != null || r.year1 != null || r.year3 != null || r.year5 != null) ? 'block' : 'none';
            _returnsSource = fund.returnsSource || null;
            document.getElementById('fundModal').classList.add('active');
        }

        function saveFund() {
            const id = document.getElementById('fundId').value;
            const type = document.getElementById('fundType').value;
            const name = document.getElementById('fundName').value.trim();
            const company = document.getElementById('fundCompany').value;
            const value = parseFloat(document.getElementById('fundValue').value) || 0;
            const monthlyDeposit = parseFloat(document.getElementById('monthlyDeposit').value) || 0;
            const accountNumber = document.getElementById('accountNumber').value.trim();
            const actuarialBalance = parseFloat(document.getElementById('actuarialBalance').value) || null;
            const notes = document.getElementById('fundNotes').value.trim();
            const tracks = getTracksFromForm();

            // Collect returns
            const rMonth = document.getElementById('fundReturnMonth').value;
            const rYear = document.getElementById('fundReturnYear').value;
            const r3y = document.getElementById('fundReturn3y').value;
            const r5y = document.getElementById('fundReturn5y').value;
            const hasReturns = rMonth !== '' || rYear !== '' || r3y !== '' || r5y !== '';
            const returns = hasReturns ? {
                month: rMonth !== '' ? parseFloat(rMonth) : null,
                year1: rYear !== '' ? parseFloat(rYear) : null,
                year3: r3y !== '' ? parseFloat(r3y) : null,
                year5: r5y !== '' ? parseFloat(r5y) : null
            } : null;
            const returnsSource = hasReturns ? (_returnsSource || 'manual') : null;

            if (!name || !value) {
                App.notify(I18n.t('myFunds.fillNameAndValue'), 'error');
                return;
            }

            const funds = getFunds();
            const now = new Date().toISOString();
            const today = now.split('T')[0];

            if (id) {
                // Update existing
                const idx = funds.findIndex(f => f.id === id);
                if (idx !== -1) {
                    const oldFund = funds[idx];
                    // Add to history if value changed
                    let history = oldFund.history || [];
                    if (oldFund.value !== value) {
                        history = [...history, { date: today, value: value }];
                    }
                    funds[idx] = { ...oldFund, type, name, company, value, monthlyDeposit, accountNumber, actuarialBalance, notes, tracks, returns, returnsSource, history, updatedAt: now };
                }
            } else {
                // Add new with initial history
                funds.push({
                    id: 'fund_' + Date.now(),
                    type,
                    name,
                    company,
                    value,
                    monthlyDeposit,
                    accountNumber,
                    actuarialBalance,
                    notes,
                    tracks,
                    returns,
                    returnsSource,
                    history: [{ date: today, value: value }],
                    createdAt: now,
                    updatedAt: now
                });
            }

            saveFunds(funds);
            closeModal();
            loadFunds();
            App.notify(I18n.t('myFunds.fundSaved'), 'success');
        }

        function openUpdateValueModal(id, currentValue) {
            document.getElementById('updateFundId').value = id;
            document.getElementById('newValue').value = currentValue;
            document.getElementById('updateValueModal').classList.add('active');
        }

        function closeUpdateModal() {
            document.getElementById('updateValueModal').classList.remove('active');
        }

        function updateValue() {
            const id = document.getElementById('updateFundId').value;
            const newValue = parseFloat(document.getElementById('newValue').value);

            if (isNaN(newValue)) {
                App.notify(I18n.t('myFunds.enterValidValue'), 'error');
                return;
            }

            const funds = getFunds();
            const idx = funds.findIndex(f => f.id === id);
            if (idx !== -1) {
                const now = new Date().toISOString();
                const today = now.split('T')[0];
                // Add to history
                let history = funds[idx].history || [];
                history = [...history, { date: today, value: newValue }];
                funds[idx].value = newValue;
                funds[idx].history = history;
                funds[idx].updatedAt = now;
                saveFunds(funds);
            }

            closeUpdateModal();
            loadFunds();
            App.notify(I18n.t('myFunds.valueUpdated'), 'success');
        }

        // Calculate returns based on history
        function calculateReturns(fund) {
            const history = fund.history || [];
            if (history.length < 2) return { month: null, year1: null, year3: null, year5: null };

            const now = new Date();
            const currentValue = fund.value;

            const getValueAtDate = (targetDate) => {
                const sorted = [...history].sort((a, b) => new Date(a.date) - new Date(b.date));
                let closest = null;
                for (const h of sorted) {
                    if (new Date(h.date) <= targetDate) {
                        closest = h;
                    }
                }
                return closest ? closest.value : null;
            };

            const monthAgo = new Date(now);
            monthAgo.setMonth(monthAgo.getMonth() - 1);
            const year1Ago = new Date(now);
            year1Ago.setFullYear(year1Ago.getFullYear() - 1);
            const year3Ago = new Date(now);
            year3Ago.setFullYear(year3Ago.getFullYear() - 3);
            const year5Ago = new Date(now);
            year5Ago.setFullYear(year5Ago.getFullYear() - 5);

            const calcReturn = (oldValue) => {
                if (!oldValue || oldValue === 0) return null;
                return ((currentValue - oldValue) / oldValue * 100).toFixed(2);
            };

            return {
                month: calcReturn(getValueAtDate(monthAgo)),
                year1: calcReturn(getValueAtDate(year1Ago)),
                year3: calcReturn(getValueAtDate(year3Ago)),
                year5: calcReturn(getValueAtDate(year5Ago))
            };
        }

        function deleteFund(id) {
            if (!confirm(I18n.t('myFunds.deleteFundConfirm'))) return;

            const funds = getFunds().filter(f => f.id !== id);
            saveFunds(funds);
            loadFunds();
            App.notify(I18n.t('myFunds.fundDeleted'), 'success');
        }

        // Smart Import
        const fundColumnMappings = {
            name: ['×©×', '×©× ×§×¨×Ÿ', '×§×¨×Ÿ', '×ª×™××•×¨', 'name', 'fund name', 'description'],
            type: ['×¡×•×’', '×¡×•×’ ×§×¨×Ÿ', 'type', 'fund type', 'tipo'],
            company: ['×—×‘×¨×”', '×—×‘×¨×” ×× ×”×œ×ª', '×× ×”×œ', 'company', 'manager'],
            value: ['×©×•×•×™', '×™×ª×¨×”', '×¡×›×•×', '×¢×¨×š', 'value', 'balance', 'amount', 'total'],
            monthlyDeposit: ['×”×¤×§×“×”', '×”×¤×§×“×” ×—×•×“×©×™×ª', 'deposit', 'monthly']
        };

        async function importSmartFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xlsx,.xls,.csv,.html,.txt';

            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                try {
                    let rows = [];
                    const content = await file.text();

                    if (content.includes('<HTML') || content.includes('<html') || content.includes('<table')) {
                        rows = parseHTMLTable(content);
                    } else if (file.name.endsWith('.xls') || file.name.endsWith('.xlsx')) {
                        const data = await file.arrayBuffer();
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        rows = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                    } else {
                        rows = SmartImport.parseFile(content, file.name);
                    }

                    if (rows.length < 2) {
                        App.notify(I18n.t('myFunds.fileEmptyOrInvalid'), 'error');
                        return;
                    }

                    const headerIdx = findHeaderRow(rows);
                    const headers = rows[headerIdx];
                    const detected = detectColumns(headers);

                    if (detected.value === undefined) {
                        showMappingModal(headers, rows, headerIdx);
                        return;
                    }

                    const imported = importFundData(rows, headerIdx, detected);

                    if (imported > 0) {
                        App.notify(I18n.t('myFunds.importedFunds').replace('{count}', imported), 'success');
                        loadFunds();
                    } else {
                        App.notify(I18n.t('myFunds.noFundsToImport'), 'error');
                    }
                } catch (error) {
                    console.error('Import error:', error);
                    App.notify(I18n.t('myFunds.importError') + ': ' + error.message, 'error');
                }
            };

            input.click();
        }

        function parseHTMLTable(html) {
            const rows = [];
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            let tables = doc.querySelectorAll('table.dataTable');
            if (tables.length === 0) tables = doc.querySelectorAll('table');

            const seenRows = new Set();
            for (const table of tables) {
                for (const tr of table.querySelectorAll('tr')) {
                    const cells = tr.querySelectorAll('th, td');
                    if (cells.length >= 2 && cells.length <= 15) {
                        const rowData = [];
                        cells.forEach(cell => {
                            rowData.push(cell.textContent.trim().replace(/\s+/g, ' ').replace(/[â€â€\u200e\u200f]/g, ''));
                        });
                        const rowKey = rowData.join('|');
                        if (rowData.some(c => c.length > 0) && !seenRows.has(rowKey)) {
                            seenRows.add(rowKey);
                            rows.push(rowData);
                        }
                    }
                }
            }
            return rows;
        }

        function findHeaderRow(rows) {
            for (let i = 0; i < Math.min(rows.length, 15); i++) {
                const row = rows[i];
                if (!row || row.length < 2) continue;
                const rowText = row.map(c => String(c || '').toLowerCase()).join(' ');
                if (fundColumnMappings.value.some(w => rowText.includes(w.toLowerCase())) ||
                    fundColumnMappings.name.some(w => rowText.includes(w.toLowerCase()))) {
                    return i;
                }
            }
            return 0;
        }

        function detectColumns(headers) {
            const detected = {};
            headers.forEach((header, index) => {
                if (!header) return;
                const headerLower = String(header).toLowerCase().trim();
                Object.keys(fundColumnMappings).forEach(field => {
                    if (detected[field] !== undefined) return;
                    if (fundColumnMappings[field].some(kw => headerLower.includes(kw.toLowerCase()))) {
                        detected[field] = index;
                    }
                });
            });
            return detected;
        }

        function mapFundType(typeText) {
            if (!typeText) return 'savings';
            const t = typeText.toLowerCase();
            if (t.includes('×¤× ×¡×™×”') || t.includes('pension')) return 'pension';
            if (t.includes('×”×©×ª×œ××•×ª') || t.includes('training')) return 'training';
            if (t.includes('×’××œ') || t.includes('gemel') || t.includes('provident')) return 'gemel';
            return 'savings';
        }

        function importFundData(rows, headerIdx, detected) {
            let imported = 0;
            const dataRows = rows.slice(headerIdx + 1);
            const funds = getFunds();
            const now = new Date().toISOString();

            for (const row of dataRows) {
                const firstCell = String(row[0] || '').trim();
                if (!firstCell || firstCell.includes('×¡×”"×›') || firstCell.includes('total')) continue;

                const valueVal = row[detected.value];
                const value = typeof valueVal === 'number' ? valueVal :
                    parseFloat(String(valueVal || '0').replace(/[^\d.-]/g, ''));
                if (isNaN(value) || value === 0) continue;

                const name = detected.name !== undefined ? String(row[detected.name] || I18n.t('myFunds.importedFund')).trim() : I18n.t('myFunds.importedFund');
                const type = detected.type !== undefined ? mapFundType(String(row[detected.type])) : 'savings';
                const company = detected.company !== undefined ? String(row[detected.company] || '') : '';
                const monthlyDeposit = detected.monthlyDeposit !== undefined ?
                    parseFloat(String(row[detected.monthlyDeposit] || '0').replace(/[^\d.-]/g, '')) || 0 : 0;

                funds.push({
                    id: 'fund_' + Date.now() + '_' + imported,
                    type,
                    name,
                    company,
                    value,
                    monthlyDeposit,
                    createdAt: now,
                    updatedAt: now
                });
                imported++;
            }

            if (imported > 0) saveFunds(funds);
            return imported;
        }

        function showMappingModal(headers, rows, headerIdx) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.id = 'mappingModal';
            modal.innerHTML = `
                <div class="modal" style="max-width: 500px;">
                    <div class="modal-header">
                        <h2>${I18n.t('myFunds.selectColumns')}</h2>
                        <button class="modal-close" onclick="document.getElementById('mappingModal').remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <p>${I18n.t('myFunds.selectColumnsDesc')}</p>
                        <div class="form-group">
                            <label>${I18n.t('myFunds.nameColumn')}</label>
                            <select id="mapName" class="form-control">
                                <option value="-1">${I18n.t('myFunds.notSelected')}</option>
                                ${headers.map((h, i) => `<option value="${i}">${h || I18n.t('myFunds.column') + ' ' + (i+1)}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>${I18n.t('myFunds.valueColumn')}</label>
                            <select id="mapValue" class="form-control" required>
                                <option value="-1">${I18n.t('myFunds.selectOption')}</option>
                                ${headers.map((h, i) => `<option value="${i}">${h || I18n.t('myFunds.column') + ' ' + (i+1)}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>${I18n.t('myFunds.typeColumn')}</label>
                            <select id="mapType" class="form-control">
                                <option value="-1">${I18n.t('myFunds.notSelected')}</option>
                                ${headers.map((h, i) => `<option value="${i}">${h || I18n.t('myFunds.column') + ' ' + (i+1)}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="document.getElementById('mappingModal').remove()">${I18n.t('common.cancel')}</button>
                        <button class="btn btn-primary" onclick="applyMapping()">${I18n.t('myFunds.importBtn')}</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            window._importData = { rows, headerIdx };
        }

        function applyMapping() {
            const valueIdx = parseInt(document.getElementById('mapValue').value);
            if (valueIdx < 0) {
                App.notify(I18n.t('myFunds.selectValueColumn'), 'error');
                return;
            }

            const detected = {
                name: parseInt(document.getElementById('mapName').value),
                value: valueIdx,
                type: parseInt(document.getElementById('mapType').value)
            };

            Object.keys(detected).forEach(k => { if (detected[k] < 0) delete detected[k]; });

            const { rows, headerIdx } = window._importData;
            const imported = importFundData(rows, headerIdx, detected);

            document.getElementById('mappingModal').remove();
            delete window._importData;

            if (imported > 0) {
                App.notify(I18n.t('myFunds.importedFunds').replace('{count}', imported), 'success');
                loadFunds();
            } else {
                App.notify(I18n.t('myFunds.noFundsToImport'), 'error');
            }
        }
    </script>
</body>
</html>
